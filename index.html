<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o Happy Zone V10.3 - Est√°vel</title>
    
    <!-- React Core -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Database SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        sidebar: '#0f172a', 
                        primary: '#0056b3', 
                        secondary: '#3b82f6', 
                        success: '#10b981', 
                        warning: '#f59e0b', 
                        danger: '#ef4444' 
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'shake': 'shake 0.4s cubic-bezier(.36,.07,.19,.97) both',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        .glass-panel { background: white; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; }
        .fade-in { animation: 'slide-in' 0.4s ease-out; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .schedule-container { display: grid; grid-template-columns: 80px repeat(7, 1fr); overflow: auto; position: relative; background: #fff; min-width: 800px; }
        .schedule-header-cell { position: sticky; top: 0; z-index: 20; background: #f8fafc; border-bottom: 2px solid #e2e8f0; border-right: 1px solid #f1f5f9; padding: 8px; text-align: center; font-weight: 800; font-size: 0.75rem; text-transform: uppercase; color: #475569; }
        .schedule-time-cell { position: sticky; left: 0; z-index: 10; background: #fff; border-bottom: 1px dashed #e2e8f0; border-right: 2px solid #e2e8f0; padding: 12px 8px; text-align: right; font-size: 0.7rem; color: #64748b; font-weight: 700; }
        .schedule-cell { border-bottom: 1px dashed #f1f5f9; border-right: 1px solid #f1f5f9; background: #fff; padding: 4px; min-height: 60px; }
        .schedule-cell.holiday-bg { background: repeating-linear-gradient(45deg, #fef2f2, #fef2f2 10px, #fff 10px, #fff 20px); }
        .input-error { border-color: #ef4444 !important; box-shadow: 0 0 0 1px #ef4444; animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }

        /* Dark Mode overrides */
        .dark body { background-color: #0f172a; color: #f1f5f9; }
        .dark .glass-panel { background: #1e293b; border-color: #334155; color: #f1f5f9; }
        .dark .schedule-container { background-color: #1e293b; }
        .dark .schedule-header-cell { background-color: #0f172a; border-color: #334155; color: #cbd5e1; }
        .dark .schedule-time-cell { background-color: #1e293b; border-color: #334155; color: #94a3b8; }
        .dark .schedule-cell { background-color: #1e293b; border-color: #334155; }
        .dark .schedule-cell:hover { background-color: #334155; }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback, createContext, useContext } = React;

        // ==========================================
        // 0. CONFIGURA√á√ÉO DO DATASOURCE
        // ==========================================
        
        /**
         * IMPORTANTE: Configure aqui qual fonte de dados usar
         * 
         * OPTIONS:
         * - 'localStorage': Armazena dados localmente no navegador (padr√£o, sem necessidade de configura√ß√£o)
         * - 'supabase': Usa banco de dados PostgreSQL na nuvem (requer configura√ß√£o abaixo)
         * 
         * Para usar Supabase:
         * 1. Altere DATA_SOURCE para 'supabase'
         * 2. Configure SUPABASE_URL e SUPABASE_KEY abaixo com suas credenciais
         * 3. Execute o script SQL fornecido no seu projeto Supabase
         */
        const DATA_SOURCE = 'localStorage'; // Altere para 'supabase' quando configurado
        
        // Configura√ß√£o do Supabase (necess√°rio apenas se DATA_SOURCE = 'supabase')
        const SUPABASE_CONFIG = {
            url: 'https://seu-projeto.supabase.co', // Substitua pela URL do seu projeto
            key: 'sua-chave-publica-anon', // Substitua pela chave p√∫blica (anon key)
        };

        // ==========================================
        // 1. CONSTANTES E DADOS INICIAIS
        // ==========================================

        const STATUS_COLORS = Object.freeze({
            success: Object.freeze({ bg: 'bg-green-500', text: 'text-green-700', light: 'bg-green-100', border: 'border-green-200' }),
            warning: Object.freeze({ bg: 'bg-yellow-500', text: 'text-yellow-700', light: 'bg-yellow-100', border: 'border-yellow-200' }),
            danger:  Object.freeze({ bg: 'bg-red-500',   text: 'text-red-700',   light: 'bg-red-100',   border: 'border-red-200' }),
            primary: Object.freeze({ bg: 'bg-blue-600',  text: 'text-blue-700',  light: 'bg-blue-50',   border: 'border-blue-200' })
        });

        const LOCATIONS = Object.freeze({
            "Brasil": Object.freeze(["MG", "SP", "RJ", "ES", "RS", "BA", "SC"]),
            "Argentina": Object.freeze(["Buenos Aires", "C√≥rdoba", "Santa F√©", "Mendoza"]),
            "Estados Unidos": Object.freeze(["California", "Florida", "New York", "Texas"])
        });

        const INITIAL_DB = {
    mentores: [
        { id: 1, nome: "Felipe Souza", senha: "1234" },
        { id: 2, nome: "Carlos", senha: "1234" },
        { id: 3, nome: "Igor", senha: "1234" },
        { id: 4, nome: "Lukas", senha: "1234" },
        { id: 5, nome: "Rafael P", senha: "1234" },
        { id: 6, nome: "Alex", senha: "1234" },
        { id: 7, nome: "Anderson (Tio Anderson)", senha: "1234" },
        { id: 8, nome: "Ricardo", senha: "1234" },
        { id: 9, nome: "Pamela", senha: "1234" },
        { id: 10, nome: "Vicente", senha: "1234" },
        { id: 11, nome: "Gustavo", senha: "1234" },
        { id: 12, nome: "Edgar", senha: "1234" },
        { id: 13, nome: "Victor", senha: "1234" },
        { id: 14, nome: "Wanda", senha: "1234" },
        { id: 15, nome: "Marcel", senha: "1234" },
        { id: 16, nome: "Anderson Henrique", senha: "1234" },
        { id: 17, nome: "Wesley", senha: "1234" },
        { id: 18, nome: "Diego", senha: "1234" },
        { id: 19, nome: "H. Fontes", senha: "1234" },
        { id: 20, nome: "Anderson SC", senha: "1234" },
        { id: 21, nome: "Rafael Augusto", senha: "1234" }
    ],
    unidades: [
        { id: 101, nome: "Unidade Centro", mentorId: 1, estado: "SP", pais: "Brasil", senha: "1234" }
    ],
    modalidades: [ 
                { id: 201, nome: "POWER FIGHT", cor: "#fa7000" }, 
                { id: 202, nome: "POWER PILATES", cor: "#9a47ff" }, 
                { id: 203, nome: "POWER TRAINING", cor: "#06f95f" },
                { id: 204, nome: "POWER BUMBUM", cor: "#ff14cc" },
                { id: 205, nome: "POWER CORE", cor: "#00aaff" },
                { id: 206, nome: "ENERGY JUMP", cor: "#0488fb" },
                { id: 207, nome: "POWER DANCE", cor: "#ff1a1a" }
    ],
    horarios: [
        { id: 301, unidadeId: 101, modalidadeId: 201, professor: "HELOISA", valor: 20, hora: "07:00", dias: ["Segunda", "Quarta", "Sexta"], duracao: 60 }
    ],
    feriados: [
        { id: 1, nome: "Confraterniza√ß√£o Universal", dataInicio: "2025-01-01", dataFim: "2025-01-01", escopo: "Global", local: "" }
    ],
    validacoes: [],
    acessos: []
};

        // ==========================================
        // 1.5 DATA LAYER (ABSTRA√á√ÉO DE PERSIST√äNCIA)
        // ==========================================
        
        /**
         * DataLayer: Camada abstrata que gerencia persist√™ncia de dados
         * Suporta localStorage e Supabase de forma transparente
         */
        class DataLayer {
            constructor(source) {
                this.source = source;
                if (source === 'supabase') {
                    this.supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.key);
                    this.initializeSupabase();
                }
            }
            
            async initializeSupabase() {
                try {
                    // Verifica conex√£o
                    const { data, error } = await this.supabase.from('mentores').select('count');
                    if (error) throw error;
                    console.log('‚úÖ Supabase conectado com sucesso!');
                } catch (error) {
                    console.error('‚ùå Erro ao conectar no Supabase:', error.message);
                    console.warn('üí° Verifique se SUPABASE_CONFIG est√° correto e se o schema foi criado.');
                }
            }
            
            // ============= LOAD DATA =============
            async loadData() {
                if (this.source === 'localStorage') {
                    return this._loadFromLocalStorage();
                } else {
                    return await this._loadFromSupabase();
                }
            }
            
            _loadFromLocalStorage() {
                try {
                    const stored = localStorage.getItem('db');
                    return stored ? JSON.parse(stored) : INITIAL_DB;
                } catch (error) {
                    console.error('Erro ao carregar do localStorage:', error);
                    return INITIAL_DB;
                }
            }
            
            async _loadFromSupabase() {
                try {
                    const [mentores, unidades, modalidades, horarios, validacoes, feriados] = await Promise.all([
                        this.supabase.from('mentores').select('*'),
                        this.supabase.from('unidades').select('*'),
                        this.supabase.from('modalidades').select('*'),
                        this.supabase.from('horarios').select('*'),
                        this.supabase.from('validacoes').select('*'),
                        this.supabase.from('feriados').select('*')
                    ]);
                    
                    return {
                        mentores: mentores.data || [],
                        unidades: unidades.data || [],
                        modalidades: modalidades.data || [],
                        horarios: horarios.data || [],
                        validacoes: validacoes.data || [],
                        feriados: feriados.data || [],
                        acessos: []
                    };
                } catch (error) {
                    console.error('Erro ao carregar do Supabase:', error);
                    return INITIAL_DB;
                }
            }
            
            // ============= SAVE DATA =============
            async saveData(db) {
                if (this.source === 'localStorage') {
                    this._saveToLocalStorage(db);
                } else {
                    // Supabase usa opera√ß√µes at√¥micas, n√£o salva tudo de uma vez
                    console.log('Supabase: dados salvos automaticamente via opera√ß√µes individuais');
                }
            }
            
            _saveToLocalStorage(db) {
                try {
                    localStorage.setItem('db', JSON.stringify(db));
                } catch (error) {
                    console.error('Erro ao salvar no localStorage:', error);
                }
            }
            
            // ============= CRUD OPERATIONS =============
            async insert(table, data) {
                if (this.source === 'localStorage') {
                    return data; // Retorna os dados, persist√™ncia via saveData
                } else {
                    const { data: result, error } = await this.supabase.from(table).insert(data).select().single();
                    if (error) throw error;
                    return result;
                }
            }
            
            async update(table, id, data) {
                if (this.source === 'localStorage') {
                    return data; // Retorna os dados, persist√™ncia via saveData
                } else {
                    const { data: result, error } = await this.supabase.from(table).update(data).eq('id', id).select().single();
                    if (error) throw error;
                    return result;
                }
            }
            
            async delete(table, id) {
                if (this.source === 'localStorage') {
                    return true; // Confirma√ß√£o, persist√™ncia via saveData
                } else {
                    const { error } = await this.supabase.from(table).delete().eq('id', id);
                    if (error) throw error;
                    return true;
                }
            }
            
            // ============= EXPORT/IMPORT =============
            async exportData(db) {
                const dataStr = JSON.stringify(db, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup-gestao-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
            
            async importData(file, callback) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (this.source === 'supabase') {
                            // Importar para Supabase
                            await this._importToSupabase(importedData);
                        }
                        
                        callback(importedData, null);
                    } catch (error) {
                        callback(null, 'Arquivo inv√°lido. Certifique-se de que √© um backup v√°lido.');
                    }
                };
                reader.readAsText(file);
            }
            
            async _importToSupabase(data) {
                try {
                    // Limpa tabelas existentes
                    await Promise.all([
                        this.supabase.from('validacoes').delete().neq('id', 0),
                        this.supabase.from('horarios').delete().neq('id', 0),
                        this.supabase.from('feriados').delete().neq('id', 0),
                        this.supabase.from('modalidades').delete().neq('id', 0),
                        this.supabase.from('unidades').delete().neq('id', 0),
                        this.supabase.from('mentores').delete().neq('id', 0)
                    ]);
                    
                    // Insere novos dados
                    await this.supabase.from('mentores').insert(data.mentores);
                    await this.supabase.from('unidades').insert(data.unidades);
                    await this.supabase.from('modalidades').insert(data.modalidades);
                    await this.supabase.from('horarios').insert(data.horarios);
                    await this.supabase.from('validacoes').insert(data.validacoes);
                    await this.supabase.from('feriados').insert(data.feriados);
                    
                    console.log('‚úÖ Dados importados para Supabase com sucesso!');
                } catch (error) {
                    console.error('‚ùå Erro ao importar para Supabase:', error);
                    throw error;
                }
            }
            
            // ============= REALTIME SUBSCRIPTIONS =============
            subscribeToChanges(onDataChange) {
                if (this.source !== 'supabase') {
                    console.log('üì° Realtime: Dispon√≠vel apenas com Supabase');
                    return null;
                }
                
                console.log('üì° Iniciando subscriptions Realtime...');
                
                const channel = this.supabase.channel('db-changes');
                
                // Subscribe para todas as tabelas
                const tables = ['mentores', 'unidades', 'modalidades', 'horarios', 'validacoes', 'feriados'];
                
                tables.forEach(table => {
                    channel.on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table },
                        (payload) => {
                            console.log(`üîî Mudan√ßa detectada em ${table}:`, payload.eventType);
                            onDataChange({
                                table,
                                event: payload.eventType,
                                old: payload.old,
                                new: payload.new
                            });
                        }
                    );
                });
                
                channel.subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('‚úÖ Realtime conectado! Sincroniza√ß√£o ativa.');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('‚ùå Erro na conex√£o Realtime');
                    }
                });
                
                return channel;
            }
            
            unsubscribeFromChanges(channel) {
                if (channel) {
                    channel.unsubscribe();
                    console.log('üì° Realtime desconectado');
                }
            }
        }
        
        // Inst√¢ncia global do DataLayer
        const dataLayer = new DataLayer(DATA_SOURCE);

        // ==========================================
        // 2. HOOKS E UTILS
        // ==========================================

        // Sanitiza√ß√£o de texto para prevenir XSS
        const sanitizeText = (text) => {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };

        const usePersistentState = (key, initialValue) => {
            const [state, setState] = useState(() => {
                try {
                    // Sempre usa localStorage para prefer√™ncias de UI (independente do DATA_SOURCE)
                    const storedValue = localStorage.getItem(key);
                    return storedValue !== null ? JSON.parse(storedValue) : initialValue;
                } catch (error) {
                    console.warn(`Erro ao carregar ${key} do localStorage:`, error);
                    return initialValue;
                }
            });
            useEffect(() => {
                try {
                    localStorage.setItem(key, JSON.stringify(state));
                } catch (error) {
                    console.error(`Erro ao salvar ${key} no localStorage:`, error);
                }
            }, [key, state]);
            return [state, setState];
        };

        const useTheme = () => {
            const [isDark, setIsDark] = usePersistentState('darkMode', false);
            useEffect(() => {
                if (isDark) document.body.classList.add('dark');
                else document.body.classList.remove('dark');
            }, [isDark]);
            return { isDark, toggle: () => setIsDark(!isDark) };
        };

        const ToastContext = createContext();
        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (message, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };
            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="toast-container">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`p-4 rounded shadow-lg text-white text-sm font-bold flex items-center gap-2 animate-slide-in ${toast.type === 'success' ? 'bg-green-600' : 'bg-red-500'}`}>
                                <span>{toast.message}</span>
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };
        const useToast = () => useContext(ToastContext);

        const useDebounce = (value, delay) => {
            const [debouncedValue, setDebouncedValue] = useState(value);
            useEffect(() => {
                const handler = setTimeout(() => setDebouncedValue(value), delay);
                return () => clearTimeout(handler);
            }, [value, delay]);
            return debouncedValue;
        };

        const filterByUserPermission = (items, user, idField = 'id', mentorField = 'mentorId') => {
            if (user.role === 'admin') return items;
            if (user.role === 'mentor') return items.filter(i => i[mentorField] === user.id);
            if (user.role === 'unidade') return items.filter(i => i[idField] === user.id);
            return [];
        };

        // DataBackup agora est√° integrado no DataLayer

        const DateUtils = {
            toISODate: (date) => { const offset = date.getTimezoneOffset(); const adjustedDate = new Date(date.getTime() - (offset*60*1000)); return adjustedDate.toISOString().split('T')[0]; },
            getDayOfWeek: (dateString) => { if(!dateString) return ''; const [y, m, d] = dateString.split('-'); const date = new Date(y, m - 1, d); const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado']; return days[date.getDay()]; },
            isHoliday: (dateStr, feriados, unidade) => feriados.find(f => { const dentroDoPrazo = dateStr >= f.dataInicio && dateStr <= f.dataFim; if (!dentroDoPrazo) return false; if (f.escopo === 'Global') return true; if (f.escopo === 'Nacional' && unidade && f.local === unidade.pais) return true; if (f.escopo === 'Regional' && unidade && f.local === unidade.estado) return true; return false; }),
            formatBr: (date) => { const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); return `${day}/${month}`; },
            formatDateTimeBr: (isoString) => { if (!isoString) return '-'; const date = new Date(isoString); return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`; },
            
            // L√≥gica de Gera√ß√£o de Datas de Aula no M√™s
            generateClassDates: (diasSemana, mes, ano, feriados = [], unidade = null) => { 
                const dates = []; 
                const possibleDates = []; 
                const daysMap = { "Domingo": 0, "Segunda": 1, "Ter√ßa": 2, "Quarta": 3, "Quinta": 4, "Sexta": 5, "S√°bado": 6 }; 
                
                // Mapeia os dias da semana da aula para √≠ndices (0-6)
                const targetDays = diasSemana.map(d => daysMap[d]); 
                
                // Determina quantos dias o m√™s possui
                const daysInMonth = new Date(ano, mes, 0).getDate();
                
                // Itera exatamente do dia 1 at√© o √∫ltimo dia do m√™s
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(ano, mes - 1, day);
                    const currentDayOfWeek = date.getDay();

                    // Se o dia da semana bate com a aula
                    if (targetDays.includes(currentDayOfWeek)) {
                        const dateStr = DateUtils.toISODate(date); 
                        const isFeriado = DateUtils.isHoliday(dateStr, feriados, unidade); 
                        
                        // Registra como data poss√≠vel (para c√°lculo de perda)
                        possibleDates.push({ date: new Date(date), dateStr, isFeriado }); 
                        
                        // Se N√ÉO for feriado, conta como aula realizada (efetiva no calend√°rio)
                        if (!isFeriado) {
                            dates.push(new Date(date)); 
                        }
                    }
                }
                return { dates, possibleDates }; 
            },
            
            getRangeDates: (start, end) => { const dates = []; let current = new Date(start); const endDate = new Date(end); while (current <= endDate) { dates.push(DateUtils.toISODate(current)); current.setDate(current.getDate() + 1); } return dates; },
            formatStringDate: (dateString) => { if (!dateString) return '-'; const [y, m, d] = dateString.split('-'); return `${d}/${m}`; },
            createLocalDate: (dateString) => { if(!dateString) return null; const [y, m, d] = dateString.split('-').map(Number); return new Date(y, m - 1, d); }
        };

        const BusinessLogic = {
            // Fun√ß√µes auxiliares internas
            _calcularDadosAula: (horario, unidade, modalidade, filters, validacoes, feriados) => {
                const { dates: diasDeAula, possibleDates } = DateUtils.generateClassDates(
                    horario.dias, filters.mes, filters.ano, feriados, unidade
                );
                
                const numAulasPrevistas = diasDeAula.length;
                const aulasPerdidasFeriado = possibleDates.length - numAulasPrevistas;
                
                const validacoesDoMes = validacoes.filter(v => 
                    v.aulaId === horario.id && 
                    parseInt(v.data.split('-')[1]) == filters.mes && 
                    parseInt(v.data.split('-')[0]) == filters.ano
                );
                
                const totalAlunosReais = validacoesDoMes.reduce((acc, v) => acc + parseInt(v.qtdAlunos || 0), 0);
                const numAulasRealizadas = validacoesDoMes.length;
                const mediaAlunos = numAulasRealizadas > 0 ? Math.round(totalAlunosReais / numAulasRealizadas) : 0;
                
                return { numAulasPrevistas, aulasPerdidasFeriado, validacoesDoMes, mediaAlunos, numAulasRealizadas };
            },

            _calcularFinanceiro: (numAulasPrevistas, aulasPerdidasFeriado, valorHora) => {
                return {
                    valorMensal: numAulasPrevistas * valorHora,
                    valorPerdidoFeriado: aulasPerdidasFeriado * valorHora
                };
            },

            _aplicarFiltros: (horario, filters, unidadesMap, user) => {
                const unidade = unidadesMap.get(horario.unidadeId);
                if (!unidade) return false;
                
                if (user.role === 'mentor' && unidade.mentorId !== user.id) return false;
                if (user.role === 'unidade' && horario.unidadeId !== user.id) return false;
                if (filters.unidade !== 'TODAS' && horario.unidadeId != filters.unidade) return false;
                if (filters.mentor !== 'TODOS' && unidade.mentorId != filters.mentor) return false;
                if (filters.modalidade !== 'TODAS' && horario.modalidadeId != filters.modalidade) return false;
                if (filters.pais !== 'TODOS' && unidade.pais !== filters.pais) return false;
                if (filters.estado !== 'TODOS' && unidade.estado !== filters.estado) return false;
                
                return true;
            },

            processarAulas: (db, user, filters) => {
                const todosFeriados = db.feriados || [];
                const validacoes = db.validacoes || [];
                
                // Criar Maps para performance O(1)
                const unidadesMap = new Map(db.unidades.map(u => [u.id, u]));
                const modalidadesMap = new Map(db.modalidades.map(m => [m.id, m]));
                const mentoresMap = new Map(db.mentores.map(m => [m.id, m]));
                
                const dadosProcessados = (db.horarios || []).map(h => {
                    const u = unidadesMap.get(h.unidadeId);
                    const m = modalidadesMap.get(h.modalidadeId);
                    const mentor = u ? mentoresMap.get(u.mentorId) : null;
                    
                    const dadosAula = BusinessLogic._calcularDadosAula(h, u, m, filters, validacoes, todosFeriados);
                    const valorHora = parseFloat(h.valor) || 0;
                    const dadosFinanceiros = BusinessLogic._calcularFinanceiro(
                        dadosAula.numAulasPrevistas, 
                        dadosAula.aulasPerdidasFeriado, 
                        valorHora
                    );
                    
                    const historicoAulas = dadosAula.validacoesDoMes.map(v => {
                        const d = new Date(v.data + 'T00:00:00');
                        return {
                            dateStr: v.data,
                            dataFormatada: DateUtils.formatBr(d),
                            qtdAlunos: v.qtdAlunos,
                            valor: valorHora,
                            modalidade: m?.nome,
                            horario: h.hora,
                            diaSemana: DateUtils.getDayOfWeek(v.data)
                        };
                    });
                    
                    return {
                        ...h,
                        unidadeNome: u?.nome || 'Desconhecida',
                        pais: u?.pais || '-',
                        estado: u?.estado || '-',
                        mentorNome: mentor?.nome || '-',
                        modalidadeNome: m?.nome || '-',
                        modalidadeCor: m?.cor || '#cbd5e1',
                        valorHora,
                        numAulasPrevistas: dadosAula.numAulasPrevistas,
                        numAulasRealizadas: dadosAula.numAulasRealizadas,
                        valorMensal: dadosFinanceiros.valorMensal,
                        valorPerdidoFeriado: dadosFinanceiros.valorPerdidoFeriado,
                        mediaAlunos: dadosAula.mediaAlunos,
                        historicoAulas
                    };
                });
                
                return dadosProcessados.filter(h => BusinessLogic._aplicarFiltros(h, filters, unidadesMap, user));
            },
            _obterDatasAlvo: (filterMode, startDate, endDate) => {
                let targetDates = [];
                if (filterMode === 'day') {
                    targetDates = [startDate];
                } else if (filterMode === 'range') {
                    targetDates = DateUtils.getRangeDates(startDate, endDate);
                } else if (filterMode === 'month') {
                    const [y, m] = startDate.split('-');
                    const daysInMonth = new Date(y, m, 0).getDate();
                    const end = `${y}-${m}-${daysInMonth}`;
                    targetDates = DateUtils.getRangeDates(`${y}-${m}-01`, end);
                }
                const today = new Date().toISOString().split('T')[0];
                return targetDates.filter(d => d <= today);
            },

            _calcularStatusUnidade: (percentual) => {
                let status = 'Cr√≠tico';
                let statusCor = STATUS_COLORS.danger.bg + ' ' + STATUS_COLORS.danger.text;
                
                if (percentual >= 90) {
                    status = 'Excelente';
                    statusCor = STATUS_COLORS.success.light + ' ' + STATUS_COLORS.success.text;
                } else if (percentual >= 60) {
                    status = 'Aten√ß√£o';
                    statusCor = STATUS_COLORS.warning.light + ' ' + STATUS_COLORS.warning.text;
                }
                
                return { status, statusCor };
            },

            calcularQualidade: (db, filterMode, startDate, endDate, user) => {
                const targetDates = BusinessLogic._obterDatasAlvo(filterMode, startDate, endDate);
                const unidadesFiltradas = filterByUserPermission(db.unidades, user);
                
                // Criar Maps para performance
                const validacoesMap = new Map();
                (db.validacoes || []).forEach(v => {
                    const key = `${v.aulaId}-${v.data}`;
                    validacoesMap.set(key, v);
                });
                
                const mentoresMap = new Map(db.mentores.map(m => [m.id, m]));
                const diasSemanaMap = Object.freeze({ "Domingo": 0, "Segunda": 1, "Ter√ßa": 2, "Quarta": 3, "Quinta": 4, "Sexta": 5, "S√°bado": 6 });
                
                const adesaoPorUnidade = unidadesFiltradas.map(u => {
                    const aulasDaUnidade = db.horarios.filter(h => h.unidadeId === u.id);
                    let atividadesEsperadas = 0;
                    let atividadesRealizadas = 0;
                    let datasPendentes = [];
                    let lastValidation = null;
                    
                    aulasDaUnidade.forEach(h => {
                        const diasAulaIndices = h.dias.map(d => diasSemanaMap[d]);
                        
                        targetDates.forEach(date => {
                            const dt = new Date(date + 'T00:00:00');
                            const dayIdx = dt.getDay();
                            
                            if (diasAulaIndices.includes(dayIdx)) {
                                if (!DateUtils.isHoliday(date, db.feriados, u)) {
                                    atividadesEsperadas++;
                                    const val = validacoesMap.get(`${h.id}-${date}`);
                                    
                                    if (val) {
                                        atividadesRealizadas++;
                                        if (!lastValidation || new Date(val.timestamp) > new Date(lastValidation.timestamp)) {
                                            lastValidation = val;
                                        }
                                    } else {
                                        const diaMes = date.split('-').slice(1).reverse().join('/');
                                        datasPendentes.push(diaMes);
                                    }
                                }
                            }
                        });
                    });
                    
                    const percentual = atividadesEsperadas > 0 ? Math.round((atividadesRealizadas / atividadesEsperadas) * 100) : 100;
                    const mentor = mentoresMap.get(u.mentorId);
                    const { status, statusCor } = BusinessLogic._calcularStatusUnidade(percentual);
                    
                    return {
                        ...u,
                        mentorName: mentor?.nome || "Sem Mentor",
                        atividadesEsperadas,
                        atividadesRealizadas,
                        pendencias: atividadesEsperadas - atividadesRealizadas,
                        datasPendentes: [...new Set(datasPendentes)],
                        percentual,
                        status,
                        statusCor,
                        lastValidationTime: lastValidation ? lastValidation.timestamp : null
                    };
                });
                
                return adesaoPorUnidade.sort((a, b) => {
                    if (a.status === b.status) return a.nome.localeCompare(b.nome);
                    return a.status === 'Pendente' ? -1 : 1;
                });
            }
        };

        // ==========================================
        // 3. COMPONENTES VISUAIS (ATOMIC UI)
        // ==========================================

        // Error Boundary para capturar erros em componentes
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error('Erro capturado pelo ErrorBoundary:', error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex items-center justify-center min-h-screen bg-slate-50 dark:bg-slate-900 p-4">
                            <div className="glass-panel p-8 max-w-md text-center">
                                <div className="text-red-500 mb-4">
                                    <svg className="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                </div>
                                <h3 className="text-xl font-bold text-slate-800 dark:text-white mb-2">Ops! Algo deu errado</h3>
                                <p className="text-slate-600 dark:text-slate-400 mb-4">Ocorreu um erro inesperado. Por favor, recarregue a p√°gina.</p>
                                <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors">
                                    Recarregar P√°gina
                                </button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const Icon = React.memo(({ name, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide) {
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    if (className) i.setAttribute('class', className);
                    if (ref.current) { ref.current.innerHTML = ''; ref.current.appendChild(i); window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { class: className } }); }
                }
            }, [name, className]);
            return <span ref={ref} style={{ display: 'contents' }}></span>;
        });

        const Button = React.memo(({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const baseClass = "px-4 py-2 rounded-lg font-bold text-xs uppercase transition-all duration-200 flex items-center justify-center gap-2 active:scale-95";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md hover:shadow-lg",
                success: "bg-green-600 text-white hover:bg-green-700 shadow-md hover:shadow-lg",
                danger: "bg-red-500 text-white hover:bg-red-600 shadow-md hover:shadow-lg",
                outline: "border border-slate-300 text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800",
                ghost: "text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800"
            };
            return <button onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        });

        const Input = React.memo(({ label, error, ...props }) => {
            const inputId = useRef(`input-${Math.random().toString(36).substr(2, 9)}`);
            return (
                <div className="w-full">
                    {label && <label htmlFor={inputId.current} className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">{label}</label>}
                    <input 
                        id={inputId.current}
                        className={`w-full p-2 border rounded-lg text-sm outline-none transition-colors dark:bg-slate-800 dark:border-slate-700 dark:text-white ${error ? 'input-error' : 'border-slate-200 focus:border-blue-500'}`} 
                        aria-invalid={error ? 'true' : 'false'}
                        aria-describedby={error ? `${inputId.current}-error` : undefined}
                        {...props} 
                    />
                    {error && <span id={`${inputId.current}-error`} className="text-[10px] text-red-500 mt-1 block" role="alert">Campo obrigat√≥rio</span>}
                </div>
            );
        });

        const Select = React.memo(({ label, error, children, ...props }) => {
            const selectId = useRef(`select-${Math.random().toString(36).substr(2, 9)}`);
            return (
                <div className="w-full">
                    {label && <label htmlFor={selectId.current} className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">{label}</label>}
                    <select 
                        id={selectId.current}
                        className={`w-full p-2 border rounded-lg text-sm outline-none transition-colors dark:bg-slate-800 dark:border-slate-700 dark:text-white ${error ? 'input-error' : 'border-slate-200 focus:border-blue-500'}`} 
                        aria-invalid={error ? 'true' : 'false'}
                        {...props}
                    >{children}</select>
                </div>
            );
        });

        const Skeleton = React.memo(({ className }) => <div className={`animate-pulse bg-slate-200 dark:bg-slate-700 rounded ${className}`} role="status" aria-label="Carregando..."></div>);

        const Avatar = React.memo(({ name, size = 'md' }) => {
            const initials = name ? name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
            const colors = ['bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-green-500', 'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 'bg-pink-500'];
            const colorIndex = name ? name.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colors.length : 0;
            const sizeClasses = { sm: 'w-6 h-6 text-[10px]', md: 'w-8 h-8 text-xs', lg: 'w-10 h-10 text-sm' };
            return <div className={`${sizeClasses[size]} rounded-full ${colors[colorIndex]} text-white flex items-center justify-center font-bold shadow-sm ring-2 ring-white dark:ring-slate-700`} role="img" aria-label={`Avatar de ${name}`}>{initials}</div>;
        });

        const EmptyState = React.memo(({ message, icon = "inbox" }) => (
            <div className="flex flex-col items-center justify-center p-12 text-slate-400 border-2 border-dashed border-slate-200 dark:border-slate-700 rounded-xl bg-slate-50/50 dark:bg-slate-800/50" role="status">
                <div className="bg-white dark:bg-slate-800 p-4 rounded-full mb-3 shadow-sm"><Icon name={icon} className="w-10 h-10 opacity-50" /></div>
                <p className="text-sm font-medium text-slate-500 dark:text-slate-400">{message}</p>
            </div>
        ));

        const ConfirmModal = React.memo(({ isOpen, onClose, onConfirm, title, message, type = "danger" }) => {
            useEffect(() => {
                if (isOpen) {
                    const handleEscape = (e) => { if (e.key === 'Escape') onClose(); };
                    document.addEventListener('keydown', handleEscape);
                    return () => document.removeEventListener('keydown', handleEscape);
                }
            }, [isOpen, onClose]);
            
            if (!isOpen) return null;
            const color = type === "danger" ? "red" : "blue";
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-fade-in backdrop-blur-sm" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-describedby="modal-description">
                    <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100 border border-slate-100 dark:border-slate-700">
                        <div className="p-6 text-center">
                            <div className={`mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-${color}-100 dark:bg-${color}-900/30 mb-4`} aria-hidden="true"><Icon name={type === "danger" ? "alert-triangle" : "info"} className={`h-6 w-6 text-${color}-600 dark:text-${color}-400`} /></div>
                            <h3 id="modal-title" className="text-lg font-bold text-slate-900 dark:text-white">{title}</h3>
                            <div className="mt-2"><p id="modal-description" className="text-sm text-slate-500 dark:text-slate-400">{message}</p></div>
                        </div>
                        <div className="bg-slate-50 dark:bg-slate-900/50 px-4 py-3 sm:px-6 flex flex-row-reverse gap-2">
                            <button onClick={onConfirm} className={`w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-${color}-600 text-base font-medium text-white hover:bg-${color}-700 sm:ml-3 sm:w-auto sm:text-sm`} autoFocus>Confirmar</button>
                            <button onClick={onClose} className="mt-3 w-full inline-flex justify-center rounded-md border border-slate-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-slate-700 hover:bg-slate-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">Cancelar</button>
                        </div>
                    </div>
                </div>
            );
        });

        const CardKPI = React.memo(({ title, value, color, icon, subtitle }) => (
            <div className={`glass-panel p-5 border-l-4 border-${color}-500 flex items-start justify-between hover:shadow-lg transition-all duration-300 transform hover:-translate-y-1`} role="region" aria-label={title}>
                <div className="flex-1">
                    <p className="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider mb-1">{title}</p>
                    <p className={`text-2xl font-bold text-slate-800 dark:text-white`} aria-live="polite">{value}</p>
                    {subtitle && <p className="text-[10px] text-slate-400 dark:text-slate-500 mt-1">{subtitle}</p>}
                </div>
                <div className={`p-3 bg-${color}-50 dark:bg-${color}-900/20 rounded-xl text-${color}-500 dark:text-${color}-400 shadow-sm`} aria-hidden="true"><Icon name={icon} className="w-6 h-6" /></div>
            </div>
        ));

        const ChartComponent = ({ type, data, options, title }) => {
            const canvasRef = useRef(null);
            const chartRef = useRef(null);
            useEffect(() => {
                if (canvasRef.current) {
                    if (chartRef.current) chartRef.current.destroy();
                    const ctx = canvasRef.current.getContext('2d');
                    chartRef.current = new Chart(ctx, { type, data, options: { responsive: true, maintainAspectRatio: false, ...options } });
                }
                return () => { if (chartRef.current) chartRef.current.destroy(); };
            }, [data, type, options]);
            return (<div className="glass-panel p-4 h-64 flex flex-col"><h4 className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">{title}</h4><div className="flex-1 relative"><canvas ref={canvasRef}></canvas></div></div>);
        };

        // --- 4. VIEWS E TELAS ---

        const FilterCard = ({ filters, setFilters, db, user }) => {
            const months = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const years = [2024, 2025, 2026];
            const availableCountries = useMemo(() => ['TODOS', ...new Set(db.unidades.map(u => u.pais).filter(Boolean))], [db.unidades]);
            const availableStates = useMemo(() => { if (filters.pais === 'TODOS') return ['TODOS', ...new Set(db.unidades.map(u => u.estado).filter(Boolean))]; return ['TODOS', ...new Set(db.unidades.filter(u => u.pais === filters.pais).map(u => u.estado))]; }, [db.unidades, filters.pais]);
            
            // Logic for available units based on role
            const availableUnits = useMemo(() => { 
                let units = db.unidades;
                
                // Role filtering
                if (user.role === 'mentor') {
                    units = units.filter(u => u.mentorId === user.id);
                } else if (user.role === 'unidade') {
                    units = units.filter(u => u.id === user.id);
                }

                // Selection filtering
                return units.filter(u => { 
                    if (filters.pais !== 'TODOS' && u.pais !== filters.pais) return false; 
                    if (filters.estado !== 'TODOS' && u.estado !== filters.estado) return false; 
                    if (user.role === 'admin' && filters.mentor !== 'TODOS' && u.mentorId != filters.mentor) return false; 
                    return true; 
                }); 
            }, [db.unidades, filters.pais, filters.estado, filters.mentor, user]);

            const handleChange = (field, value) => { const newFilters = { ...filters, [field]: value }; if (field === 'pais') { newFilters.estado = 'TODOS'; newFilters.unidade = 'TODAS'; } if (field === 'estado') { newFilters.unidade = 'TODAS'; } if (field === 'mentor') { newFilters.unidade = 'TODAS'; } setFilters(newFilters); };
            
            // ACL Flags
            const canSeeLocation = user.role === 'admin';
            const canSeeMentor = user.role === 'admin';
            const canSeeUnit = user.role !== 'unidade';

            return (<div className="glass-panel p-5 fade-in"><div className="flex items-center gap-2 mb-4 pb-2 border-b border-slate-100 dark:border-slate-700"><Icon name="filter" className="w-4 h-4 text-blue-600" /><span className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase">Filtros de An√°lise</span></div><div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 items-end"><div><label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">M√™s</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.mes} onChange={e => handleChange('mes', e.target.value)}>{months.map((m, i) => <option key={i} value={i+1}>{m}</option>)}</select></div><div><label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Ano</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.ano} onChange={e => handleChange('ano', e.target.value)}>{years.map(y => <option key={y} value={y}>{y}</option>)}</select></div>
            {canSeeLocation && (<><div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Pa√≠s</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.pais} onChange={e => handleChange('pais', e.target.value)}>{availableCountries.map(c => <option key={c} value={c}>{c}</option>)}</select></div><div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Estado</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.estado} onChange={e => handleChange('estado', e.target.value)}>{availableStates.map(s => <option key={s} value={s}>{s}</option>)}</select></div></>)}
            {canSeeMentor && (<div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Mentor</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.mentor} onChange={e => handleChange('mentor', e.target.value)}><option value="TODOS">TODOS</option>{db.mentores.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}</select></div>)}
            {canSeeUnit && (<div><label className="block text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Unidade</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.unidade} onChange={e => handleChange('unidade', e.target.value)}><option value="TODAS">TODAS</option>{availableUnits.map(u => <option key={u.id} value={u.id}>{u.nome}</option>)}</select></div>)}
            <div><label className="block text-[10px] font-bold text-slate-500 uppercase mb-1">Modalidade</label><select className="w-full p-2 border border-slate-200 rounded text-xs h-9 uppercase bg-slate-50 focus:bg-white focus:border-blue-500 outline-none cursor-pointer" value={filters.modalidade} onChange={e => handleChange('modalidade', e.target.value)}><option value="TODAS">TODAS</option>{db.modalidades.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}</select></div></div></div>);
        };

        const RelatorioView = ({ db, user }) => {
            const [filters, setFilters] = usePersistentState('relatorioFilters', { mes: new Date().getMonth() + 1, ano: 2025, pais: 'TODOS', estado: 'TODOS', unidade: 'TODAS', mentor: 'TODOS', modalidade: 'TODAS' });
            const [activeTab, setActiveTab] = useState('geral');
            const [sortConfig, setSortConfig] = useState({ key: 'unidadeNome', direction: 'asc' });
            const [expandedRowId, setExpandedRowId] = useState(null);
            const [loading, setLoading] = useState(false);
            useEffect(() => { setLoading(true); const timer = setTimeout(() => setLoading(false), 500); return () => clearTimeout(timer); }, [filters]);
            const filteredData = useMemo(() => BusinessLogic.processarAulas(db, user, filters), [db, user, filters]);
            
            const kpis = useMemo(() => { 
                // Valida√ß√£o para evitar NaN quando n√£o h√° dados
                if (!filteredData || filteredData.length === 0) {
                    return { 
                        receita: 0, 
                        aulas: 0, 
                        mediaAlunos: 0, 
                        valorMedio: 0, 
                        unidades: 0, 
                        perdaFeriados: 0 
                    };
                }
                
                const totalValor = filteredData.reduce((acc, h) => acc + (h.valorMensal || 0), 0);
                const totalPerda = filteredData.reduce((acc, h) => acc + (h.valorPerdidoFeriado || 0), 0);
                const totalAlunos = filteredData.reduce((acc, h) => acc + (h.mediaAlunos || 0), 0);
                const count = filteredData.filter(h => h.mediaAlunos > 0).length || 1;
                const unidadesAtivas = new Set(filteredData.map(h => h.unidadeId).filter(id => id != null)).size;
                
                const totalAulasPrevistas = filteredData.reduce((acc, h) => acc + (h.numAulasPrevistas || 0), 0);
                const totalAulasRealizadas = filteredData.reduce((acc, h) => acc + (h.numAulasRealizadas || 0), 0);
                
                const valorMedio = totalAulasPrevistas > 0 ? totalValor / totalAulasPrevistas : 0; 

                return { 
                    receita: isNaN(totalValor) ? 0 : totalValor, 
                    aulas: isNaN(totalAulasRealizadas) ? 0 : totalAulasRealizadas, 
                    mediaAlunos: isNaN(totalAlunos / count) ? 0 : Math.round(totalAlunos / count),
                    valorMedio: isNaN(valorMedio) ? 0 : valorMedio,
                    unidades: isNaN(unidadesAtivas) ? 0 : unidadesAtivas, 
                    perdaFeriados: isNaN(totalPerda) ? 0 : totalPerda 
                }; 
            }, [filteredData]);

            const chartData = useMemo(() => { const modStats = {}; const unitStats = {}; filteredData.forEach(h => { if (!modStats[h.modalidadeNome]) modStats[h.modalidadeNome] = { count: 0, color: h.modalidadeCor }; modStats[h.modalidadeNome].count += h.mediaAlunos; if (!unitStats[h.unidadeNome]) unitStats[h.unidadeNome] = 0; unitStats[h.unidadeNome] += h.valorMensal; }); const sortedUnits = Object.entries(unitStats).sort((a,b) => b[1] - a[1]).slice(0, 5); return { modalidades: { labels: Object.keys(modStats), datasets: [{ data: Object.values(modStats).map(v => v.count), backgroundColor: Object.values(modStats).map(v => v.color), borderWidth: 0 }] }, receita: { labels: sortedUnits.map(i => i[0]), datasets: [{ label: 'Receita Prevista (R$)', data: sortedUnits.map(i => i[1]), backgroundColor: '#3b82f6', borderRadius: 4 }] } }; }, [filteredData]);
            const sortedData = useMemo(() => { let items = [...filteredData]; if (sortConfig.key) { items.sort((a, b) => { if (a[sortConfig.key] < b[sortConfig.key]) return sortConfig.direction === 'asc' ? -1 : 1; if (a[sortConfig.key] > b[sortConfig.key]) return sortConfig.direction === 'asc' ? 1 : -1; return 0; }); } return items; }, [filteredData, sortConfig]);
            const rankingData = useMemo(() => { return [...filteredData].sort((a, b) => b.mediaAlunos - a.mediaAlunos).map((item, index) => ({...item, rankPos: index + 1})); }, [filteredData]);
            const handleSort = (key) => { let direction = 'asc'; if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc'; setSortConfig({ key, direction }); };
            return (<div className="p-6 space-y-6 fade-in"><FilterCard filters={filters} setFilters={setFilters} db={db} user={user} /><div className="grid grid-cols-2 lg:grid-cols-6 gap-4"><CardKPI title="VALOR TOTAL MENSAL" value={`R$ ${kpis.receita.toLocaleString('pt-BR')}`} color="blue" icon="dollar-sign" /><CardKPI title="AULAS REALIZADAS" value={kpis.aulas} color="emerald" icon="activity" /><CardKPI title="M√âDIA DE ALUNOS" value={kpis.mediaAlunos} color="orange" icon="users" /><CardKPI title="VALOR M√âDIO" value={`R$ ${kpis.valorMedio.toLocaleString('pt-BR', {maximumFractionDigits: 0})}`} color="cyan" icon="trending-up" /><CardKPI title="FERIADO ECONOMIA" value={`R$ ${kpis.perdaFeriados.toLocaleString('pt-BR')}`} color="red" icon="calendar-off" /><CardKPI title="UNIDADES MENTORADAS" value={kpis.unidades} color="purple" icon="map-pin" /></div><div className="glass-panel overflow-hidden min-h-[500px]"><div className="flex border-b border-slate-200 bg-slate-50/50">{['geral', 'media'].map(tab => (<button key={tab} onClick={() => setActiveTab(tab)} className={`px-6 py-3 text-xs font-bold uppercase flex items-center gap-2 border-b-2 transition-colors ${activeTab === tab ? 'border-blue-500 text-blue-600 bg-white' : 'border-transparent text-slate-500 hover:text-slate-700'}`}><Icon name={tab === 'geral' ? 'bar-chart' : 'list'} className="w-4 h-4" /> {tab === 'geral' ? 'An√°lise Geral' : 'Detalhamento M√©dio'}</button>))}</div><div className="p-6">{loading ? (<div className="p-8 space-y-4"><Skeleton className="h-12 w-full"/><Skeleton className="h-12 w-full"/></div>) : activeTab === 'geral' ? (<div className="space-y-6 animate-fade-in"><div className="overflow-x-auto border rounded-lg"><table className="w-full text-left text-xs uppercase"><thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-200"><tr><th className="p-3 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('unidadeNome')}>Unidade <Icon name="arrow-up-down" className="w-3 h-3 inline opacity-50"/></th><th className="p-3 hidden md:table-cell cursor-pointer hover:bg-slate-100" onClick={() => handleSort('professor')}>Professor</th><th className="p-3 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('modalidadeNome')}>Modalidade</th><th className="p-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => handleSort('numAulasPrevistas')}>Aulas</th><th className="p-3 text-center cursor-pointer hover:bg-slate-100" onClick={() => handleSort('mediaAlunos')}>M√©dia Real</th><th className="p-3 text-right cursor-pointer hover:bg-slate-100" onClick={() => handleSort('valorMensal')}>Total Mensal</th></tr></thead><tbody className="divide-y divide-slate-100">{sortedData.map(h => (<tr key={h.id} className="hover:bg-slate-50 transition-colors"><td className="p-3 font-bold text-slate-700">{h.unidadeNome}</td><td className="p-3 hidden md:table-cell text-slate-600">{h.professor}</td><td className="p-3 text-blue-600 font-semibold">{h.modalidadeNome}</td><td className="p-3 text-center font-bold">{h.numAulasPrevistas}</td><td className="p-3 text-center font-bold">{h.mediaAlunos}</td><td className="p-3 text-right font-mono text-green-600 font-bold">R$ {h.valorMensal.toFixed(2)}</td></tr>))}</tbody></table></div><div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-6 border-t"><ChartComponent type="bar" title="Top 5 Unidades (Receita)" data={chartData.receita} options={{ indexAxis: 'y', scales: { x: { display: false }, y: { grid: { display: false } } } }} /><ChartComponent type="doughnut" title="Distribui√ß√£o de Alunos" data={chartData.modalidades} options={{ cutout: '70%' }} /></div></div>) : (<div className="fade-in"><div className="overflow-x-auto border rounded-lg"><table className="w-full text-left text-xs uppercase"><thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-200"><tr><th className="p-3 text-center w-16 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('rankPos')}>Pos</th><th className="p-3 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('unidadeNome')}>Unidade</th><th className="p-3 hidden md:table-cell cursor-pointer hover:bg-slate-100" onClick={() => handleSort('mentorNome')}>Mentor</th><th className="p-3 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('professor')}>Detalhe</th><th className="p-3 cursor-pointer hover:bg-slate-100" onClick={() => handleSort('modalidadeNome')}>Modalidade</th><th className="p-3 text-right cursor-pointer hover:bg-slate-100" onClick={() => handleSort('hora')}>Hor√°rio</th><th className="p-3 text-right cursor-pointer hover:bg-slate-100" onClick={() => handleSort('valorHora')}>Valor Aula</th><th className="p-3 text-right cursor-pointer hover:bg-slate-100" onClick={() => handleSort('mediaAlunos')}>M√©dia Alunos</th></tr></thead><tbody className="divide-y divide-slate-100">{rankingData.map((h) => { const medal = h.rankPos === 1 ? 'text-yellow-500' : h.rankPos === 2 ? 'text-slate-400' : h.rankPos === 3 ? 'text-orange-500' : 'text-slate-400'; const isExpanded = expandedRowId === h.id; return (<React.Fragment key={h.id}><tr className={`hover:bg-slate-50 cursor-pointer ${isExpanded ? 'bg-slate-50 border-b-0' : ''}`} onClick={() => setExpandedRowId(isExpanded ? null : h.id)}><td className={`p-3 text-center font-bold text-lg ${medal}`}>{h.rankPos}</td><td className="p-3 font-bold text-slate-700">{h.unidadeNome}</td><td className="p-3 text-slate-500 hidden md:table-cell">{h.mentorNome}</td><td className="p-3 font-semibold text-slate-700 flex items-center gap-2"><Avatar name={h.professor} size="sm" /> {h.professor}</td><td className="p-3 text-blue-600 font-bold">{h.modalidadeNome}</td><td className="p-3 text-right font-mono text-slate-600">{h.hora}</td><td className="p-3 text-right font-mono text-slate-500">R$ {h.valorHora.toFixed(2)}</td><td className="p-3 text-right font-bold text-blue-600 text-sm">{h.mediaAlunos}</td></tr>{isExpanded && (<tr className="bg-slate-50 expanded-row"><td colSpan="8" className="p-4 pl-12 border-t border-slate-100"><div className="text-xs font-bold text-slate-500 mb-2 uppercase">Hist√≥rico de Valida√ß√µes</div>{h.historicoAulas.length > 0 ? (<div className="grid grid-cols-2 md:grid-cols-4 gap-3">{h.historicoAulas.map((item, i) => (<div key={i} className="border p-2 rounded flex justify-between items-center shadow-sm bg-white border-green-200 transition-all hover:scale-105"><div><span className="text-slate-500 font-mono text-[10px] block">{item.diaSemana}</span><span className="text-slate-700 font-bold text-xs">{item.dataFormatada}</span></div><span className="font-bold text-blue-600">{item.qtdAlunos}</span></div>))}</div>) : (<span className="text-slate-400 text-sm">Nenhuma aula validada neste m√™s.</span>)}</td></tr>)}</React.Fragment>); })}</tbody></table></div></div>)}</div></div></div>); };

        const CronogramaView = ({ db, setDb, user }) => { 
            const { addToast } = useToast();
            // Default select logic based on role
            const [selectedUnit, setSelectedUnit] = usePersistentState('cronogramaUnit', user.role === 'unidade' ? user.id : ""); 
            const [dateMode, setDateMode] = usePersistentState('cronogramaMode', 'single'); 
            const [singleDate, setSingleDate] = usePersistentState('cronogramaSingle', DateUtils.toISODate(new Date()));
            const [rangeStart, setRangeStart] = usePersistentState('cronogramaStart', DateUtils.toISODate(new Date()));
            const [rangeEnd, setRangeEnd] = usePersistentState('cronogramaEnd', DateUtils.toISODate(new Date()));
            const [selectedMonth, setSelectedMonth] = usePersistentState('cronogramaMonth', new Date().toISOString().substring(0, 7));
            const [searchTerm, setSearchTerm] = useState("");
            const debouncedSearch = useDebounce(searchTerm, 300);
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [editingClass, setEditingClass] = useState(null);
            const [formData, setFormData] = useState({ unidadeId: '', modalidadeId: '', professor: '', valor: 0, hora: '07:00', dias: [], duracao: 60 });
            const [loading, setLoading] = useState(false);
            const [formErrors, setFormErrors] = useState({});
            const [showConfirm, setShowConfirm] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);

            useEffect(() => {
                if (selectedUnit) {
                    setLoading(true);
                    setTimeout(() => setLoading(false), 300);
                }
            }, [selectedUnit, dateMode, singleDate, selectedMonth]);

            const availableUnits = useMemo(() => {
                if (user.role === 'mentor') return db.unidades.filter(u => u.mentorId === user.id);
                return db.unidades;
            }, [db.unidades, user]);

            const filteredClasses = useMemo(() => {
                if (!selectedUnit) return [];
                const modalidadesMap = new Map(db.modalidades.map(m => [m.id, m]));
                let classes = db.horarios.filter(h => h.unidadeId == selectedUnit);
                
                if (debouncedSearch) {
                    const lowerSearch = debouncedSearch.toLowerCase();
                    classes = classes.filter(h => {
                        const modalidade = modalidadesMap.get(h.modalidadeId);
                        return h.professor.toLowerCase().includes(lowerSearch) || 
                               modalidade?.nome.toLowerCase().includes(lowerSearch);
                    });
                }
                
                return classes.map(h => {
                    const modalidade = modalidadesMap.get(h.modalidadeId);
                    return { ...h, modalidadeNome: modalidade?.nome, modalidadeCor: modalidade?.cor };
                });
            }, [db, selectedUnit, debouncedSearch]);

            const activeTimeSlots = useMemo(() => {
                const times = new Set(filteredClasses.map(c => c.hora));
                return Array.from(times).sort();
            }, [filteredClasses]);

            const daysOfWeek = ['Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado', 'Domingo'];
            const unidadeObj = useMemo(() => db.unidades.find(u => u.id == selectedUnit), [db.unidades, selectedUnit]);
            
            const checkHoliday = (dayName) => {
                if(dateMode !== 'single') return false;
                const weekDayOfSelected = DateUtils.getDayOfWeek(singleDate);
                if(weekDayOfSelected !== dayName) return false; 
                return DateUtils.isHoliday(singleDate, db.feriados, unidadeObj);
            };

            const getAttendanceValue = (aulaId, dayName) => {
                let targetValidations = [];
                const validacoes = db.validacoes || [];
                
                if (dateMode === 'single') {
                    const weekDayOfSelected = DateUtils.getDayOfWeek(singleDate);
                    if (weekDayOfSelected !== dayName) return null; 
                    targetValidations = validacoes.filter(v => v.aulaId === aulaId && v.data === singleDate);
                } else if (dateMode === 'range') {
                    targetValidations = validacoes.filter(v => 
                        v.aulaId === aulaId && 
                        v.data >= rangeStart && 
                        v.data <= rangeEnd &&
                        DateUtils.getDayOfWeek(v.data) === dayName
                    );
                } else if (dateMode === 'month') {
                    targetValidations = validacoes.filter(v => 
                        v.aulaId === aulaId && 
                        v.data.startsWith(selectedMonth) &&
                        DateUtils.getDayOfWeek(v.data) === dayName
                    );
                }

                if (targetValidations.length === 0) return "-"; 
                if (targetValidations.length === 1) {
                    return { value: targetValidations[0].qtdAlunos, isAvg: false };
                }
                const sum = targetValidations.reduce((acc, curr) => acc + curr.qtdAlunos, 0);
                return { value: Math.round(sum / targetValidations.length), isAvg: true };
            };

            const validateForm = () => {
                const errors = {};
                if (!formData.unidadeId) errors.unidadeId = true;
                if (!formData.modalidadeId) errors.modalidadeId = true;
                if (!formData.professor) errors.professor = true;
                if (!formData.hora) errors.hora = true;
                if (formData.dias.length === 0) errors.dias = true;
                setFormErrors(errors);
                return Object.keys(errors).length === 0;
            };

            const handleSaveClass = () => {
                if (!validateForm()) {
                    return addToast("Preencha todos os campos obrigat√≥rios marcados em vermelho.", "error");
                }
                
                const newDb = { ...db };
                const classData = { ...formData, unidadeId: parseInt(formData.unidadeId), modalidadeId: parseInt(formData.modalidadeId), valor: parseFloat(formData.valor) };
                if (editingClass) {
                    newDb.horarios = newDb.horarios.map(h => h.id === editingClass.id ? { ...classData, id: h.id } : h);
                    addToast("Aula atualizada com sucesso!");
                } else {
                    const newId = Date.now();
                    newDb.horarios.push({ ...classData, id: newId });
                    addToast("Aula criada com sucesso!");
                }
                setDb(newDb);
                setShowCreateModal(false);
                setEditingClass(null);
            };

            const handleDeleteClass = () => {
                 if (itemToDelete) {
                    const newDb = { ...db, horarios: db.horarios.filter(h => h.id !== itemToDelete) };
                    setDb(newDb);
                    addToast("Aula removida!");
                    setItemToDelete(null);
                    setShowConfirm(false);
                    setShowCreateModal(false); 
                 }
            };
            
            const confirmDelete = (id) => {
                setItemToDelete(id);
                setShowConfirm(true);
            };

            const handleDuplicateClass = (cls) => { const newId = Date.now(); const duplicated = { ...cls, id: newId, professor: cls.professor + " (C√≥pia)" }; const newDb = { ...db, horarios: [...db.horarios, duplicated] }; setDb(newDb); addToast("Aula duplicada!"); setEditingClass(null); };
            const openCreateModal = () => { setFormData({ unidadeId: selectedUnit, modalidadeId: '', professor: '', valor: '', hora: '07:00', dias: [], duracao: 60 }); setFormErrors({}); setEditingClass(null); setShowCreateModal(true); };
            const openEditModal = (cls) => { setFormData({ ...cls }); setFormErrors({}); setEditingClass(cls); setShowCreateModal(true); };
            const toggleDay = (day) => { setFormData(prev => { if (prev.dias.includes(day)) return { ...prev, dias: prev.dias.filter(d => d !== day) }; return { ...prev, dias: [...prev.dias, day] }; }); };

            return (
                <div className="p-6 space-y-6 fade-in h-full flex flex-col">
                    <ConfirmModal 
                        isOpen={showConfirm} 
                        onClose={() => setShowConfirm(false)} 
                        onConfirm={handleDeleteClass} 
                        title="Excluir Aula" 
                        message="Tem certeza que deseja excluir esta aula? Esta a√ß√£o n√£o pode ser desfeita." 
                    />
                    <div className="glass-panel p-5 flex flex-col gap-4">
                        <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                            <div className="w-full md:w-1/4">
                                <label className="text-[10px] font-bold text-slate-500 uppercase">Unidade</label>
                                {user.role === 'unidade' ? (
                                    <div className="w-full p-2 border rounded text-sm bg-slate-100 text-slate-600 font-bold">
                                        {db.unidades.find(u => u.id == user.id)?.nome || "Unidade n√£o encontrada"}
                                    </div>
                                ) : (
                                    <select className={`w-full p-2 border rounded text-sm bg-slate-50 ${formErrors.unidadeId ? 'input-error' : ''}`} value={selectedUnit} onChange={e => { setSelectedUnit(e.target.value); if(!formData.unidadeId) setFormData({...formData, unidadeId: e.target.value}); }}>
                                        <option value="">Selecione a Unidade...</option>
                                        {availableUnits.map(u => <option key={u.id} value={u.id}>{u.nome}</option>)}
                                    </select>
                                )}
                            </div>
                            <div className="flex-1 flex gap-2 items-end">
                                <div className="flex bg-slate-100 rounded p-1 h-10 items-center">
                                    <button onClick={() => setDateMode('single')} className={`px-3 py-1 rounded-l text-xs font-bold uppercase transition-colors ${dateMode === 'single' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Dia</button>
                                    <button onClick={() => setDateMode('range')} className={`px-3 py-1 rounded-r text-xs font-bold uppercase transition-colors ${dateMode === 'range' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>Per√≠odo</button>
                                    <button onClick={() => setDateMode('month')} className={`px-3 py-1 rounded-r text-xs font-bold uppercase transition-colors ${dateMode === 'month' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>M√™s</button>
                                </div>
                                
                                {dateMode === 'single' && <input type="date" className="p-2 border rounded text-sm h-10" value={singleDate} onChange={e => setSingleDate(e.target.value)} />}
                                
                                {dateMode === 'range' && (
                                    <div className="flex items-center gap-1">
                                        <input type="date" className="p-2 border rounded text-sm h-10" value={rangeStart} onChange={e => setRangeStart(e.target.value)} />
                                        <span className="text-slate-400">-</span>
                                        <input type="date" className="p-2 border rounded text-sm h-10" value={rangeEnd} onChange={e => setRangeEnd(e.target.value)} />
                                    </div>
                                )}
                                
                                {dateMode === 'month' && (
                                    <input type="month" className="p-2 border rounded text-sm h-10" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)} />
                                )}
                            </div>
                            <div className="w-full md:w-1/4"><label className="text-[10px] font-bold text-slate-500 uppercase">Pesquisar</label><div className="relative"><Icon name="search" className="absolute left-2 top-2.5 w-4 h-4 text-slate-400" /><input type="text" className="w-full pl-8 p-2 border rounded text-sm h-10" placeholder="Aula, Prof..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div></div>
                            <button onClick={openCreateModal} disabled={!selectedUnit} className={`h-10 px-4 rounded font-bold text-xs uppercase flex items-center gap-2 ${selectedUnit ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-slate-200 text-slate-400 cursor-not-allowed'} transition-all duration-300 hover:shadow-md active:scale-95`}><Icon name="plus" className="w-4 h-4 text-current" /> Nova Aula</button>
                        </div>
                    </div>

                    <div className="glass-panel flex-1 overflow-hidden relative min-h-[500px] flex flex-col">
                        {!selectedUnit ? (
                            <div className="absolute inset-0 flex items-center justify-center text-slate-400 flex-col"><Icon name="calendar" className="w-12 h-12 mb-2 opacity-20" /><p>Selecione uma unidade para visualizar o cronograma.</p></div>
                        ) : filteredClasses.length === 0 && !searchTerm ? (
                             <div className="absolute inset-0 flex items-center justify-center text-slate-400 flex-col"><Icon name="plus-circle" className="w-12 h-12 mb-2 opacity-20" /><p>Nenhuma aula encontrada. Clique em "Nova Aula" para come√ßar.</p></div>
                        ) : loading ? (
                            <div className="p-8 space-y-4">
                                <Skeleton className="h-8 w-full" />
                                <Skeleton className="h-32 w-full" />
                                <Skeleton className="h-32 w-full" />
                            </div>
                        ) : (
                            <div className="schedule-container h-full">
                                <div className="schedule-header-cell z-30 left-0 bg-white">Hora</div>
                                {daysOfWeek.map(day => {
                                    const isHoliday = checkHoliday(day);
                                    return <div key={day} className={`schedule-header-cell ${dateMode === 'single' && DateUtils.getDayOfWeek(singleDate) === day ? 'bg-blue-50 text-blue-600 border-b-blue-500' : ''} ${isHoliday ? 'holiday' : ''}`}>{day} {isHoliday && <span className="block text-[8px] font-normal mt-1 bg-red-100 text-red-600 px-1 rounded inline-block">FERIADO</span>}</div>;
                                })}

                                {activeTimeSlots.map(timeSlot => {
                                    return (
                                        <React.Fragment key={timeSlot}>
                                            <div className="schedule-time-cell">{timeSlot}</div>
                                            {daysOfWeek.map(day => {
                                                const classesInSlot = filteredClasses.filter(c => c.dias.includes(day) && c.hora === timeSlot);
                                                return (
                                                    <div key={`${day}-${timeSlot}`} className={`schedule-cell ${checkHoliday(day) ? 'holiday-bg' : ''}`}>
                                                        {classesInSlot.map(cls => {
                                                            const attendanceData = getAttendanceValue(cls.id, day);
                                                            const displayVal = attendanceData !== null && typeof attendanceData === 'object' ? attendanceData.value : attendanceData;
                                                            const isAvg = attendanceData !== null && typeof attendanceData === 'object' ? attendanceData.isAvg : false;
                                                            const shouldShowBadge = attendanceData !== null;

                                                            return (
                                                                <div key={cls.id} onClick={() => openEditModal(cls)} className="relative group mb-2 rounded-r-md bg-white border-l-[6px] shadow-sm hover:shadow-lg hover:-translate-y-0.5 transition-all cursor-pointer p-2 flex flex-col justify-between min-h-[60px]" style={{ borderLeftColor: cls.modalidadeCor, backgroundColor: cls.modalidadeCor + '0D' }}>
                                                                    <div className="font-bold text-[11px] leading-tight mb-1 uppercase tracking-wide" style={{ color: cls.modalidadeCor }}>{cls.modalidadeNome}</div>
                                                                    <div className="flex items-center gap-1 mb-1">
                                                                        <Avatar name={cls.professor} size="sm" />
                                                                        <span className="text-[10px] font-bold text-slate-600 truncate uppercase">{cls.professor}</span>
                                                                    </div>
                                                                    {shouldShowBadge && (<div className={`self-start text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-1 ${displayVal === "0" || displayVal === "-" ? 'bg-slate-100 text-slate-400' : 'bg-white text-slate-700 shadow-sm border border-slate-100'}`}><Icon name="users" className="w-3 h-3" />{displayVal}{isAvg && <span className="text-[8px] text-slate-400 ml-1">M√âD</span>}</div>)}
                                                                    <div className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity"><div className="bg-white p-1 rounded-full shadow border border-slate-100 text-blue-500"><Icon name="edit-2" className="w-3 h-3" /></div></div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })}
                                        </React.Fragment>
                                    );
                                })}
                                {activeTimeSlots.length === 0 && <div className="col-span-8 p-10 text-center text-slate-400">Nenhuma aula cadastrada.</div>}
                            </div>
                        )}
                    </div>

                    {/* Modal Create/Edit */}
                    {showCreateModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4 animate-fade-in">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="p-4 border-b bg-slate-50 flex justify-between items-center"><h3 className="font-bold text-lg text-slate-700">{editingClass ? "Editar Aula" : "Nova Aula Coletiva"}</h3><button onClick={() => { setShowCreateModal(false); setEditingClass(null); }} className="text-slate-400 hover:text-red-500"><Icon name="x" className="w-5 h-5" /></button></div>
                                <div className="p-6 overflow-y-auto space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Unidade</label>
                                            <select className={`w-full p-2 border rounded text-sm bg-slate-50 ${formErrors.unidadeId ? 'input-error' : ''}`} disabled={true} value={formData.unidadeId}>
                                                {db.unidades.map(u => <option key={u.id} value={u.id}>{u.nome}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Modalidade</label>
                                            <select className={`w-full p-2 border rounded text-sm ${formErrors.modalidadeId ? 'input-error' : ''}`} value={formData.modalidadeId} onChange={e => setFormData({...formData, modalidadeId: e.target.value})}>
                                                <option value="">Selecione...</option>
                                                {db.modalidades.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Professor</label>
                                        <input type="text" className={`w-full p-2 border rounded text-sm ${formErrors.professor ? 'input-error' : ''}`} placeholder="Nome do Professor" value={formData.professor} onChange={e => setFormData({...formData, professor: e.target.value})} />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Hor√°rio</label>
                                            <input type="time" className={`w-full p-2 border rounded text-sm ${formErrors.hora ? 'input-error' : ''}`} value={formData.hora} onChange={e => setFormData({...formData, hora: e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Valor Hora/Aula (R$)</label>
                                            <input type="number" className="w-full p-2 border rounded text-sm" value={formData.valor} onChange={e => setFormData({...formData, valor: e.target.value})} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className={`block text-xs font-bold text-slate-500 uppercase mb-2 ${formErrors.dias ? 'text-red-500' : ''}`}>Dias da Semana</label>
                                        <div className="flex flex-wrap gap-2">
                                            {daysOfWeek.map(day => (
                                                <button 
                                                    key={day} 
                                                    onClick={() => toggleDay(day)}
                                                    className={`px-3 py-1 rounded text-xs font-bold border transition-colors ${formData.dias.includes(day) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200 hover:border-blue-300'} ${formErrors.dias && !formData.dias.includes(day) ? 'border-red-200' : ''}`}
                                                >
                                                    {day.substring(0,3)}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-slate-50 flex justify-between items-center">
                                    <div>{editingClass && (<div className="flex gap-2"><button onClick={() => confirmDelete(editingClass.id)} className="text-red-500 hover:bg-red-50 px-3 py-2 rounded text-xs font-bold uppercase flex items-center gap-1"><Icon name="trash-2" className="w-4 h-4"/> Excluir</button><button onClick={() => handleDuplicateClass(formData)} className="text-blue-500 hover:bg-blue-50 px-3 py-2 rounded text-xs font-bold uppercase flex items-center gap-1"><Icon name="copy" className="w-4 h-4"/> Duplicar</button></div>)}</div>
                                    <div className="flex gap-2"><button onClick={() => { setShowCreateModal(false); setEditingClass(null); }} className="px-4 py-2 text-slate-500 font-bold uppercase text-xs">Cancelar</button><button onClick={handleSaveClass} className="px-6 py-2 bg-green-600 text-white rounded font-bold uppercase text-xs hover:bg-green-700 shadow-lg shadow-green-200">Salvar Aula</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            ); 
        };
        
        const ValidacaoView = ({ db, setDb, user }) => {
            const { addToast } = useToast();
            const [date, setDate] = useState(DateUtils.toISODate(new Date()));
            // Default filter logic based on role
            const [filterUnit, setFilterUnit] = useState(user.role === 'unidade' ? user.id : 'TODAS');
            const [filterMod, setFilterMod] = useState('TODAS');
            const [inputValues, setInputValues] = useState({});
            const [errors, setErrors] = useState({});

            const availableUnits = useMemo(() => {
                return filterByUserPermission(db.unidades, user);
            }, [db.unidades, user]);

            const dayOfWeek = useMemo(() => DateUtils.getDayOfWeek(date), [date]);

            const dailyClasses = useMemo(() => {
                return db.horarios.filter(h => {
                    if (!h.dias.includes(dayOfWeek)) return false;
                    if (filterUnit !== 'TODAS' && h.unidadeId != filterUnit) return false;
                    if (filterMod !== 'TODAS' && h.modalidadeId != filterMod) return false;
                    // Extra security layer for 'unidade' role, although UI prevents selection
                    if (user.role === 'unidade' && h.unidadeId != user.id) return false;
                    if (user.role === 'mentor' && db.unidades.find(u => u.id == h.unidadeId)?.mentorId != user.id) return false;
                    return true;
                });
            }, [date, filterUnit, filterMod, db.horarios, dayOfWeek, user, db.unidades]);

            const handleValidate = (aulaId, professor, unitName) => {
                const qtd = inputValues[aulaId];
                if (!qtd) {
                    setErrors({ ...errors, [aulaId]: true });
                    return addToast("Digite a quantidade de alunos.", "error");
                }
                
                const newValidation = { id: Date.now(), aulaId: aulaId, data: date, qtdAlunos: parseInt(qtd), timestamp: new Date().toISOString() };
                const validacoesArr = db.validacoes || [];
                const newDb = { ...db, validacoes: [...validacoesArr.filter(v => !(v.aulaId === aulaId && v.data === date)), newValidation] };
                setDb(newDb);
                setErrors({ ...errors, [aulaId]: false }); 
                addToast(`Aula de ${professor} validada com ${qtd} alunos!`, "success");
            };

            return (
                <div className="p-6 space-y-6 fade-in">
                    <div className="glass-panel p-5"><div className="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"><div><label className="text-[10px] font-bold text-slate-500 uppercase flex justify-between">Data da Valida√ß√£o <span className="text-blue-600">{dayOfWeek}</span></label><input type="date" className="w-full p-2 border rounded text-sm h-10" value={date} onChange={e => setDate(e.target.value)} /></div>
                    
                    <div><label className="text-[10px] font-bold text-slate-500 uppercase">Unidade</label>
                    {user.role === 'unidade' ? (
                        <div className="w-full p-2 border rounded text-sm bg-slate-100 text-slate-600 font-bold h-10 flex items-center">
                            {db.unidades.find(u => u.id == user.id)?.nome || "Unidade"}
                        </div>
                    ) : (
                        <select className="w-full p-2 border rounded text-sm h-10 uppercase" value={filterUnit} onChange={e => setFilterUnit(e.target.value)}><option value="TODAS">TODAS</option>{availableUnits.map(u => <option key={u.id} value={u.id}>{u.nome}</option>)}</select>
                    )}
                    </div>
                    
                    <div><label className="text-[10px] font-bold text-slate-500 uppercase">Modalidade</label><select className="w-full p-2 border rounded text-sm h-10 uppercase" value={filterMod} onChange={e => setFilterMod(e.target.value)}><option value="TODAS">TODAS</option>{db.modalidades.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}</select></div></div></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {dailyClasses.map(h => {
                            const u = db.unidades.find(x => x.id == h.unidadeId);
                            const m = db.modalidades.find(x => x.id == h.modalidadeId);
                            const existingVal = (db.validacoes || []).find(v => v.aulaId === h.id && v.data === date);
                            const isDone = !!existingVal;
                            return (<div key={h.id} className={`glass-panel p-5 border-l-4 ${isDone ? 'border-green-500 bg-green-50/20' : 'border-blue-500'} hover:shadow-lg transition-all group`}><div className="flex justify-between items-start mb-3"><div><h4 className="font-bold text-slate-800 uppercase text-sm">{u?.nome}</h4><p className="text-xs text-slate-500">{m?.nome}</p></div><div className="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">{h.hora}</div></div><div className="flex justify-between items-center text-xs text-slate-600 mb-4"><span className="uppercase font-semibold"><Icon name="user" className="w-3 h-3 inline mr-1"/> {h.professor}</span>{isDone && <span className="text-green-600 font-bold flex items-center"><Icon name="check" className="w-3 h-3 mr-1"/> {existingVal.qtdAlunos} Alunos</span>}</div><div className="flex gap-2">
                                <input 
                                    type="number" 
                                    className={`w-20 p-2 border rounded text-sm text-center ${errors[h.id] ? 'input-error' : ''}`}
                                    placeholder="Qtd" 
                                    defaultValue={existingVal?.qtdAlunos || ''} 
                                    onChange={e => {
                                        setInputValues({...inputValues, [h.id]: e.target.value});
                                        if (e.target.value) setErrors({...errors, [h.id]: false});
                                    }} 
                                />
                                <button onClick={() => handleValidate(h.id, h.professor, u.nome)} className={`flex-1 ${isDone ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'} text-white text-xs font-bold py-2 rounded transition-colors flex items-center justify-center gap-2`}>{isDone ? "ATUALIZAR" : "VALIDAR"}</button></div></div>);
                        })}
                    </div>
                    {dailyClasses.length === 0 && (<div className="text-center text-slate-400 py-10 glass-panel flex flex-col items-center"><Icon name="calendar-x" className="w-12 h-12 mb-2 opacity-20" /><p>Nenhuma aula programada para <span className="font-bold text-blue-500">{dayOfWeek}</span>.</p><p className="text-xs mt-1">Verifique o Cronograma se voc√™ acabou de criar a unidade.</p></div>)}
                </div>
            );
        };

        const Valida√ß√£oColetivaView = ({ db, setDb, user }) => { 
            const { addToast } = useToast();
            const [filters, setFilters] = usePersistentState('validacaoColetivaFilters', { date: new Date().toISOString().split('T')[0], filterMode: 'day', startDate: new Date().toISOString().split('T')[0], endDate: new Date().toISOString().split('T')[0] });
            const [activeSubTab, setActiveSubTab] = usePersistentState('validacaoColetivaTab', 'ranking');
            const [searchTermStatus, setSearchTermStatus] = useState("");
            const [searchTermDetail, setSearchTermDetail] = useState("");
            const [loading, setLoading] = useState(false);

             // Simula√ß√£o de Loading
             useEffect(() => {
                setLoading(true);
                const timer = setTimeout(() => setLoading(false), 400);
                return () => clearTimeout(timer);
            }, [filters, activeSubTab]);

            // --- L√≥gica de Valida√ß√£o Coletiva (Ajustado com USER) ---
            const dadosAdesao = useMemo(() => {
                return BusinessLogic.calcularQualidade(db, filters.filterMode, filters.startDate, filters.endDate, user);
            }, [db, filters, user]);

            // Agrupa por Mentor para o Ranking
            const rankingMentores = useMemo(() => {
                const mentoresMap = {};
                dadosAdesao.forEach(u => {
                    if (!mentoresMap[u.mentorId]) {
                        mentoresMap[u.mentorId] = { id: u.mentorId, name: u.mentorName, totalUnidades: 0, somaPercentual: 0, unitsList: [] };
                    }
                    mentoresMap[u.mentorId].totalUnidades++;
                    mentoresMap[u.mentorId].somaPercentual += u.percentual;
                    mentoresMap[u.mentorId].unitsList.push(u);
                });
                // Ordena√ß√£o por m√©dia de ades√£o (maior para menor)
                // CORRE√á√ÉO DE L√ìGICA: Previne NaN com divis√£o por zero
                return Object.values(mentoresMap).map(m => ({
                    ...m,
                    mediaAdesao: m.totalUnidades > 0 ? Math.round(m.somaPercentual / m.totalUnidades) : 0
                })).sort((a,b) => b.mediaAdesao - a.mediaAdesao);
            }, [dadosAdesao]);

            const summary = useMemo(() => {
                const total = dadosAdesao.length;
                // Considera validada se status for Excelente (>= 90%) ou Aten√ß√£o (>= 60%) dependendo do crit√©rio, 
                // mas aqui vamos usar o status "Excelente" como 100% validado para o KPI de sucesso total
                const validated = dadosAdesao.filter(u => u.percentual >= 90).length; 
                const pending = total - validated;
                return { total, validated, pending };
            }, [dadosAdesao]);

            const sortedStatusList = useMemo(() => {
                let list = [...dadosAdesao];
                if (searchTermStatus) {
                    list = list.filter(u => u.nome.toLowerCase().includes(searchTermStatus.toLowerCase()) || u.mentorName.toLowerCase().includes(searchTermStatus.toLowerCase()));
                }
                // Ordena√ß√£o: Pendentes primeiro para a√ß√£o
                return list.sort((a,b) => a.percentual - b.percentual);
            }, [dadosAdesao, searchTermStatus]);

            // Filtragem para o Detalhamento (Aba 3)
            const filteredMentorsDetail = useMemo(() => {
                if (!searchTermDetail) return rankingMentores;
                return rankingMentores.filter(m => 
                    m.name.toLowerCase().includes(searchTermDetail.toLowerCase()) || 
                    m.unitsList.some(u => u.nome.toLowerCase().includes(searchTermDetail.toLowerCase()))
                );
            }, [rankingMentores, searchTermDetail]);

            return (
                <div className="p-6 space-y-6 fade-in">
                    {/* 3.1 Cabe√ßalho e Filtro Global */}
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-200 pb-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Valida√ß√£o Coletiva</h2>
                            <p className="text-sm text-slate-500">Acompanhamento di√°rio e por per√≠odo de ades√£o</p>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                             <span className="text-xs font-bold text-slate-500 uppercase mr-2">Data Referente:</span>
                             <select className="p-2 text-sm border rounded bg-white" value={filters.filterMode} onChange={e => setFilters({...filters, filterMode: e.target.value})}>
                                 <option value="day">Data</option>
                                 <option value="range">Per√≠odo</option>
                                 <option value="month">M√™s</option>
                             </select>
                             
                             {filters.filterMode === 'day' && (
                                <input type="date" className="border rounded p-2 text-sm" value={filters.startDate} onChange={e => setFilters({ ...filters, startDate: e.target.value, endDate: e.target.value })} />
                             )}
                             {filters.filterMode === 'range' && (
                                <>
                                    <input type="date" className="border rounded p-2 text-sm" value={filters.startDate} onChange={e => setFilters({ ...filters, startDate: e.target.value })} />
                                    <span className="text-slate-400">-</span>
                                    <input type="date" className="border rounded p-2 text-sm" value={filters.endDate} onChange={e => setFilters({ ...filters, endDate: e.target.value })} />
                                </>
                             )}
                             {filters.filterMode === 'month' && (
                                <input type="month" className="border rounded p-2 text-sm" value={filters.startDate.substring(0, 7)} onChange={e => {
                                    const val = e.target.value; // YYYY-MM
                                    setFilters({ ...filters, startDate: val + '-01', endDate: val + '-01' }); 
                                }} />
                             )}
                        </div>
                    </div>

                    {/* 3.2 Cards de Resumo */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase">Total de Unidades</p><p className="text-2xl font-bold text-slate-800">{summary.total}</p></div>
                            <div className="p-3 bg-blue-50 text-blue-600 rounded-lg"><Icon name="activity" className="w-6 h-6"/></div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            {/* MELHORIA DE ACESSIBILIDADE: text-green-600 -> text-green-700 */}
                            <div><p className="text-xs font-bold text-slate-400 uppercase">Unidades Validadas</p><p className="text-2xl font-bold text-green-700">{summary.validated}</p></div>
                            <div className="p-3 bg-green-50 text-green-600 rounded-lg"><Icon name="check-circle" className="w-6 h-6"/></div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div><p className="text-xs font-bold text-slate-400 uppercase">Unidades Pendentes</p><p className="text-2xl font-bold text-red-500">{summary.pending}</p></div>
                            <div className="p-3 bg-red-50 text-red-500 rounded-lg"><Icon name="alert-circle" className="w-6 h-6"/></div>
                        </div>
                    </div>

                    {/* Navega√ß√£o de Subabas */}
                    <div className="flex gap-4 border-b border-slate-200">
                        <button onClick={() => setActiveSubTab('ranking')} className={`pb-3 text-sm font-bold uppercase transition-colors flex items-center gap-2 ${activeSubTab === 'ranking' ? 'border-b-2 border-blue-600 text-blue-600 -mb-[2px]' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="bar-chart-2" className="w-4 h-4" /> Ranking de Valida√ß√£o</button>
                        <button onClick={() => setActiveSubTab('status')} className={`pb-3 text-sm font-bold uppercase transition-colors flex items-center gap-2 ${activeSubTab === 'status' ? 'border-b-2 border-blue-600 text-blue-600 -mb-[2px]' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="list" className="w-4 h-4" /> Status Individual</button>
                        <button onClick={() => setActiveSubTab('detalhamento')} className={`pb-3 text-sm font-bold uppercase transition-colors flex items-center gap-2 ${activeSubTab === 'detalhamento' ? 'border-b-2 border-blue-600 text-blue-600 -mb-[2px]' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="user" className="w-4 h-4" /> Detalhamento por Mentor</button>
                    </div>

                    {/* Conte√∫do das Subabas */}
                    <div className="glass-panel p-6 min-h-[400px]">
                        
                        {loading ? (
                             <div className="space-y-4">
                                <Skeleton className="h-12 w-full" />
                                <Skeleton className="h-12 w-full" />
                                <Skeleton className="h-12 w-full" />
                            </div>
                        ) : activeSubTab === 'ranking' ? (
                            <div className="space-y-4 animate-fade-in">
                                {rankingMentores.length === 0 ? <EmptyState message="Nenhum dado encontrado para o filtro selecionado." /> :
                                rankingMentores.map((mentor, index) => (
                                    <div key={mentor.id} className="border border-slate-100 rounded-xl p-3 bg-white hover:shadow-sm transition-all flex items-center justify-between group relative">
                                        <div className="flex items-center gap-3 w-1/3">
                                            <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold text-white ${index === 0 ? 'bg-yellow-400' : 'bg-slate-400'}`}>{index + 1}</span>
                                            <div>
                                                <h4 className="font-bold text-slate-700 text-sm">{mentor.name}</h4>
                                                <p className="text-[10px] text-slate-400">{mentor.validatedUnits}/{mentor.totalUnits} unidades validadas</p>
                                            </div>
                                        </div>
                                        
                                        <div className="w-1/3 px-4 relative">
                                            <div className="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
                                                <div className={`h-full transition-all duration-500 ${mentor.mediaAdesao === 100 ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${mentor.mediaAdesao}%` }}></div>
                                            </div>
                                            {/* OTIMIZA√á√ÉO DE UI: Tooltip com posicionamento robusto (z-50 e absolute) */}
                                            {mentor.mediaAdesao < 100 && (
                                                <div className="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-48 bg-slate-800 text-white text-xs rounded p-2 shadow-lg z-50 hidden group-hover:block pointer-events-none">
                                                    <p className="font-bold border-b border-slate-600 pb-1 mb-1 text-yellow-400">Unidades Pendentes:</p>
                                                    <ul className="max-h-32 overflow-y-auto">
                                                        {mentor.unitsList.filter(u => u.status !== 'Excelente').map(u => (
                                                            <li key={u.id} className="mb-1 truncate">
                                                                <span className="font-bold text-white">{u.nome}</span>
                                                                {u.datasPendentes.length > 0 && (
                                                                    <span className="block text-[10px] text-slate-300 ml-2">Dias: {u.datasPendentes.join(', ')}</span>
                                                                )}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                    <div className="absolute top-full left-1/2 transform -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
                                                </div>
                                            )}
                                        </div>

                                        <div className="w-1/3 text-right">
                                            <span className={`text-sm font-bold px-2 py-1 rounded ${mentor.mediaAdesao === 100 ? 'bg-green-50 text-green-600' : 'bg-slate-50 text-slate-600'}`}>{mentor.mediaAdesao}%</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : activeSubTab === 'status' ? (
                            <div className="animate-fade-in">
                                <div className="mb-4">
                                    <div className="relative">
                                        <Icon name="search" className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                        <input 
                                            type="text" 
                                            className="w-full pl-10 p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-100 outline-none" 
                                            placeholder="Buscar unidade ou mentor..." 
                                            value={searchTermStatus}
                                            onChange={(e) => setSearchTermStatus(e.target.value)}
                                        />
                                    </div>
                                </div>
                                {sortedStatusList.length > 0 && sortedStatusList.every(u => u.percentual === 100) ? (
                                     <div className="flex flex-col items-center justify-center p-12 bg-green-50 border border-green-200 rounded-xl text-green-700 fade-in">
                                        <div className="bg-white p-4 rounded-full mb-4 shadow-sm"><Icon name="check-circle" className="w-12 h-12 text-green-500"/></div>
                                        <h3 className="font-bold text-xl mb-1">Tudo Certo!</h3>
                                        <p className="text-sm text-green-600">Nenhuma pend√™ncia encontrada no per√≠odo selecionado.</p>
                                     </div>
                                ) : (
                                    <div className="overflow-x-auto border rounded-xl shadow-sm bg-white">
                                        <table className="w-full text-left text-xs">
                                            <thead className="bg-slate-50 text-slate-500 font-bold border-b border-slate-200 uppercase tracking-wider">
                                                <tr>
                                                    <th className="p-4">Unidade</th>
                                                    <th className="p-4 text-center">Status</th>
                                                    <th className="p-4">√öltima Intera√ß√£o (Audit)</th>
                                                    <th className="p-4 text-right">Respons√°vel</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {sortedStatusList.length === 0 ? (
                                                    <tr><td colSpan="4" className="p-8 text-center text-slate-400">Nenhuma unidade encontrada.</td></tr>
                                                ) : (
                                                    sortedStatusList.map(u => (
                                                        <tr key={u.id} className="hover:bg-slate-50 transition-colors group">
                                                            <td className="p-4">
                                                                <div className="flex flex-col">
                                                                    <span className="font-bold text-slate-700 text-sm">{u.nome}</span>
                                                                    <span className="text-[10px] text-slate-400 flex items-center gap-1"><Icon name="user" className="w-3 h-3"/> {u.mentorName}</span>
                                                                </div>
                                                            </td>
                                                            <td className="p-4 text-center">
                                                                {u.percentual === 100 ? (
                                                                    <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full font-bold bg-green-100 text-green-700 text-[10px] uppercase border border-green-200">
                                                                        <Icon name="check" className="w-3 h-3" /> 100% Validado
                                                                    </span>
                                                                ) : (
                                                                    <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full font-bold bg-red-100 text-red-700 text-[10px] uppercase border border-red-200 animate-pulse">
                                                                        <Icon name="alert-circle" className="w-3 h-3" /> Pendente ({u.pendencias})
                                                                    </span>
                                                                )}
                                                            </td>
                                                            <td className="p-4 font-mono text-slate-500 text-xs">
                                                                {u.lastValidationTime ? (
                                                                    <div className="flex items-center gap-2">
                                                                        <div className="p-1.5 bg-blue-50 text-blue-600 rounded"><Icon name="calendar" className="w-3 h-3"/></div>
                                                                        <span>{DateUtils.formatDateTimeBr(u.lastValidationTime)}</span>
                                                                    </div>
                                                                ) : (
                                                                    <span className="text-slate-300 italic">Sem registros</span>
                                                                )}
                                                            </td>
                                                            <td className="p-4 text-right">
                                                                {u.lastValidationTime ? (
                                                                    <span className="inline-flex items-center gap-1.5 px-2 py-1 bg-slate-100 text-slate-600 rounded text-[10px] font-bold border border-slate-200 uppercase">
                                                                        <Icon name="shield" className="w-3 h-3"/> Acesso Local
                                                                    </span>
                                                                ) : (
                                                                    <span className="text-slate-300">-</span>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                 <div className="mb-4">
                                    <div className="relative">
                                        <Icon name="search" className="absolute left-3 top-2.5 w-4 h-4 text-slate-400" />
                                        <input 
                                            type="text" 
                                            className="w-full pl-10 p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-100 outline-none" 
                                            placeholder="Filtrar card de mentor..." 
                                            value={searchTermDetail}
                                            onChange={(e) => setSearchTermDetail(e.target.value)}
                                        />
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {filteredMentorsDetail.length === 0 ? <div className="col-span-2"><EmptyState message="Nenhum mentor encontrado." /></div> :
                                    filteredMentorsDetail.map(mentor => (
                                        <div key={mentor.id} className="bg-white border border-slate-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-all">
                                            <div className="border-b border-slate-100 pb-3 mb-3 flex justify-between items-center">
                                                <h4 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                                                    <Avatar name={mentor.name} size="sm" />
                                                    {mentor.name}
                                                </h4>
                                                <span className={`text-sm font-bold px-2 py-1 rounded ${mentor.mediaAdesao >= 90 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>{mentor.mediaAdesao}%</span>
                                            </div>
                                            <div className="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar">
                                                {mentor.unitsList.map(u => (
                                                    <div key={u.id} className="flex justify-between items-center text-sm p-2 rounded hover:bg-slate-50">
                                                        <span className="text-slate-600 font-medium">{u.nome}</span>
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-xs text-slate-400">{u.atividadesRealizadas}/{u.atividadesEsperadas}</span>
                                                            <div className={`w-2 h-2 rounded-full ${u.status === 'OK' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            ); 
        };

        // ==========================================
        // 5. TELAS DE CONFIGURA√á√ÉO (RESTAURADO)
        // ==========================================

        const MentorTab = ({ db, setDb, addToast }) => {
            const [nome, setNome] = useState("");
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nome.trim()) return addToast("Nome √© obrigat√≥rio.", "error");

                const newMentores = [...db.mentores];
                
                if (editingId) {
                    const index = newMentores.findIndex(m => m.id === editingId);
                    if (index > -1) {
                        newMentores[index] = { ...newMentores[index], nome };
                        addToast("Mentor atualizado com sucesso!", "success");
                    }
                } else {
                    newMentores.push({ id: Date.now(), nome, usar: true }); // Default usar: true
                    addToast("Mentor adicionado com sucesso!", "success");
                }

                setDb({ ...db, mentores: newMentores });
                setNome("");
                setEditingId(null);
            };

            const handleEdit = (mentor) => {
                setNome(mentor.nome);
                setEditingId(mentor.id);
            };

            const handleDelete = (id) => {
                if (window.confirm("Tem certeza que deseja excluir este mentor?")) {
                    const newMentores = db.mentores.filter(m => m.id !== id);
                    setDb({ ...db, mentores: newMentores });
                    addToast("Mentor exclu√≠do.", "success");
                    
                    if (editingId === id) {
                        setEditingId(null);
                        setNome("");
                    }
                }
            };

            const handleCancel = () => {
                setEditingId(null);
                setNome("");
            };

            return (
                <div className="space-y-6">
                    {/* Formul√°rio */}
                    <div className={`p-5 rounded-xl border transition-all ${editingId ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                                <Icon name={editingId ? "edit-3" : "user-plus"} className="w-4 h-4 text-blue-500"/>
                                {editingId ? "Editar Mentor" : "Novo Mentor"}
                            </h3>
                        </div>
                        
                        <form onSubmit={handleSubmit} className="flex gap-4 items-end">
                            <div className="flex-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nome do Mentor</label>
                                <input 
                                    type="text" 
                                    className="w-full p-2 border rounded-lg text-sm outline-none focus:border-blue-500 transition-colors"
                                    placeholder="Ex: Felipe Souza"
                                    value={nome}
                                    onChange={(e) => setNome(e.target.value)}
                                />
                            </div>
                            <div className="flex gap-2">
                                {editingId && (
                                    <button type="button" onClick={handleCancel} className="px-4 py-2 text-slate-500 text-xs font-bold uppercase hover:bg-slate-100 rounded-lg transition-colors">
                                        Cancelar
                                    </button>
                                )}
                                <button type="submit" className={`px-6 py-2 rounded-lg text-xs font-bold uppercase text-white shadow-md transition-transform active:scale-95 flex items-center gap-2 ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}>
                                    <Icon name={editingId ? "save" : "plus"} className="w-4 h-4" />
                                    {editingId ? "Salvar" : "Adicionar"}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* Listagem */}
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th className="p-4 text-xs font-bold text-slate-500 uppercase">Nome</th>
                                    <th className="p-4 text-xs font-bold text-slate-500 uppercase text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {db.mentores.length === 0 ? (
                                    <tr>
                                        <td colSpan="2" className="p-8 text-center text-slate-400 text-sm">
                                            Nenhum mentor cadastrado.
                                        </td>
                                    </tr>
                                ) : (
                                    db.mentores.map((mentor) => (
                                        <tr key={mentor.id} className="hover:bg-slate-50 transition-colors group">
                                            <td className="p-4">
                                                <div className="flex items-center gap-3">
                                                    <Avatar name={mentor.nome} size="sm" />
                                                    <span className="font-medium text-slate-700">{mentor.nome}</span>
                                                </div>
                                            </td>
                                            <td className="p-4 text-right">
                                                <div className="flex justify-end gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                    <button 
                                                        onClick={() => handleEdit(mentor)} 
                                                        className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" 
                                                        title="Editar"
                                                    >
                                                        <Icon name="edit-2" className="w-4 h-4" />
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDelete(mentor.id)} 
                                                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" 
                                                        title="Excluir"
                                                    >
                                                        <Icon name="trash-2" className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const UnitTab = ({ db, setDb, addToast, user }) => {
            const [form, setForm] = useState({
                nome: "",
                pais: "",
                estado: "",
                mentorId: user.role === 'mentor' ? user.id : "",
                senha: "1234"
            });
            const [editingId, setEditingId] = useState(null);

            // Helpers
            const getMentorName = (id) => db.mentores.find(m => m.id == id)?.nome || "N√£o atribu√≠do";
            const availableStates = form.pais && LOCATIONS[form.pais] ? LOCATIONS[form.pais] : [];

            // Handlers
            const handleChange = (e) => {
                const { name, value } = e.target;
                setForm(prev => ({
                    ...prev,
                    [name]: value,
                    ...(name === 'pais' ? { estado: '' } : {}) // Reset state if country changes
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!form.nome || !form.pais || !form.estado) return addToast("Preencha os campos obrigat√≥rios.", "error");

                const newUnidades = [...db.unidades];
                const payload = {
                    ...form,
                    mentorId: Number(form.mentorId)
                };

                if (editingId) {
                    const index = newUnidades.findIndex(u => u.id === editingId);
                    if (index > -1) {
                        newUnidades[index] = { ...newUnidades[index], ...payload };
                        addToast("Unidade atualizada!", "success");
                    }
                } else {
                    newUnidades.push({ id: Date.now(), ...payload });
                    addToast("Unidade criada!", "success");
                }

                setDb({ ...db, unidades: newUnidades });
                resetForm();
            };

            const handleEdit = (u) => {
                setForm({
                    nome: u.nome,
                    pais: u.pais,
                    estado: u.estado,
                    mentorId: u.mentorId,
                    senha: u.senha || "1234"
                });
                setEditingId(u.id);
            };

            const handleDelete = (id) => {
                if (window.confirm("Deseja realmente excluir esta unidade?")) {
                    setDb({ ...db, unidades: db.unidades.filter(u => u.id !== id) });
                    addToast("Unidade exclu√≠da.", "success");
                    if (editingId === id) resetForm();
                }
            };

            const resetForm = () => {
                setForm({ nome: "", pais: "", estado: "", mentorId: user.role === 'mentor' ? user.id : "", senha: "1234" });
                setEditingId(null);
            };

            return (
                <div className="space-y-6">
                    {/* FORM */}
                    <div className={`p-5 rounded-xl border transition-all ${editingId ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                                <Icon name={editingId ? "edit-3" : "building-2"} className="w-4 h-4 text-blue-500"/>
                                {editingId ? "Editar Unidade" : "Nova Unidade"}
                            </h3>
                        </div>
                        <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-3 items-end">
                            <div className="lg:col-span-3">
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Nome</label>
                                <input name="nome" value={form.nome} onChange={handleChange} className="w-full p-2 border rounded text-sm" placeholder="Ex: Unidade Centro" />
                            </div>
                            <div className="lg:col-span-2">
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Pa√≠s</label>
                                <select name="pais" value={form.pais} onChange={handleChange} className="w-full p-2 border rounded text-sm">
                                    <option value="">Selecione...</option>
                                    {Object.keys(LOCATIONS).map(p => <option key={p} value={p}>{p}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Estado</label>
                                <select name="estado" value={form.estado} onChange={handleChange} disabled={!form.pais} className="w-full p-2 border rounded text-sm">
                                    <option value="">Selecione...</option>
                                    {availableStates.map(s => <option key={s} value={s}>{s}</option>)}
                                </select>
                            </div>
                            <div className="lg:col-span-2">
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Mentor</label>
                                {user.role === 'mentor' ? (
                                    <div className="w-full p-2 border rounded text-sm bg-slate-100 text-slate-500 font-medium">
                                        {user.nome} (Voc√™)
                                    </div>
                                ) : (
                                    <select name="mentorId" value={form.mentorId} onChange={handleChange} className="w-full p-2 border rounded text-sm">
                                        <option value="">Selecione...</option>
                                        {db.mentores.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}
                                    </select>
                                )}
                            </div>
                            <div className="lg:col-span-1">
                                <label className="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Senha</label>
                                <input name="senha" value={form.senha} onChange={handleChange} className="w-full p-2 border rounded text-sm text-center font-mono" />
                            </div>
                            <div className="lg:col-span-2 flex gap-2">
                                {editingId && <button type="button" onClick={resetForm} className="px-3 py-2 text-slate-500 text-xs font-bold uppercase rounded border hover:bg-slate-50">Cancelar</button>}
                                <button type="submit" className={`flex-1 px-3 py-2 rounded text-xs font-bold uppercase text-white shadow-md transition-all ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}>
                                    {editingId ? "Salvar" : "Adicionar"}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* TABLE */}
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs font-bold">
                                <tr>
                                    <th className="p-4">Nome</th>
                                    <th className="p-4">Local</th>
                                    <th className="p-4">Mentor</th>
                                    <th className="p-4 text-center">Senha</th>
                                    <th className="p-4 text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {db.unidades.filter(u => user.role !== 'mentor' || u.mentorId === user.id).length === 0 ? (
                                    <tr><td colSpan="5" className="p-8 text-center text-slate-400">Nenhuma unidade cadastrada.</td></tr>
                                ) : (
                                    db.unidades.filter(u => user.role !== 'mentor' || u.mentorId === user.id).map(u => (
                                        <tr key={u.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 font-bold text-slate-700">{u.nome}</td>
                                            <td className="p-4 text-slate-600">
                                                <span className="bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded text-[10px] uppercase font-bold mr-2">{u.pais}</span>
                                                {u.estado}
                                            </td>
                                            <td className="p-4 text-slate-600 flex items-center gap-2">
                                                <Avatar name={getMentorName(u.mentorId)} size="sm" />
                                                <span className="text-xs">{getMentorName(u.mentorId)}</span>
                                            </td>
                                            <td className="p-4 text-center font-mono text-slate-500 bg-yellow-50/50">{u.senha}</td>
                                            <td className="p-4 text-right">
                                                <div className="flex justify-end gap-2">
                                                    <button onClick={() => handleEdit(u)} className="p-2 text-blue-500 hover:bg-blue-50 rounded transition-colors"><Icon name="edit-2" className="w-4 h-4" /></button>
                                                    <button onClick={() => handleDelete(u.id)} className="p-2 text-red-500 hover:bg-red-50 rounded transition-colors"><Icon name="trash-2" className="w-4 h-4" /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ModalidadeTab = ({ db, setDb, addToast }) => {
            const [nome, setNome] = useState("");
            const [cor, setCor] = useState("#3b82f6"); // Azul default
            const [editingId, setEditingId] = useState(null);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!nome.trim()) return addToast("O nome da modalidade √© obrigat√≥rio.", "error");

                const newModalidades = [...db.modalidades];
                const item = { nome, cor };

                if (editingId) {
                    const index = newModalidades.findIndex(m => m.id === editingId);
                    if (index > -1) {
                        newModalidades[index] = { ...newModalidades[index], ...item };
                        addToast("Modalidade atualizada!", "success");
                    }
                } else {
                    newModalidades.push({ id: Date.now(), ...item });
                    addToast("Modalidade adicionada!", "success");
                }

                setDb({ ...db, modalidades: newModalidades });
                resetForm();
            };

            const handleEdit = (mod) => {
                setNome(mod.nome);
                setCor(mod.cor || "#3b82f6");
                setEditingId(mod.id);
            };

            const handleDelete = (id) => {
                if (window.confirm("Tem certeza que deseja excluir esta modalidade?")) {
                    const newModalidades = db.modalidades.filter(m => m.id !== id);
                    setDb({ ...db, modalidades: newModalidades });
                    addToast("Modalidade exclu√≠da.", "success");
                    if (editingId === id) resetForm();
                }
            };

            const resetForm = () => {
                setNome("");
                setCor("#3b82f6");
                setEditingId(null);
            };

            return (
                <div className="space-y-6">
                    {/* FORMUL√ÅRIO DE CADASTRO/EDI√á√ÉO */}
                    <div className={`p-5 rounded-xl border transition-all shadow-sm ${editingId ? 'bg-blue-50 border-blue-200' : 'bg-white border-slate-200'}`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                                <Icon name={editingId ? "edit" : "dumbbell"} className="w-4 h-4 text-blue-500"/>
                                {editingId ? "Editar Modalidade" : "Nova Modalidade"}
                            </h3>
                        </div>

                        <form onSubmit={handleSubmit} className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Nome da Modalidade</label>
                                <input 
                                    type="text" 
                                    value={nome}
                                    onChange={(e) => setNome(e.target.value)}
                                    placeholder="Ex: Power Jump"
                                    className="w-full p-2 border rounded-lg text-sm outline-none focus:border-blue-500 transition-colors bg-white"
                                />
                            </div>
                            
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Cor de Identifica√ß√£o</label>
                                <div className="flex items-center gap-2 h-10 border rounded-lg px-2 bg-white">
                                    <input 
                                        type="color" 
                                        value={cor}
                                        onChange={(e) => setCor(e.target.value)}
                                        className="w-8 h-8 rounded cursor-pointer border-0 bg-transparent p-0"
                                        title="Escolher Cor"
                                    />
                                    <span className="text-xs font-mono text-slate-500 uppercase">{cor}</span>
                                </div>
                            </div>

                            <div className="flex gap-2 w-full md:w-auto">
                                {editingId && (
                                    <button 
                                        type="button" 
                                        onClick={resetForm}
                                        className="px-4 py-2 text-slate-500 text-xs font-bold uppercase hover:bg-slate-100 rounded-lg transition-colors border border-slate-200"
                                    >
                                        Cancelar
                                    </button>
                                )}
                                <button 
                                    type="submit" 
                                    className={`px-6 py-2 rounded-lg text-xs font-bold uppercase text-white shadow-md transition-all active:scale-95 flex items-center justify-center gap-2 min-w-[120px] ${editingId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}`}
                                >
                                    <Icon name={editingId ? "save" : "plus"} className="w-4 h-4" />
                                    {editingId ? "Salvar" : "Adicionar"}
                                </button>
                            </div>
                        </form>
                    </div>

                    {/* LISTA DE MODALIDADES */}
                    <div className="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                        <table className="w-full text-left">
                            <thead className="bg-slate-50 border-b border-slate-200">
                                <tr>
                                    <th className="p-4 text-xs font-bold text-slate-500 uppercase w-16 text-center">Cor</th>
                                    <th className="p-4 text-xs font-bold text-slate-500 uppercase">Nome da Modalidade</th>
                                    <th className="p-4 text-xs font-bold text-slate-500 uppercase text-right">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {db.modalidades.length === 0 ? (
                                    <tr>
                                        <td colSpan="3" className="p-8 text-center text-slate-400 text-sm">
                                            Nenhuma modalidade cadastrada.
                                        </td>
                                    </tr>
                                ) : (
                                    db.modalidades.map((mod) => (
                                        <tr key={mod.id} className="hover:bg-slate-50 transition-colors group">
                                            <td className="p-4 text-center">
                                                <div 
                                                    className="w-6 h-6 rounded-full mx-auto shadow-sm ring-2 ring-white border border-slate-100"
                                                    style={{ backgroundColor: mod.cor }}
                                                    title={mod.cor}
                                                ></div>
                                            </td>
                                            <td className="p-4">
                                                <span className="font-bold text-slate-700 text-sm">{mod.nome}</span>
                                            </td>
                                            <td className="p-4 text-right">
                                                <div className="flex justify-end gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                                                    <button 
                                                        onClick={() => handleEdit(mod)} 
                                                        className="p-2 text-blue-500 hover:bg-blue-50 rounded-lg transition-colors" 
                                                        title="Editar"
                                                    >
                                                        <Icon name="edit-2" className="w-4 h-4" />
                                                    </button>
                                                    <button 
                                                        onClick={() => handleDelete(mod.id)} 
                                                        className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors" 
                                                        title="Excluir"
                                                    >
                                                        <Icon name="trash-2" className="w-4 h-4" />
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))
                                )}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ConfigView = ({ db, setDb, user }) => { 
            const { addToast } = useToast();
            // Force state for mentor role
            const [mainTab, setMainTab] = useState('cadastro'); 
            const [subTab, setSubTab] = useState(user.role === 'mentor' ? 'unidade' : 'mentores'); 
            const [feriadoData, setFeriadoData] = useState({ nome: '', dataInicio: '', dataFim: '', escopo: 'Global', local: '' }); 
            const [validationError, setValidationError] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            
            // Novos estados para edi√ß√£o de feriados
            const [editingId, setEditingId] = useState(null);
            const [holidayType, setHolidayType] = useState('unico');

            // Reset form when changing tabs
            useEffect(() => {
                setEditingId(null);
                setFeriadoData({ nome: '', dataInicio: '', dataFim: '', escopo: 'Global', local: '' });
                setHolidayType('unico');
                setValidationError(false);
            }, [subTab, mainTab]);

            // Ensure Mentor stays on allowed tabs
            useEffect(() => {
                if (user.role === 'mentor') {
                    setMainTab('cadastro');
                    if (subTab !== 'unidade') setSubTab('unidade');
                }
            }, [user.role, subTab]);

            // Handle Edit Click (Apenas Feriados agora, pois Modalidade/Unit/Mentor tem componentes pr√≥prios)
            const handleEdit = (item) => {
                setEditingId(item.id);
                if (subTab === 'feriados') {
                    setFeriadoData({
                        nome: item.nome,
                        dataInicio: item.dataInicio,
                        dataFim: item.dataFim,
                        escopo: item.escopo,
                        local: item.local
                    });
                    // CRUCIAL: Detecta se √© per√≠odo ou dia √∫nico para ajustar UI
                    setHolidayType(item.dataInicio === item.dataFim ? 'unico' : 'periodo');
                }
            };

            const handleSave = () => { 
                const newDb = { ...db }; 
                setValidationError(false);

                if (mainTab === 'cadastro') {
                    let collection = '';
                    let newItem = { id: editingId || Date.now() };

                    if (subTab === 'feriados') {
                        collection = 'feriados';
                        if(!feriadoData.nome || !feriadoData.dataInicio) return setValidationError(true);
                        
                        // L√≥gica de Data Fim
                        const finalDataFim = holidayType === 'unico' ? feriadoData.dataInicio : (feriadoData.dataFim || feriadoData.dataInicio);
                        
                        newItem = { ...newItem, ...feriadoData, dataFim: finalDataFim };

                        if (editingId) {
                            newDb[collection] = newDb[collection].map(i => i.id === editingId ? newItem : i);
                            addToast("Feriado atualizado com sucesso!", "success");
                        } else {
                            newDb[collection] = [...newDb[collection], newItem];
                            addToast("Feriado adicionado com sucesso!", "success");
                        }
                        
                        setDb(newDb);
                        // Reset ap√≥s salvar
                        setEditingId(null);
                        setFeriadoData({ nome: '', dataInicio: '', dataFim: '', escopo: 'Global', local: '' });
                        setHolidayType('unico');
                    }
                } 
            }; 
            
            const confirmDelete = (collection, id) => {
                setItemToDelete({ collection, id });
                setShowConfirm(true);
            };

            const handleDelete = () => {
                if(itemToDelete) {
                    const { collection, id } = itemToDelete;
                    setDb({ ...db, [collection]: db[collection].filter(i => i.id !== id) }); 
                    addToast("Item removido.", "success");
                    setShowConfirm(false);
                    setItemToDelete(null);
                    
                    // Se deletou o item em edi√ß√£o, limpa o form
                    if (editingId === id) {
                        setEditingId(null);
                        setFeriadoData({ nome: '', dataInicio: '', dataFim: '', escopo: 'Global', local: '' });
                        setHolidayType('unico');
                    }
                }
            };
            
            const handleBackup = () => { 
                dataLayer.exportData(db);
                addToast("Backup baixado com sucesso!", "success"); 
            };
            
            const handleRestore = (event) => { 
                const file = event.target.files[0];
                if (!file) return;
                
                dataLayer.importData(file, (importedData, error) => {
                    if (error) {
                        addToast(error, "error");
                    } else {
                        setDb(importedData);
                        addToast("Sistema restaurado com sucesso!", "success");
                    }
                });
            };
            
            const renderCadastroList = (collection, icon) => (
                <ul className="space-y-2 max-h-96 overflow-y-auto pr-2">
                    {(db[collection] || []).map(item => (
                        <li key={item.id} className="group flex justify-between items-center p-3 bg-slate-50 rounded border border-slate-100 hover:border-blue-200 transition-colors">
                            <span className="text-sm font-bold text-slate-700 uppercase flex items-center gap-2">
                                <Icon name={icon} className="w-4 h-4 text-slate-400" /> 
                                {item.nome}
                                {collection === 'feriados' && (<div className="flex flex-col ml-2"><span className="text-[10px] text-slate-400 font-normal">{DateUtils.formatBr(new Date(item.dataInicio))} {item.dataInicio !== item.dataFim ? ` at√© ${DateUtils.formatBr(new Date(item.dataFim))}` : ''}</span><span className="text-[9px] bg-slate-200 px-1 rounded w-fit">{item.escopo} {item.local ? `(${item.local})` : ''}</span></div>)}
                            </span>
                            <div className="flex gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-opacity">
                                <button onClick={() => handleEdit(item)} className="text-blue-400 hover:text-blue-600 p-1" title="Editar"><Icon name="edit" className="w-4 h-4" /></button>
                                <button onClick={() => confirmDelete(collection, item.id)} className="text-red-400 hover:text-red-600 p-1" title="Excluir"><Icon name="trash-2" className="w-4 h-4" /></button>
                            </div>
                        </li>
                    ))}
                    {(!db[collection] || db[collection].length === 0) && (
                        <li className="text-center text-slate-400 text-xs p-4">Nenhum item cadastrado.</li>
                    )}
                </ul>
            ); 
            
            // ACL Tabs Logic
            const showSecurity = user.role !== 'mentor';
            const allowedSubTabs = user.role === 'mentor' ? ['unidade'] : ['mentores', 'unidade', 'modalidade', 'feriados'];

            return (
                <div className="p-6 space-y-6 fade-in h-full flex flex-col">
                    <ConfirmModal 
                        isOpen={showConfirm} 
                        onClose={() => setShowConfirm(false)} 
                        onConfirm={handleDelete} 
                        title="Excluir Item" 
                        message="Tem certeza que deseja excluir este item? Essa a√ß√£o n√£o pode ser desfeita." 
                    />
                    <div className="glass-panel p-6 flex-1 flex flex-col">
                        <div className="flex gap-6 mb-6 border-b-2 border-slate-100"><button onClick={() => setMainTab('cadastro')} className={`pb-3 text-sm font-bold uppercase transition-colors ${mainTab === 'cadastro' ? 'border-b-2 border-blue-600 text-blue-600 -mb-[2px]' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="folder-plus" className="w-4 h-4 inline mr-2" /> Cadastro</button>
                        {showSecurity && <button onClick={() => setMainTab('seguranca')} className={`pb-3 text-sm font-bold uppercase transition-colors ${mainTab === 'seguranca' ? 'border-b-2 border-blue-600 text-blue-600 -mb-[2px]' : 'text-slate-400 hover:text-slate-600'}`}><Icon name="shield" className="w-4 h-4 inline mr-2" /> Seguran√ßa do Sistema</button>}</div>
                        {mainTab === 'cadastro' && (
                            <>
                                <div className="flex gap-2 mb-6 overflow-x-auto">
                                    {allowedSubTabs.map(tab => (
                                        <button 
                                            key={tab} 
                                            onClick={() => setSubTab(tab)}
                                            className={`px-4 py-2 rounded-full text-xs font-bold uppercase transition-colors ${subTab === tab ? 'bg-blue-600 text-white' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}
                                        >
                                            {tab === 'mentores' ? 'Mentor' : tab.charAt(0).toUpperCase() + tab.slice(1)}
                                        </button>
                                    ))}
                                </div>

                                {/* CONTE√öDO DIN√ÇMICO BASEADO NA ABA */}
                                {subTab === 'mentores' ? (
                                    <MentorTab db={db} setDb={setDb} addToast={addToast} />
                                ) : subTab === 'unidade' ? (
                                    <UnitTab db={db} setDb={setDb} addToast={addToast} user={user} />
                                ) : subTab === 'modalidade' ? (
                                    <ModalidadeTab db={db} setDb={setDb} addToast={addToast} />
                                ) : (
                                    <>
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 mb-4">

                                        {/* FORMUL√ÅRIO DE FERIADOS (Restante que ainda n√£o foi isolado) */}
                                        {subTab === 'feriados' && (
                                            <div className="flex flex-col gap-3">
                                                <div className="flex gap-3">
                                                    <div className="flex-1">
                                                        <label className="text-[10px] uppercase font-bold text-slate-500">Nome do Feriado</label>
                                                        <input type="text" className={`w-full p-2 border rounded text-sm ${validationError && !feriadoData.nome ? 'input-error' : ''}`} value={feriadoData.nome} onChange={e => setFeriadoData({...feriadoData, nome: e.target.value})} placeholder="Ex: Natal" />
                                                    </div>
                                                    <div className="w-1/3">
                                                        <label className="text-[10px] uppercase font-bold text-slate-500">Tipo de Data</label>
                                                        <select className="w-full p-2 border rounded text-sm" value={holidayType} onChange={e => setHolidayType(e.target.value)}>
                                                            <option value="unico">Dia √önico</option>
                                                            <option value="periodo">Per√≠odo</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <div className="flex gap-3 items-end">
                                                    <div className="flex-1"><label className="text-[10px] uppercase font-bold text-slate-500">In√≠cio</label><input type="date" className={`w-full p-2 border rounded text-sm ${validationError && !feriadoData.dataInicio ? 'input-error' : ''}`} value={feriadoData.dataInicio} onChange={e => setFeriadoData({...feriadoData, dataInicio: e.target.value})} /></div>
                                                    
                                                    {holidayType === 'periodo' && (
                                                        <div className="flex-1"><label className="text-[10px] uppercase font-bold text-slate-500">Fim</label><input type="date" className="w-full p-2 border rounded text-sm" value={feriadoData.dataFim} onChange={e => setFeriadoData({...feriadoData, dataFim: e.target.value})} /></div>
                                                    )}

                                                    <div className="w-1/3"><label className="text-[10px] uppercase font-bold text-slate-500">Escopo</label><select className="w-full p-2 border rounded text-sm" value={feriadoData.escopo} onChange={e => setFeriadoData({...feriadoData, escopo: e.target.value})}><option value="Global">Global</option><option value="Nacional">Nacional</option><option value="Regional">Regional</option></select></div>
                                                    {(feriadoData.escopo === 'Nacional' || feriadoData.escopo === 'Regional') && (<div className="flex-1"><label className="text-[10px] uppercase font-bold text-slate-500">Local (Pa√≠s/Estado)</label><input type="text" className="w-full p-2 border rounded text-sm" placeholder="Ex: Brasil ou MG" value={feriadoData.local} onChange={e => setFeriadoData({...feriadoData, local: e.target.value})} /></div>)}
                                                </div>
                                            </div>
                                        )}

                                        {/* BOT√ÉO DE A√á√ÉO PARA FERIADOS */}
                                        <div className="mt-3 flex justify-end gap-2">
                                            {editingId && <button onClick={() => { setEditingId(null); setFeriadoData({ nome: '', dataInicio: '', dataFim: '', escopo: 'Global', local: '' }); setHolidayType('unico'); }} className="px-4 py-2 text-slate-500 text-xs font-bold uppercase hover:bg-slate-100 rounded border border-slate-300">Cancelar</button>}
                                            <button onClick={handleSave} className={`text-white px-6 py-2 rounded text-xs font-bold uppercase h-9 flex items-center gap-2 shadow-sm transition-colors ${editingId ? 'bg-amber-500 hover:bg-amber-600' : 'bg-green-600 hover:bg-green-700'}`}>
                                                <Icon name={editingId ? "save" : "plus"} className="w-4 h-4" /> {editingId ? "Salvar Altera√ß√µes" : "Adicionar"}
                                            </button>
                                        </div>

                                    </div>

                                    {/* LISTAS PARA FERIADOS */}
                                    {subTab === 'feriados' && renderCadastroList('feriados', 'calendar-off')}
                                    </>
                                )
                            }
                            </>
                        )}
                        {mainTab === 'seguranca' && showSecurity && (
                            <div className="flex flex-col gap-4">
                                <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 className="font-bold text-blue-800 mb-2">Backup do Sistema</h4>
                                    <p className="text-sm text-blue-600 mb-4">Baixe uma c√≥pia de seguran√ßa de todos os dados (mentores, unidades, aulas, etc).</p>
                                    <button onClick={handleBackup} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold uppercase text-xs flex items-center gap-2"><Icon name="download" className="w-4 h-4"/> Fazer Backup</button>
                                </div>
                                <div className="p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                    <h4 className="font-bold text-amber-800 mb-2">Restaurar Sistema</h4>
                                    <p className="text-sm text-amber-600 mb-4">Carregue um arquivo de backup para restaurar os dados. Cuidado: isso substituir√° os dados atuais.</p>
                                    <label className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded font-bold uppercase text-xs flex items-center gap-2 cursor-pointer w-fit">
                                        <Icon name="upload" className="w-4 h-4"/> Restaurar Backup
                                        <input type="file" className="hidden" accept=".json" onChange={handleRestore} />
                                    </label>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            ); 
        };

        const LoginScreen = ({ onLogin, db }) => { 
            const [userText, setUserText] = useState(""); 
            const [passText, setPassText] = useState(""); 
            const [error, setError] = useState(""); 
            
            const handleLogin = (e) => { 
                e.preventDefault(); 
                const cleanUser = userText.trim().toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, ""); 
                const cleanPass = passText.trim(); 
                
                // Valida√ß√£o Admin
                if (cleanUser === "ADMIN" && cleanPass === "admin123") { 
                    onLogin({ id: "admin", nome: "ADMINISTRADOR", role: "admin" }); 
                    return; 
                } 
                
                // Valida√ß√£o Mentor
                const mentor = db.mentores.find(m => m.nome.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === cleanUser && String(m.senha) === cleanPass); 
                if (mentor) { 
                    onLogin({ ...mentor, role: "mentor" }); 
                    return; 
                } 
                
                // Valida√ß√£o Unidade
                const unidade = db.unidades.find(u => u.nome.toUpperCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") === cleanUser && String(u.senha) === cleanPass); 
                if (unidade) { 
                    onLogin({ ...unidade, role: "unidade" }); 
                    return; 
                } 
                
                setError("Credenciais Inv√°lidas"); 
            }; 

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-[#020617] p-4 bg-[url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center">
                    <div className="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
                    <div className="relative bg-white/10 border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md animate-slide-in backdrop-blur-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-black text-white tracking-tighter mb-1">HAPPY <span className="text-blue-400">ZONE</span></h1>
                            <p className="text-blue-200 text-xs uppercase tracking-widest font-bold">Sistema de Gest√£o 4.0</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <div className="relative">
                                <Icon name="user" className="absolute left-3 top-3.5 w-5 h-5 text-blue-300"/>
                                <input 
                                    className="w-full pl-10 p-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-400 focus:border-blue-400 outline-none transition-all uppercase" 
                                    placeholder="USU√ÅRIO" 
                                    value={userText} 
                                    onChange={e => setUserText(e.target.value)}
                                />
                            </div>
                            <div className="relative">
                                <Icon name="lock" className="absolute left-3 top-3.5 w-5 h-5 text-blue-300"/>
                                <input 
                                    type="password" 
                                    className="w-full pl-10 p-3 bg-slate-900/50 border border-slate-700 rounded-xl text-white placeholder-slate-400 focus:border-blue-400 outline-none transition-all" 
                                    placeholder="SENHA" 
                                    value={passText} 
                                    onChange={e => setPassText(e.target.value)}
                                />
                            </div>
                            <button className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl uppercase text-xs tracking-wider shadow-lg shadow-blue-900/50 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                Entrar no Sistema
                            </button>
                        </form>
                        {error && <div className="mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-200 text-xs text-center font-bold animate-pulse">{error}</div>}
                        <div className="mt-6 text-center text-[10px] text-slate-500">Admin: ADMIN / admin123</div>
                    </div>
                </div>
            ); 
        };
        const FeedbackModal = ({ onClose }) => {
            const { addToast } = useToast();
            const [feedback, setFeedback] = useState("");
            const [rating, setRating] = useState(0);
            const handleSubmit = () => { addToast("Feedback enviado com sucesso!", "success"); onClose(); };
            return (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 p-4"><div className="bg-white p-6 rounded-lg w-full max-w-sm fade-in"><h3 className="text-lg font-bold text-slate-700 mb-4">Enviar Feedback</h3><div className="flex gap-2 mb-4 justify-center">{[1,2,3,4,5].map(star => <button key={star} onClick={()=>setRating(star)} className={`text-2xl transition-colors ${rating >= star ? 'text-yellow-400' : 'text-slate-200'}`}>‚òÖ</button>)}</div><textarea className="w-full border rounded p-2 text-sm mb-4" rows="4" placeholder="Sua sugest√£o..." value={feedback} onChange={e=>setFeedback(e.target.value)}></textarea><div className="flex gap-2 justify-end"><button onClick={onClose} className="px-4 py-2 text-slate-500 text-xs font-bold uppercase">Cancelar</button><button onClick={handleSubmit} className="px-4 py-2 bg-blue-600 text-white rounded text-xs font-bold uppercase hover:bg-blue-700">Enviar</button></div></div></div>);
        };

        const Sidebar = ({ currentView, setView, onLogout, user, isMobileOpen, closeMobile }) => { 
            const [showFeedback, setShowFeedback] = useState(false);
            const menuItems = [ { id: 'home', label: 'In√≠cio', icon: 'home' }, { id: 'relatorio', label: 'Relat√≥rio Gerencial', icon: 'bar-chart-2' }, { id: 'cronograma', label: 'Cronograma Visual', icon: 'calendar' }, { id: 'validacao', label: 'Valida√ß√£o Di√°ria', icon: 'check-circle' }, { id: 'validacaoUnidades', label: 'Valida√ß√£o Coletiva', icon: 'shield-check' }, { id: 'config', label: 'Configura√ß√µes', icon: 'settings' } ]; 
            
            const visibleItems = menuItems.filter(item => {
                if (user.role === 'unidade') {
                    return item.id !== 'validacaoUnidades' && item.id !== 'config';
                }
                // Mentor has full sidebar access (Config restricted internally)
                return true;
            });

            return (<> {isMobileOpen && <div className="fixed inset-0 bg-black/50 z-20 md:hidden" onClick={closeMobile}></div>} <aside className={`w-64 bg-sidebar flex flex-col shadow-xl fixed md:relative h-full z-30 transition-transform duration-300 ${isMobileOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}><div className="p-6 border-b border-slate-800 flex justify-between items-center"><h1 className="text-xl font-bold text-white">PRATIQUE <span className="text-blue-500">COLETIVAS</span></h1><button className="md:hidden text-slate-400" onClick={closeMobile}><Icon name="x" className="w-5 h-5"/></button></div><nav className="flex-1 py-6 space-y-1 overflow-y-auto">{visibleItems.map(item => (<button key={item.id} onClick={() => { setView(item.id); closeMobile(); }} className={`w-full px-6 py-3 flex items-center gap-3 text-sm font-medium transition-colors ${currentView === item.id ? 'bg-blue-600/10 text-blue-400 border-l-4 border-blue-500' : 'text-slate-400 hover:bg-white/5 hover:text-white border-l-4 border-transparent'}`}><Icon name={item.icon} className="w-5 h-5" />{item.label}</button>))}</nav><div className="px-6 py-4"><button onClick={() => setShowFeedback(true)} className="w-full py-2 border border-slate-700 rounded text-slate-400 text-xs uppercase font-bold hover:bg-slate-800 transition-colors flex justify-center items-center gap-2"><Icon name="message-square" className="w-3 h-3"/> Feedback</button></div><div className="p-4 border-t border-slate-800 bg-slate-900/50"><div className="flex items-center gap-3"><div className="w-10 h-10 rounded-full bg-gradient-to-tr from-blue-600 to-blue-400 flex items-center justify-center text-white font-bold text-sm shadow-lg">{user.nome.charAt(0)}</div><div className="overflow-hidden"><p className="text-white text-xs font-bold truncate w-32">{user.nome}</p><p className="text-[10px] text-slate-500 uppercase">{user.role}</p></div><button onClick={onLogout} className="ml-auto text-red-400 hover:text-red-300 p-2 rounded-lg hover:bg-red-500/10 transition-colors"><Icon name="log-out" className="w-4 h-4" /></button></div></div>{showFeedback && <FeedbackModal onClose={() => setShowFeedback(false)} />}</aside> </>); 
        };

        const Header = ({ title, toggleMobile, hasNewChanges, lastSync }) => { 
            const [date, setDate] = useState(new Date()); 
            useEffect(() => { 
                const timer = setInterval(() => setDate(new Date()), 60000); 
                return () => clearInterval(timer); 
            }, []); 
            
            const dataSourceColor = DATA_SOURCE === 'supabase' ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-blue-50 text-blue-600 border-blue-200';
            const dataSourceIcon = DATA_SOURCE === 'supabase' ? 'database' : 'hard-drive';
            const isRealtime = DATA_SOURCE === 'supabase';
            
            const formatLastSync = (date) => {
                if (!date) return '';
                const now = new Date();
                const diff = Math.floor((now - date) / 1000);
                if (diff < 10) return 'agora';
                if (diff < 60) return `${diff}s atr√°s`;
                const minutes = Math.floor(diff / 60);
                if (minutes < 60) return `${minutes}min atr√°s`;
                return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            };
            
            return (
                <header className="h-16 bg-white border-b border-slate-200 flex justify-between items-center px-4 md:px-8 shadow-sm z-10 sticky top-0">
                    <div className="flex items-center gap-4">
                        <button className="md:hidden text-slate-600" onClick={toggleMobile}>
                            <Icon name="menu" className="w-6 h-6"/>
                        </button>
                        <h2 className="text-lg font-bold text-slate-700">{title}</h2>
                        {hasNewChanges && (
                            <div className="flex items-center gap-1 text-[10px] font-bold uppercase text-orange-600 bg-orange-50 px-2 py-1 rounded border border-orange-200 animate-pulse">
                                <Icon name="refresh-cw" className="w-3 h-3 animate-spin" />
                                Sincronizando
                            </div>
                        )}
                    </div>
                    <div className="flex items-center gap-4">
                        <div className="hidden md:flex items-center gap-2 text-xs font-mono text-slate-500 bg-slate-50 px-3 py-1.5 rounded-full border border-slate-100">
                            <Icon name="clock" className="w-3 h-3" />
                            {date.toLocaleDateString('pt-BR')}
                        </div>
                        <div className={`flex items-center gap-2 text-[10px] font-bold uppercase px-2 py-1 rounded border ${dataSourceColor}`} title={`Fonte de dados: ${DATA_SOURCE}`}>
                            <Icon name={dataSourceIcon} className="w-3 h-3" />
                            {DATA_SOURCE}
                        </div>
                        {isRealtime ? (
                            <div className="flex items-center gap-2 text-[10px] font-bold uppercase text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100" title={`Sincroniza√ß√£o em tempo real ativa. √öltima sync: ${formatLastSync(lastSync)}`}>
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                REALTIME
                                {lastSync && (
                                    <span className="text-[8px] opacity-75 ml-1">{formatLastSync(lastSync)}</span>
                                )}
                            </div>
                        ) : (
                            <div className="flex items-center gap-2 text-[10px] font-bold uppercase text-green-600 bg-green-50 px-2 py-1 rounded border border-green-100">
                                <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                                Online
                            </div>
                        )}
                    </div>
                </header>
            ); 
        };
        
        const DashboardHome = ({ user, setView, db }) => {
            const [now, setNow] = useState(new Date());

            useEffect(() => {
                const timer = setInterval(() => setNow(new Date()), 60000);
                return () => clearInterval(timer);
            }, []);

            // ... Helpers for logic ...
            // Filter classes based on role
            const myClasses = useMemo(() => {
                if (!db || !db.horarios) return [];
                return db.horarios.filter(h => {
                    if (user.role === 'admin') return true;
                    const unit = db.unidades.find(u => u.id === h.unidadeId);
                    if (user.role === 'unidade') return h.unidadeId === user.id;
                    if (user.role === 'mentor') return unit?.mentorId === user.id;
                    return false;
                });
            }, [db, user]);

            // 1. Cronograma Logic
            const scheduleStatus = useMemo(() => {
                const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                const todayName = days[now.getDay()];
                const currentMins = now.getHours() * 60 + now.getMinutes();

                const todayClasses = myClasses.filter(c => c.dias.includes(todayName));
                
                // Find active
                const active = todayClasses.find(c => {
                    const start = parseInt(c.hora.split(':')[0]) * 60 + parseInt(c.hora.split(':')[1]);
                    const end = start + (c.duracao || 60);
                    return currentMins >= start && currentMins < end;
                });

                // Find next
                const next = todayClasses
                    .filter(c => {
                        const start = parseInt(c.hora.split(':')[0]) * 60 + parseInt(c.hora.split(':')[1]);
                        return start > currentMins;
                    })
                    .sort((a, b) => a.hora.localeCompare(b.hora))[0];

                return { active, next, countToday: todayClasses.length };
            }, [myClasses, now]);

            // 2. Validation Logic
            const validationStatus = useMemo(() => {
                const todayIso = DateUtils.toISODate(now);
                const days = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
                const todayName = days[now.getDay()];
                
                const todayClasses = myClasses.filter(c => c.dias.includes(todayName));
                const validationsToday = db.validacoes.filter(v => v.data === todayIso && todayClasses.some(c => c.id === v.aulaId));
                
                // Check which classes are validated
                const validatedIds = new Set(validationsToday.map(v => v.aulaId));
                const pendingCount = todayClasses.filter(c => !validatedIds.has(c.id)).length;

                return { pending: pendingCount, isUpToDate: pendingCount === 0 && todayClasses.length > 0 };
            }, [myClasses, db.validacoes, now]);

            // 3. Financial Logic (Sneak Peek)
            const financialSneakPeek = useMemo(() => {
                if (user.role === 'unidade') return null; // Only admin/mentor

                const currentMonth = now.getMonth() + 1;
                const currentYear = now.getFullYear();
                
                // Valida√ß√£o para evitar NaN
                if (!myClasses || myClasses.length === 0) return 0;
                if (!db || !db.feriados || !db.unidades) return 0;
                
                // Simplified calculation for performance
                let total = 0;
                myClasses.forEach(h => {
                    // Valida√ß√£o de dados
                    if (!h.dias || !Array.isArray(h.dias) || h.dias.length === 0) return;
                    
                    const valorHora = parseFloat(h.valor);
                    if (isNaN(valorHora)) return;
                    
                    const unidade = db.unidades.find(u => u.id === h.unidadeId);
                    
                    try {
                        const { dates } = DateUtils.generateClassDates(h.dias, currentMonth, currentYear, db.feriados, unidade);
                        const numAulas = dates.length || 0;
                        total += numAulas * valorHora;
                    } catch (error) {
                        console.warn('Erro ao calcular previs√£o financeira:', error);
                    }
                });
                
                return isNaN(total) ? 0 : total;
            }, [myClasses, user.role, now, db.feriados, db.unidades]);

            // Greeting
            const getGreeting = () => { 
                const hour = now.getHours(); 
                if (hour < 12) return "Bom dia"; 
                if (hour < 18) return "Boa tarde"; 
                return "Boa noite"; 
            };

            return (
                <div className="p-8 max-w-7xl mx-auto fade-in">
                    <div className="mb-10 flex justify-between items-end">
                        <div>
                            <h1 className="text-3xl font-light text-slate-600">{getGreeting()}, <span className="font-bold text-slate-800">{user.nome}</span></h1>
                            <p className="text-slate-400 mt-2 text-sm">Painel Operacional ‚Ä¢ {now.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' })}</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        
                        {/* 1. RELAT√ìRIO CARD */}
                        <div className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden flex flex-col justify-between h-full">
                            <div className="absolute top-0 right-0 p-4 opacity-10 text-blue-500"><Icon name="bar-chart-2" className="w-24 h-24" /></div>
                            <div>
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-blue-50 text-blue-600"><Icon name="bar-chart-2" className="w-6 h-6" /></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-1">Relat√≥rio Gerencial</h3>
                                <p className="text-sm text-slate-400">An√°lise de performance</p>
                                
                                {/* SNEAK PEEK */}
                                {financialSneakPeek !== null && (
                                    <div className="mt-3 bg-blue-50/50 p-2 rounded border border-blue-100 inline-block">
                                        <p className="text-[10px] uppercase font-bold text-blue-400">Previs√£o M√™s Atual</p>
                                        <p className="text-lg font-bold text-slate-700">R$ {financialSneakPeek.toLocaleString('pt-BR', { maximumFractionDigits: 0 })} <span className="text-[10px] text-slate-400 font-normal">(parcial)</span></p>
                                    </div>
                                )}
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-50 flex items-center justify-between">
                                <button onClick={() => setView('relatorio')} className="text-xs font-bold uppercase text-blue-600 hover:text-blue-800 flex items-center gap-1">Ver M√™s Atual <Icon name="arrow-right" className="w-3 h-3" /></button>
                            </div>
                        </div>

                        {/* 2. CRONOGRAMA CARD (SMART) */}
                        <div className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden flex flex-col justify-between h-full">
                            <div className="absolute top-0 right-0 p-4 opacity-10 text-indigo-500"><Icon name="calendar" className="w-24 h-24" /></div>
                            <div>
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-indigo-50 text-indigo-600"><Icon name="calendar" className="w-6 h-6" /></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-1">Cronograma</h3>
                                
                                {/* LIVE STATUS */}
                                <div className="mt-2 space-y-2">
                                    {scheduleStatus.active ? (
                                        <div className="bg-green-50 border border-green-100 p-2 rounded animate-pulse">
                                            <p className="text-[10px] font-bold uppercase text-green-600 flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"></span> Em Andamento</p>
                                            <p className="text-sm font-bold text-slate-700">{scheduleStatus.active.modalidadeNome}</p>
                                            <p className="text-xs text-slate-500">{scheduleStatus.active.hora} ‚Ä¢ {scheduleStatus.active.professor}</p>
                                        </div>
                                    ) : scheduleStatus.next ? (
                                        <div className="bg-blue-50 border border-blue-100 p-2 rounded">
                                            <p className="text-[10px] font-bold uppercase text-blue-600">Pr√≥xima Aula</p>
                                            <p className="text-sm font-bold text-slate-700">{scheduleStatus.next.modalidadeNome}</p>
                                            <p className="text-xs text-slate-500">{scheduleStatus.next.hora} ‚Ä¢ {scheduleStatus.next.professor}</p>
                                        </div>
                                    ) : (
                                        <p className="text-sm text-slate-400">Sem mais aulas hoje.</p>
                                    )}
                                </div>
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-50">
                                <button onClick={() => setView('cronograma')} className="text-xs font-bold uppercase text-indigo-600 hover:text-indigo-800 flex items-center gap-1">Ver Grade Completa <Icon name="arrow-right" className="w-3 h-3" /></button>
                            </div>
                        </div>

                        {/* 3. VALIDA√á√ÉO CARD (ALERT) */}
                        <div className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden flex flex-col justify-between h-full">
                            <div className="absolute top-0 right-0 p-4 opacity-10 text-emerald-500"><Icon name="check-circle" className="w-24 h-24" /></div>
                            <div>
                                <div className="flex justify-between items-start">
                                    <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-emerald-50 text-emerald-600"><Icon name="check-circle" className="w-6 h-6" /></div>
                                    
                                    {/* BADGE PEND√äNCIA */}
                                    {validationStatus.pending > 0 ? (
                                        <span className="bg-red-500 text-white text-[10px] font-bold px-2 py-1 rounded-full shadow-sm animate-bounce">
                                            {validationStatus.pending} PENDENTES
                                        </span>
                                    ) : validationStatus.isUpToDate && (
                                        <span className="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded-full flex items-center gap-1">
                                            <Icon name="check" className="w-3 h-3" /> EM DIA
                                        </span>
                                    )}
                                </div>
                                <h3 className="text-lg font-bold text-slate-700 mb-1">Valida√ß√£o Di√°ria</h3>
                                <p className="text-sm text-slate-400">Controle de presen√ßa</p>
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-50">
                                <button onClick={() => setView('validacao')} className="text-xs font-bold uppercase text-emerald-600 hover:text-emerald-800 flex items-center gap-1">
                                    {validationStatus.pending > 0 ? "Resolver Pend√™ncias" : "Acessar Valida√ß√£o"} <Icon name="arrow-right" className="w-3 h-3" />
                                </button>
                            </div>
                        </div>

                        {/* OUTROS CARDS (Visibilidade condicionada por role j√° tratada no componente pai ou aqui se necess√°rio, mas o prompt diz 'mantendo estrutura de cards') */}
                        
                        {/* 4. Valida√ß√£o Coletiva (Admin/Mentor) */}
                        {(user.role !== 'unidade') && (
                            <div onClick={() => setView('validacaoUnidades')} className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden cursor-pointer">
                                <div className="absolute top-0 right-0 p-4 opacity-10 text-orange-500"><Icon name="shield-check" className="w-24 h-24" /></div>
                                <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-orange-50 text-orange-600"><Icon name="shield-check" className="w-6 h-6" /></div>
                                <h3 className="text-lg font-bold text-slate-700 mb-1">Valida√ß√£o Coletiva</h3>
                                <p className="text-sm text-slate-400">Monitoramento de Ades√£o</p>
                                <div className="mt-4 pt-4 border-t border-slate-50 flex items-center text-xs font-bold uppercase text-orange-600 opacity-0 group-hover:opacity-100 transition-opacity">Acessar <Icon name="arrow-right" className="w-3 h-3 ml-1" /></div>
                            </div>
                        )}

                        {/* 5. Configura√ß√µes (Admin/Mentor) */}
                        {(user.role !== 'unidade') && (
                            <div className="group bg-white p-6 rounded-2xl border border-slate-100 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 relative overflow-hidden flex flex-col justify-between h-full">
                                <div className="absolute top-0 right-0 p-4 opacity-10 text-slate-500"><Icon name="settings" className="w-24 h-24" /></div>
                                <div>
                                    <div className="w-12 h-12 rounded-xl flex items-center justify-center mb-4 bg-slate-100 text-slate-600"><Icon name="settings" className="w-6 h-6" /></div>
                                    <h3 className="text-lg font-bold text-slate-700 mb-1">Configura√ß√µes</h3>
                                    <p className="text-sm text-slate-400">Ajustes do sistema</p>
                                </div>
                                <div className="mt-4 pt-4 border-t border-slate-50">
                                    <button onClick={() => setView('config')} className="text-xs font-bold uppercase text-slate-600 hover:text-slate-800 flex items-center gap-1">Nova Unidade <Icon name="plus" className="w-3 h-3" /></button>
                                </div>
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        const App = () => { 
            const [user, setUser] = useState(null); 
            const [view, setView] = useState('home'); 
            const [isMobileOpen, setIsMobileOpen] = useState(false); 
            const [db, setDb] = useState(INITIAL_DB);
            const [isLoading, setIsLoading] = useState(true);
            const [realtimeChannel, setRealtimeChannel] = useState(null);
            const [hasNewChanges, setHasNewChanges] = useState(false);
            const [lastSync, setLastSync] = useState(new Date());
            
            // ========== INICIALIZA√á√ÉO: Carrega dados do DataLayer ==========
            useEffect(() => {
                const loadInitialData = async () => {
                    try {
                        const loadedData = await dataLayer.loadData();
                        setDb(loadedData);
                        console.log(`üì¶ Dados carregados do ${DATA_SOURCE}`);
                    } catch (error) {
                        console.error('Erro ao carregar dados:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                loadInitialData();
            }, []);
            
            // ========== PERSIST√äNCIA: Salva dados quando alterados ==========
            useEffect(() => {
                if (!isLoading && db !== INITIAL_DB) {
                    dataLayer.saveData(db);
                }
            }, [db, isLoading]);
            
            // ========== REALTIME: Sincroniza√ß√£o autom√°tica (apenas Supabase) ==========
            useEffect(() => {
                if (!isLoading && DATA_SOURCE === 'supabase') {
                    const channel = dataLayer.subscribeToChanges(async (change) => {
                        console.log('üîÑ Sincronizando mudan√ßa:', change.table);
                        setHasNewChanges(true);
                        
                        // Auto-refresh ap√≥s 1 segundo (debounce)
                        setTimeout(async () => {
                            try {
                                const freshData = await dataLayer.loadData();
                                setDb(freshData);
                                setLastSync(new Date());
                                setHasNewChanges(false);
                                console.log('‚úÖ Dados sincronizados automaticamente!');
                            } catch (error) {
                                console.error('‚ùå Erro ao sincronizar:', error);
                            }
                        }, 1000);
                    });
                    
                    setRealtimeChannel(channel);
                    
                    // Cleanup: desinscrever ao desmontar
                    return () => {
                        if (channel) {
                            dataLayer.unsubscribeFromChanges(channel);
                        }
                    };
                }
            }, [isLoading]);
            
            // ========== GERENCIAMENTO DE SESS√ÉO ==========
            useEffect(() => { 
                const savedUser = sessionStorage.getItem('pratique_v3_user'); 
                if (savedUser) setUser(JSON.parse(savedUser)); 
            }, []); 
            
            const handleLogin = (userData) => { setUser(userData); sessionStorage.setItem('pratique_v3_user', JSON.stringify(userData)); }; 
            const handleLogout = () => { setUser(null); sessionStorage.removeItem('pratique_v3_user'); setView('home'); };
            
            // ========== LOADING STATE ==========
            if (isLoading) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-slate-50 dark:bg-slate-900">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mb-4"></div>
                            <p className="text-slate-600 dark:text-slate-400 font-semibold">Carregando dados...</p>
                            <p className="text-xs text-slate-400 mt-2">Fonte: {DATA_SOURCE}</p>
                        </div>
                    </div>
                );
            } 
            
            if (!user) return <LoginScreen onLogin={handleLogin} db={db} />; 
            
            return (
                <ToastProvider>
                    <div className="flex h-screen overflow-hidden bg-slate-50">
                        <Sidebar currentView={view} setView={setView} user={user} onLogout={handleLogout} isMobileOpen={isMobileOpen} closeMobile={() => setIsMobileOpen(false)} />
                        <main className="flex-1 flex flex-col overflow-hidden relative">
                            <Header 
                                title={view === 'home' ? 'In√≠cio' : view.charAt(0).toUpperCase() + view.slice(1)} 
                                toggleMobile={() => setIsMobileOpen(true)}
                                hasNewChanges={hasNewChanges}
                                lastSync={lastSync}
                            />
                            <div className="flex-1 overflow-y-auto scroll-smooth">
                                {view === 'home' && <DashboardHome user={user} setView={setView} db={db} />}
                                {view === 'relatorio' && <RelatorioView db={db} user={user} />}
                                {view === 'cronograma' && <CronogramaView db={db} setDb={setDb} user={user} />}
                                {view === 'validacao' && <ValidacaoView db={db} setDb={setDb} user={user} />}
                                {view === 'validacaoUnidades' && <Valida√ß√£oColetivaView db={db} setDb={setDb} user={user} />}
                                {view === 'config' && <ConfigView db={db} setDb={setDb} user={user} />}
                            </div>
                        </main>
                    </div>
                </ToastProvider>
            ); 
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
