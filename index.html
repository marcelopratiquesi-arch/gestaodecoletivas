<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pratique Coletivas - Gestão Happy Zone</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        pratique: {
                            blue: '#0056b3', lightBlue: '#3b82f6', red: '#e63946',
                            gray: '#f3f4f6', dark: '#1e293b', sidebar: '#0f172a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .glass-panel { background: white; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left-color: #60a5fa; }
        .sidebar-link.disabled { opacity: 0.3; pointer-events: none; display: none; }
        .table-custom th { background-color: #f8fafc; color: #475569; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; font-weight: 700; cursor: pointer; }
        .table-custom td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .aula-card { transition: transform 0.2s, box-shadow 0.2s; position: relative; cursor: pointer; }
        .aula-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-sync { background-color: #f59e0b; animation: pulse 1s infinite; }
        .validation-box { @apply border border-blue-100 bg-blue-50 rounded-lg p-6 mb-6 shadow-sm relative overflow-hidden; }
        .validation-box::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; @apply bg-blue-500; }
        .validation-box.validated { @apply border-green-200 bg-green-50; }
        .validation-box.validated::before { @apply bg-green-500; }
        .login-bg { background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); }
        .config-tab { cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s; }
        .config-tab.active { border-bottom-color: #2563eb; color: #2563eb; }
        .config-tab:hover:not(.active) { color: #64748b; }
        
        /* New Styles for Tabs */
        .acesso-tab-btn { white-space: nowrap; padding: 1rem 0.25rem; border-bottom-width: 2px; font-weight: 500; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; transition: color 0.2s, border-color 0.2s; }
        .acesso-tab-btn.active { border-color: #6366f1; color: #4f46e5; }
        .acesso-tab-btn.inactive { border-color: transparent; color: #64748b; }
        .acesso-tab-btn.inactive:hover { color: #334155; border-color: #cbd5e1; }
        
        /* Subtabs Style - IMPROVED VISUALS */
        .subtab-btn { 
            @apply flex items-center gap-2 px-4 py-3 text-xs font-bold uppercase rounded-lg border transition-all shadow-sm; 
            min-width: max-content;
        }
        .subtab-btn.active { 
            @apply bg-slate-800 text-white border-slate-900 shadow-md transform scale-105; 
        }
        .subtab-btn.inactive { 
            @apply bg-white text-gray-500 border-gray-200 hover:bg-gray-50 hover:text-blue-600 hover:border-blue-200; 
        }

        /* Custom Tooltip */
        .custom-tooltip-trigger:hover .custom-tooltip { opacity: 1; visibility: visible; }
        .custom-tooltip { opacity: 0; visibility: hidden; transition: opacity 0.2s; }

        /* Sort Header Indicator */
        .sort-header:hover { color: #2563eb; }
        .sort-icon { display: inline-block; width: 12px; height: 12px; margin-left: 4px; }
        
        /* Modal Dragging */
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm font-sans bg-slate-50">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center login-bg p-4">
        <div class="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white tracking-tight mb-2">PRATIQUE <span class="text-blue-400">COLETIVAS</span></h1>
                <p class="text-blue-200 text-xs uppercase tracking-widest">Gestão & Performance</p>
            </div>
            
            <form onsubmit="event.preventDefault(); window.app.login();" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Usuário / Mentor / Unidade</label>
                    <div class="relative"><i data-lucide="user" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="text" id="login-user" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition uppercase" placeholder="Nome de Acesso" required></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Senha</label>
                    <div class="relative"><i data-lucide="lock" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="password" id="login-pass" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition" placeholder="••••••••" required></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs tracking-wider flex items-center justify-center gap-2"><i data-lucide="log-in" class="w-4 h-4"></i> Acessar Sistema</button>
            </form>
            <div class="mt-6 text-center text-[10px] text-slate-400"><span class="font-bold text-blue-400">Admin:</span> admin / admin123 <br> <span class="font-bold text-blue-400">Padrão:</span> Nome / 1234</div>
            <div id="login-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded text-red-200 text-xs text-center font-bold uppercase">Credenciais Inválidas</div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        <div id="mobile-menu-overlay" onclick="window.app.toggleMenu()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-pratique-sidebar text-gray-400 flex flex-col flex-shrink-0 transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none no-print">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <div><h1 class="text-xl font-bold text-white tracking-tight">PRATIQUE <span class="text-blue-500">COLETIVAS</span></h1><p class="text-xs mt-1 opacity-60">Gestão Happy Zone</p></div>
                <button onclick="window.app.toggleMenu()" class="md:hidden text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="window.app.nav('relatorio')" id="nav-relatorio" class="sidebar-link active w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> Relatório Gerencial</button>
                <button onclick="window.app.nav('cronograma')" id="nav-cronograma" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="calendar" class="w-5 h-5"></i> Cronograma Visual</button>
                <button onclick="window.app.nav('config')" id="nav-config" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="settings" class="w-5 h-5"></i> Configurações</button>
                <button onclick="window.app.nav('acesso')" id="nav-acesso" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="user-check" class="w-5 h-5"></i> Acesso Mensal</button>
                <button onclick="window.app.nav('historico')" id="nav-historico" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="history" class="w-5 h-5"></i> Histórico</button>
            </nav>
            <div class="p-4 border-t border-gray-800 bg-gray-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs" id="user-avatar">A</div>
                    <div class="overflow-hidden"><p class="text-white text-xs font-bold truncate" id="user-name">...</p><p class="text-[10px] text-gray-500" id="user-role">...</p></div>
                    <button onclick="window.app.logout()" class="ml-auto text-red-400 hover:text-red-300" title="Sair"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
                <div class="mt-2 text-[10px] flex items-center gap-1 opacity-50"><span class="status-dot status-offline" id="status-dot"></span> <span id="status-text">Offline</span></div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative w-full">
            <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-4 md:px-8 flex-shrink-0 z-10 sticky top-0 no-print">
                <div class="flex items-center gap-3"><button onclick="window.app.toggleMenu()" class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button><h2 id="page-title" class="text-lg font-bold text-gray-700 truncate">Visão Geral</h2></div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button onclick="window.app.forcarSincronizacao()" class="text-xs font-bold text-gray-500 hover:text-blue-600 flex items-center gap-1 mr-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync</button>
                    <span id="data-atual" class="hidden md:inline-block text-xs font-mono text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                    <button onclick="window.app.salvarBackup()" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1 bg-blue-50 p-2 rounded-lg"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden md:inline">Backup</span></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="main-content">
                
                <!-- RELATORIO -->
                <div id="view-relatorio" class="view-section pb-20">
                    <div class="glass-panel p-4 md:p-6 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 text-sm uppercase"><i data-lucide="filter" class="w-4 h-4 text-blue-500"></i> Filtros</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 items-end">
                            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Mês</label><select id="rel-mes" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"></select></div>
                            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Ano</label><input type="number" id="rel-ano" class="w-full p-2 border rounded text-xs h-9 uppercase text-center font-bold text-gray-700" value="2025" onchange="window.app.gerarRelatorio()"></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">País</label><select id="rel-pais" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('pais'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Estado</label><select id="rel-estado" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('estado'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1" id="filter-mentor-wrapper"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Mentor</label><select id="rel-mentor" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('mentor'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1" id="filter-unidade-wrapper"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Unidade</label><select id="rel-unidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('unidade'); window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Modalidade</label><select id="rel-modalidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><button onclick="window.app.gerarRelatorio()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-xs uppercase flex items-center justify-center gap-2 h-9 shadow-sm"><i data-lucide="search" class="w-3 h-3"></i> Filtrar</button></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4 mb-6">
                        <div class="glass-panel p-3 border-l-4 border-blue-500 col-span-2 md:col-span-1"><p class="text-[10px] font-bold text-gray-400 uppercase">Valor Mensal</p><p class="text-lg md:text-xl font-bold text-gray-800 truncate" id="kpi-receita">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-green-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Aulas</p><p class="text-lg font-bold text-gray-800" id="kpi-aulas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-orange-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Média Alunos</p><p class="text-lg font-bold text-gray-800" id="kpi-media-alunos">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-cyan-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Valor Médio</p><p class="text-lg font-bold text-gray-800" id="kpi-media-valor">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-purple-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Canceladas</p><p class="text-lg font-bold text-red-600" id="kpi-canceladas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-pink-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Unidades Mentoradas</p><p class="text-lg font-bold text-pink-600" id="kpi-unidades-count">0</p></div>
                    </div>
                    <div class="glass-panel overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"><h3 class="font-bold text-gray-700 text-sm uppercase"><i data-lucide="trending-up" class="w-4 h-4 inline"></i> Análise Geral</h3><button onclick="window.app.exportarExcel()" class="text-green-700 bg-green-50 px-3 py-1 rounded text-xs font-bold border border-green-200 flex gap-2 uppercase">Excel</button></div>
                        <div class="overflow-x-auto max-h-[500px]">
                            <table class="w-full table-custom text-left min-w-[800px] uppercase" id="tabela-relatorio">
                                <thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600" id="header-relatorio">
                                    <!-- Cabeçalho agora fixo no HTML para garantir a estrutura correta -->
                                    <tr>
                                        <th class="p-3">Unidade</th>
                                        <th class="p-3">Mentor</th>
                                        <th class="p-3">Professor</th>
                                        <th class="p-3 text-center">Média Alunos</th>
                                        <th class="p-3 text-center">Valor Hora Aula</th>
                                        <th class="p-3 text-center">Valor Mensal</th>
                                    </tr>
                                </thead>
                                <tbody id="body-relatorio"></tbody>
                            </table>
                        </div>
                        <div id="relatorio-empty" class="p-8 text-center text-gray-400 hidden">Nenhum dado encontrado.</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-4 border-t-4 border-gray-800"><h3 class="font-bold text-gray-800 mb-4 text-sm uppercase"><i data-lucide="award" class="w-5 h-5 inline"></i> Ranking Top 15</h3><table class="w-full text-xs text-left uppercase table-custom" id="tabela-ranking-alunos"><thead><tr><th onclick="window.app.ordenarRanking('pos')">Pos</th><th onclick="window.app.ordenarRanking('unidade')">Unidade/Detalhe</th><th onclick="window.app.ordenarRanking('media')" class="text-right">Média</th></tr></thead><tbody></tbody></table></div>
                        <div id="section-feriados" class="glass-panel border-l-4 border-red-400 bg-red-50/50 p-4 hidden"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-red-800 mb-2 uppercase"><i data-lucide="calendar-off" class="w-4 h-4"></i> Impacto Feriados</h3><p class="text-xl font-bold text-red-800" id="total-economizado">R$ 0,00</p></div><div class="text-[10px] text-red-600 mb-2 uppercase" id="feriados-lista-nomes"></div><div class="overflow-x-auto max-h-60 border border-red-200 rounded-lg bg-white"><table class="w-full text-xs text-left uppercase" id="tabela-canceladas"><thead class="text-red-900 border-b border-red-200 sticky top-0 bg-red-50"><tr><th class="py-2 px-3">Data</th><th class="py-2 px-3">Feriado</th><th class="py-2 px-3">Unidade</th><th class="py-2 px-3 text-right">Impacto</th></tr></thead><tbody class="text-red-800 text-xs"></tbody></table></div></div>
                    </div>
                </div>

                <!-- CRONOGRAMA (RESTAURADO) -->
                <div id="view-cronograma" class="view-section hidden pb-20">
                    <div class="glass-panel p-4 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-4">
                            <div class="w-full md:w-auto flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Selecionar Unidade</label>
                                <select id="cronograma-unidade-select" class="w-full p-2 border border-blue-200 rounded text-sm bg-white font-bold text-gray-700 h-10 uppercase focus:ring-2 focus:ring-blue-500 outline-none" onchange="window.app.renderCronograma()"></select>
                            </div>
                            <button onclick="window.app.abrirModalAdicao()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded text-sm shadow-md transition flex items-center gap-2 uppercase h-10">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Criar Aula
                            </button>
                        </div>
                        
                        <!-- Área de Validação Mensal -->
                        <div id="cronograma-validacao-container" class="mt-6"></div>
                    </div>

                    <!-- Grade Visual -->
                    <div class="glass-panel overflow-hidden">
                        <div id="cronograma-container" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- CONFIG: REESTRUTURADO EM ABAS -->
                <div id="view-config" class="view-section hidden pb-20">
                    <div class="glass-panel p-4 mb-6">
                        
                        <!-- Navegação Principal -->
                        <div class="flex gap-4 border-b border-gray-200 mb-6">
                            <button onclick="window.app.switchConfigTab('cadastro')" id="tab-cadastro" class="config-tab active pb-2 px-4 text-sm font-bold uppercase text-blue-600 border-blue-600">
                                <i data-lucide="folder-plus" class="w-4 h-4 inline mr-1"></i> Cadastros
                            </button>
                            <button onclick="window.app.switchConfigTab('ferramentas')" id="tab-ferramentas" class="config-tab pb-2 px-4 text-sm font-bold uppercase text-gray-500 hover:text-blue-600">
                                <i data-lucide="tool" class="w-4 h-4 inline mr-1"></i> Ferramentas Avançadas
                            </button>
                        </div>
                        
                        <!-- SUBVIEW CADASTRO -->
                        <div id="subview-cadastro">
                            <!-- Abas de Cadastro (Visual Melhorado) -->
                            <div class="flex gap-3 overflow-x-auto mb-6 pb-2 border-b border-gray-100 py-1">
                                <button onclick="window.app.switchCadastroSubTab('mentor')" id="subtab-cad-mentor" class="subtab-btn active">
                                    <i data-lucide="graduation-cap" class="w-4 h-4"></i> Mentores
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('modalidade')" id="subtab-cad-modalidade" class="subtab-btn inactive">
                                    <i data-lucide="dumbbell" class="w-4 h-4"></i> Modalidades
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('feriado')" id="subtab-cad-feriado" class="subtab-btn inactive">
                                    <i data-lucide="calendar-off" class="w-4 h-4"></i> Feriados
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('unidade')" id="subtab-cad-unidade" class="subtab-btn inactive">
                                    <i data-lucide="map-pin" class="w-4 h-4"></i> Unidades
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('grade')" id="subtab-cad-grade" class="subtab-btn inactive">
                                    <i data-lucide="calendar-clock" class="w-4 h-4"></i> Grade Horária
                                </button>
                            </div>

                            <!-- Conteúdo: Cadastrar Mentor -->
                            <div id="view-cad-mentor" class="cad-content-block">
                                <div class="max-w-2xl admin-only-block relative">
                                    <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-gray-50 p-2 rounded">Cadastrar Novo Mentor</h3>
                                    <div class="flex gap-2 mb-3">
                                        <input id="cad-mentor-nome" placeholder="NOME DO MENTOR" class="w-full p-2 border rounded text-xs uppercase">
                                        <input id="cad-mentor-senha" placeholder="SENHA" class="w-24 p-2 border rounded text-xs text-center bg-yellow-50" value="1234">
                                        <button onclick="window.app.addMentor()" class="bg-gray-800 text-white px-4 rounded text-xs hover:bg-black h-9 font-bold uppercase" id="btn-add-mentor">Adicionar</button>
                                    </div>
                                    <input type="hidden" id="edit-mentor-id">
                                    <h3 class="font-bold text-gray-800 mb-2 mt-6 text-xs uppercase">Mentores Cadastrados</h3>
                                    <ul id="lista-mentores" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase text-gray-600 border rounded p-2 bg-gray-50"></ul>
                                </div>
                            </div>

                            <!-- Conteúdo: Cadastrar Modalidade -->
                            <div id="view-cad-modalidade" class="cad-content-block hidden">
                                <div class="max-w-2xl admin-only-block">
                                    <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-pink-50 text-pink-700 p-2 rounded border border-pink-100">Cadastrar Modalidade</h3>
                                    <div class="flex gap-2 mb-3 items-center">
                                        <input id="cad-mod-nome" placeholder="NOME DA MODALIDADE" class="flex-1 p-2 border rounded text-xs uppercase">
                                        <input type="color" id="cad-mod-cor" class="w-9 h-9 rounded cursor-pointer border p-0" value="#3b82f6">
                                        <button onclick="window.app.addModalidade()" class="bg-pink-600 text-white px-4 py-2 rounded text-xs hover:bg-pink-700 h-9 uppercase font-bold" id="btn-add-modalidade">Salvar</button>
                                    </div>
                                    <input type="hidden" id="edit-modalidade-id">
                                    <h3 class="font-bold text-gray-800 mb-2 mt-6 text-xs uppercase">Modalidades Ativas</h3>
                                    <ul id="lista-modalidades" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase border rounded p-2 bg-gray-50"></ul>
                                </div>
                            </div>

                            <!-- Conteúdo: Cadastrar Feriado -->
                            <div id="view-cad-feriado" class="cad-content-block hidden">
                                <div class="max-w-2xl admin-only-block">
                                    <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-yellow-50 text-yellow-700 p-2 rounded border border-yellow-100">Gestão de Feriados</h3>
                                    <div class="space-y-2 mb-3 bg-white p-4 border rounded-lg">
                                        <input id="feriado-nome" placeholder="NOME DO FERIADO" class="w-full p-2 border rounded text-xs uppercase">
                                        <div class="flex gap-2">
                                            <div class="w-1/2">
                                                <label class="text-[10px] text-gray-500 font-bold">INÍCIO</label>
                                                <input type="date" id="feriado-data" class="w-full p-2 border rounded text-xs">
                                            </div>
                                            <div class="w-1/2">
                                                <label class="text-[10px] text-gray-500 font-bold">FIM</label>
                                                <input type="date" id="feriado-data-fim" class="w-full p-2 border rounded text-xs">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <select id="feriado-tipo" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.toggleFeriadoLocal()">
                                                <option value="global">GLOBAL</option>
                                                <option value="nacional">NACIONAL</option>
                                                <option value="estadual">ESTADUAL</option>
                                            </select>
                                            <select id="feriado-local" class="w-full p-2 border rounded text-xs bg-white uppercase hidden"></select>
                                        </div>
                                        <button onclick="window.app.addFeriado()" class="w-full bg-yellow-600 text-white py-2 rounded text-xs font-bold hover:bg-yellow-700 h-9 uppercase mt-2">ADICIONAR FERIADO</button>
                                    </div>
                                    <ul id="lista-feriados" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase border rounded p-2 bg-gray-50"></ul>
                                </div>
                            </div>

                            <!-- Conteúdo: Cadastrar Unidade -->
                            <div id="view-cad-unidade" class="cad-content-block hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                                    <div>
                                        <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-blue-50 text-blue-700 p-2 rounded border border-blue-100">Nova Unidade</h3>
                                        <div class="space-y-3 bg-white p-4 border rounded-lg">
                                            <select id="cad-unidade-mentor" class="w-full p-2 border rounded text-xs bg-white uppercase"><option value="">MENTOR...</option></select>
                                            <input id="cad-unidade-nome" placeholder="NOME DA UNIDADE" class="w-full p-2 border rounded text-xs uppercase">
                                            <input id="cad-unidade-senha" placeholder="SENHA DE ACESSO" class="w-full p-2 border rounded text-xs h-9 bg-yellow-50 text-center font-bold" value="1234">
                                            <div class="grid grid-cols-2 gap-2">
                                                <select id="cad-unidade-pais" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.atualizarEstados()">
                                                    <option value="">PAÍS...</option>
                                                    <option value="Brasil">BRASIL</option>
                                                    <option value="Estados Unidos">ESTADOS UNIDOS</option>
                                                    <option value="Argentina">ARGENTINA</option>
                                                </select>
                                                <select id="cad-unidade-estado" class="w-full p-2 border rounded text-xs bg-white uppercase"></select>
                                            </div>
                                            <button onclick="window.app.addUnidade()" class="w-full bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700 h-9 uppercase">SALVAR UNIDADE</button>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase">Unidades Cadastradas</h3>
                                        <input placeholder="BUSCAR UNIDADE..." class="w-full p-2 border rounded text-xs mb-2 bg-slate-50 uppercase" onkeyup="window.app.filtrarListaUnidades(this.value)">
                                        <ul id="lista-unidades" class="space-y-2 max-h-[300px] overflow-y-auto text-xs text-gray-600 uppercase border rounded p-2 bg-gray-50"></ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Conteúdo: Cadastrar Grade -->
                            <div id="view-cad-grade" class="cad-content-block hidden">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-green-50 text-green-700 p-2 rounded border border-green-100">Configurar Grade Horária</h3>
                                        <div class="space-y-3 bg-white p-4 border rounded-lg shadow-sm">
                                            <div>
                                                <label class="text-[10px] font-bold text-gray-400">ONDE?</label>
                                                <select id="grade-unidade" class="w-full p-2 border rounded text-xs bg-white font-bold text-gray-700 mb-1 h-9 uppercase"></select>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label class="text-[10px] font-bold text-gray-400">MODALIDADE</label>
                                                    <select id="grade-modalidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase"></select>
                                                </div>
                                                <div>
                                                    <label class="text-[10px] font-bold text-gray-400">PROFESSOR</label>
                                                    <input id="grade-prof" placeholder="NOME" class="w-full p-2 border rounded text-xs uppercase">
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label class="text-[10px] font-bold text-gray-400">VALOR (R$)</label>
                                                    <input type="number" id="grade-valor" placeholder="0.00" class="w-full p-2 border rounded text-xs h-9">
                                                </div>
                                                <div>
                                                    <label class="text-[10px] font-bold text-orange-500">MÉDIA ALUNOS</label>
                                                    <input type="number" id="grade-alunos" placeholder="0" class="w-full p-2 border rounded text-xs border-orange-200 h-9">
                                                </div>
                                            </div>
                                            <div class="grid grid-cols-2 gap-2">
                                                <div>
                                                    <label class="text-[10px] font-bold text-gray-400">HORA</label>
                                                    <input type="time" id="grade-hora" class="w-full p-2 border rounded text-xs h-9">
                                                </div>
                                                <div>
                                                    <label class="text-[10px] font-bold text-gray-400">DIAS</label>
                                                    <div class="flex gap-1 flex-wrap" id="check-dias"></div>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="window.app.addHorario()" id="btn-save-grade" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow-md text-xs mt-2 transition h-10 uppercase">ADICIONAR</button>
                                                <button onclick="window.app.cancelarEdicao()" id="btn-cancel-grade" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded shadow-md text-xs mt-2 transition h-10 uppercase">CANCELAR</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase">Últimas Grades Cadastradas</h3>
                                        <div id="lista-grades-recentes" class="space-y-2 uppercase border rounded p-2 bg-gray-50 h-[320px] overflow-y-auto"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SUBVIEW FERRAMENTAS -->
                        <div id="subview-ferramentas" class="hidden">
                            <!-- Abas de Ferramentas (Visual Melhorado) -->
                            <div class="flex gap-3 overflow-x-auto mb-6 pb-2 border-b border-gray-100 py-1">
                                <button onclick="window.app.switchFerramentasSubTab('senhas')" id="subtab-ferr-senhas" class="subtab-btn active">
                                    <i data-lucide="key" class="w-4 h-4"></i> Senhas
                                </button>
                                <button onclick="window.app.switchFerramentasSubTab('import-uni')" id="subtab-ferr-import-uni" class="subtab-btn inactive">
                                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> Importar Unidades
                                </button>
                                <button onclick="window.app.switchFerramentasSubTab('import-grade')" id="subtab-ferr-import-grade" class="subtab-btn inactive">
                                    <i data-lucide="upload-cloud" class="w-4 h-4 text-green-600"></i> Importar Grades
                                </button>
                                <button onclick="window.app.switchFerramentasSubTab('export')" id="subtab-ferr-export" class="subtab-btn inactive">
                                    <i data-lucide="download" class="w-4 h-4"></i> Exportar
                                </button>
                                <button onclick="window.app.switchFerramentasSubTab('backup')" id="subtab-ferr-backup" class="subtab-btn inactive">
                                    <i data-lucide="database" class="w-4 h-4"></i> Backup
                                </button>
                            </div>

                            <!-- Conteúdo: Senhas -->
                            <div id="view-ferr-senhas" class="ferr-content-block">
                                <div class="flex justify-between items-center mb-4 bg-red-50 p-3 rounded border border-red-100">
                                    <h2 class="font-bold text-gray-800 flex items-center gap-2 uppercase text-xs"><i data-lucide="shield-alert" class="w-4 h-4 text-red-600"></i> Área de Segurança</h2>
                                    <button onclick="window.app.resetarBancoDeDados()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase">⚠️ Resetar Sistema (Pânico)</button>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div>
                                        <h4 class="font-bold text-xs text-gray-500 uppercase mb-2 border-b pb-1">Mentores</h4>
                                        <div class="relative mb-2">
                                            <input type="text" placeholder="BUSCAR..." class="w-full p-2 pl-8 border rounded text-xs bg-slate-50 uppercase focus:border-blue-500 transition" onkeyup="window.app.renderAcessos('mentores', this.value)">
                                            <i data-lucide="search" class="absolute left-2.5 top-2.5 w-3 h-3 text-gray-400"></i>
                                        </div>
                                        <div class="max-h-60 overflow-y-auto pr-2 space-y-2 border rounded p-2" id="lista-senhas-mentores"></div>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-xs text-gray-500 uppercase mb-2 border-b pb-1">Unidades</h4>
                                        <div class="relative mb-2">
                                            <input type="text" placeholder="BUSCAR..." class="w-full p-2 pl-8 border rounded text-xs bg-slate-50 uppercase focus:border-blue-500 transition" onkeyup="window.app.renderAcessos('unidades', this.value)">
                                            <i data-lucide="search" class="absolute left-2.5 top-2.5 w-3 h-3 text-gray-400"></i>
                                        </div>
                                        <div class="max-h-60 overflow-y-auto pr-2 space-y-2 border rounded p-2" id="lista-senhas-unidades"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Conteúdo: Importar Unidades -->
                            <div id="view-ferr-import-uni" class="ferr-content-block hidden">
                                <div class="max-w-2xl">
                                    <h2 class="font-bold text-gray-800 mb-2 uppercase text-xs">Importação em Massa de Unidades</h2>
                                    <p class="text-[10px] text-gray-400 mb-2">Formato: NOME;MENTOR(ignorado);ESTADO;PAIS</p>
                                    <textarea id="import-unidades-text" class="w-full h-40 p-3 border rounded text-xs mb-2 bg-slate-50 font-mono" placeholder="Ex: UNIDADE CENTRO;;MG;BRASIL"></textarea>
                                    <button onclick="window.app.importarUnidades()" class="bg-blue-600 text-white px-4 py-2 rounded text-xs w-full font-bold uppercase hover:bg-blue-700">Processar Importação</button>
                                </div>
                            </div>

                            <!-- Conteúdo: Importar Grades -->
                            <div id="view-ferr-import-grade" class="ferr-content-block hidden">
                                <div class="max-w-2xl">
                                    <h2 class="font-bold text-gray-800 mb-2 uppercase text-xs">Importação em Massa de Grades</h2>
                                    <p class="text-[10px] text-gray-400 mb-2">Formato: UNIDADE;MODALIDADE;PROFESSOR;DIAS;HORA;VALOR;ALUNOS</p>
                                    <textarea id="import-grades-text" class="w-full h-40 p-3 border rounded text-xs mb-2 bg-slate-50 font-mono" placeholder="Ex: UNIDADE CENTRO;JUMP;JOAO;Segunda,Quarta;19:00;50;20"></textarea>
                                    <button onclick="window.app.importarGrades()" class="bg-green-600 text-white px-4 py-2 rounded text-xs w-full font-bold uppercase hover:bg-green-700">Processar Importação</button>
                                </div>
                            </div>

                            <!-- Conteúdo: Exportação -->
                            <div id="view-ferr-export" class="ferr-content-block hidden">
                                <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2 uppercase text-xs"><i data-lucide="download" class="w-4 h-4"></i> Central de Exportação</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <button onclick="window.app.exportarUnidadesCSV()" class="bg-orange-50 hover:bg-orange-100 border border-orange-200 text-orange-700 px-6 py-6 rounded-lg text-xs font-bold flex flex-col items-center justify-center gap-2 uppercase transition">
                                        <i data-lucide="file-spreadsheet" class="w-8 h-8"></i> 
                                        <span>Exportar Lista de Unidades (.CSV)</span>
                                    </button>
                                    <button onclick="window.app.exportarGrades()" class="bg-green-50 hover:bg-green-100 border border-green-200 text-green-700 px-6 py-6 rounded-lg text-xs font-bold flex flex-col items-center justify-center gap-2 uppercase transition">
                                        <i data-lucide="file-spreadsheet" class="w-8 h-8"></i> 
                                        <span>Exportar Grades Completas (.CSV)</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Conteúdo: Backup -->
                            <div id="view-ferr-backup" class="ferr-content-block hidden">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                                    <h2 class="font-bold text-gray-800 mb-6 uppercase text-xs text-center border-b pb-2">Gerenciamento de Backup</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="text-center">
                                            <p class="text-[10px] text-gray-500 mb-2 uppercase font-bold">Salvar Dados</p>
                                            <button onclick="window.app.salvarBackup()" class="bg-gray-800 hover:bg-black text-white px-6 py-3 rounded font-bold w-full flex items-center justify-center gap-2 uppercase text-xs">
                                                <i data-lucide="save" class="w-4 h-4"></i> Baixar Arquivo .JSON
                                            </button>
                                        </div>
                                        <div class="text-center border-l border-gray-200 pl-8">
                                            <p class="text-[10px] text-gray-500 mb-2 uppercase font-bold">Restaurar Dados</p>
                                            <div class="flex gap-2 items-center">
                                                <input type="file" id="input-backup-file" accept=".json" class="text-xs w-full border rounded p-2 bg-white">
                                            </div>
                                            <button onclick="window.app.restaurarBackup()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-xs font-bold uppercase w-full mt-2">
                                                Restaurar Agora
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTÓRICO -->
                <div id="view-historico" class="view-section hidden pb-20">
                    <div class="glass-panel p-6">
                        <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2 uppercase"><i data-lucide="history" class="w-5 h-5 text-blue-600"></i> Histórico</h2>
                        <div class="overflow-x-auto max-h-[600px] border rounded-lg"><table class="w-full text-xs text-left uppercase table-custom"><thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600"><tr><th class="p-3">Data/Hora</th><th class="p-3">Usuário</th><th class="p-3">Ação</th><th class="p-3">Detalhe</th><th class="p-3">Anterior</th><th class="p-3">Novo</th></tr></thead><tbody id="lista-historico" class="bg-white text-gray-700"></tbody></table></div>
                    </div>
                </div>

                <!-- ABA ACESSO MENSAL (NOVA VERSÃO REACT-INSPIRED) -->
                <div id="view-acesso" class="view-section hidden pb-20">
                     <!-- Conteúdo injetado via JS (renderAcessoMensal) -->
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL FLUTUANTE (DRAG-AND-DROP) -->
    <div id="modal-editor" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden modal-overlay">
        <!-- Adicionado cursor-grab para indicar movimento -->
        <div id="modal-card" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-none relative max-h-[90vh] flex flex-col">
            <!-- Header Arrastável -->
            <div id="modal-header" class="bg-blue-600 p-4 flex justify-between items-center text-white cursor-grab select-none active:cursor-grabbing hover:bg-blue-700 transition-colors">
                <h3 class="font-bold text-lg flex items-center gap-2 uppercase">
                    <i data-lucide="move" class="w-4 h-4 text-white/50"></i> 
                    <span id="modal-titulo">Editar Aula</span>
                </h3>
                <button onclick="window.app.fecharModal()" class="hover:bg-blue-800 p-1 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="modal-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Unidade</label>
                        <input type="text" id="modal-unidade-view" class="w-full p-2.5 border border-gray-300 rounded bg-gray-100 text-xs font-bold text-gray-600 h-10 uppercase" disabled>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Modalidade *</label>
                        <select id="modal-modalidade" class="w-full p-2.5 border border-gray-300 rounded text-xs bg-white h-10 uppercase focus:border-blue-500 outline-none"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Professor Responsável *</label>
                    <input type="text" id="modal-prof" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 uppercase focus:border-blue-500 outline-none" placeholder="NOME DO PROFESSOR">
                </div>
                <div class="grid grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Início *</label>
                        <input type="time" id="modal-hora" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Valor</label>
                        <input type="number" id="modal-valor" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Alunos</label>
                        <input type="number" id="modal-alunos" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none" placeholder="0">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Dias da Semana *</label>
                    <div class="flex flex-wrap gap-2 p-2 border rounded bg-gray-50" id="modal-dias-container"></div>
                </div>
            </div>
            
            <div class="bg-gray-50 p-4 flex justify-between gap-3 border-t">
                <button onclick="window.app.excluirViaModal()" id="btn-excluir-modal" class="text-red-500 hover:text-red-700 text-xs font-bold px-4 py-2 flex items-center gap-2 uppercase border border-red-200 rounded hover:bg-red-50 transition">
                    <i data-lucide="trash-2" class="w-4 h-4"></i> Excluir
                </button>
                <div class="flex gap-2">
                    <button onclick="window.app.fecharModal()" class="text-gray-500 hover:text-gray-700 font-bold py-2 px-4 rounded text-xs uppercase">Cancelar</button>
                    <button onclick="window.app.salvarModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded text-sm shadow-md transition uppercase flex items-center gap-2">
                        <i data-lucide="save" class="w-4 h-4"></i> Salvar Aula
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-4 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-[70] flex items-center gap-4 border-l-4 border-green-500 max-w-[90%]"><div id="toast-icon" class="text-2xl">✅</div><div><h4 id="toast-title" class="font-bold text-sm uppercase">Sucesso</h4><p id="toast-msg" class="text-xs opacity-80 uppercase">Operação realizada.</p></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { window.app = new SistemaPratique(); });

        class SistemaPratique {
            constructor() {
                this.db = { mentores: [], unidades: [], modalidades: [], horarios: [], historico: [], feriados: [], acessos: [] };
                this.apiUrl = 'https://script.google.com/macros/s/AKfycbz8LU_ekbnZ7tAwrvxyaASzql0Cvqe-HAVGhWpO-TkOWot3AcWjpAALTB3u2bOGx8hbfA/exec';
                this.currentUser = null;
                this.editingId = null;
                this.dadosExibidos = [];
                this.modoAgrupamento = 'detalhado';
                this.ordenacao = { campo: 'receita', direcao: 'desc' };
                this.rankingData = [];
                this.ordenacaoRanking = { campo: 'media', direcao: 'desc' };
                this.ordenacaoStatus = { campo: 'unidade', direcao: 'asc' };
                this.mobileMenuOpen = false;
                
                // --- NOVOS STATES ACESSO MENSAL ---
                this.currentAcessoTab = 'ranking'; // 'ranking', 'status', 'detalhe'
                this.acessoFilterTerm = '';
                this.acessoStatusSort = { field: 'unidade', direction: 'asc' };
                this.validacaoCheck = false; // Checkbox de validação mensal

                this.constantes = {
                    dias: ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"],
                    meses: ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"],
                    feriadosFixos: [{d:1,m:0,nome:"CONF. UNIVERSAL"}, {d:21,m:3,nome:"TIRADENTES"}, {d:1,m:4,nome:"DIA DO TRABALHO"}, {d:7,m:8,nome:"INDEPENDÊNCIA"}, {d:12,m:9,nome:"N. SRA. APARECIDA"}, {d:2,m:10,nome:"FINADOS"}, {d:15,m:10,nome:"PROCLAMAÇÃO"}, {d:25,m:11,nome:"Natal"}],
                    paisesEstados: { 'Brasil': ["AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO"], 'Estados Unidos': ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"], 'Argentina': ["Buenos Aires", "Catamarca", "Chaco", "Chubut", "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan", "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del Fuego", "Tucumán"] }
                };
                this.init();
                this.setupDraggableModal();
            }

            init() {
                this.carregarDadosLocais();
                this.setupUI();
                const sessionUser = sessionStorage.getItem('pratique_user');
                if(sessionUser) { this.currentUser = JSON.parse(sessionUser); this.postLoginSetup(); }
                setTimeout(() => lucide.createIcons(), 500);
            }

            // --- UTILITARIOS ---
            normalizeStr(str) { return str ? str.toString().trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ' ') : ""; }
            safeToggle(id, cls, action) { const el = document.getElementById(id); if(el) { if(action==='add') el.classList.add(cls); else if(action==='remove') el.classList.remove(cls); else el.classList.toggle(cls); } }
            notify(t, m) { const x = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; x.classList.remove('translate-x-full'); setTimeout(() => x.classList.add('translate-x-full'), 3000); }

            // --- CORE ---
            carregarDadosLocais() {
                const salvo = localStorage.getItem('pratique_global_db_v5');
                if (salvo) { try { this.db = JSON.parse(salvo); this.sanitizeDB(); } catch(e) { this.seedInicial(); } } else { this.seedInicial(); }
            }

            sanitizeDB() {
                if(!this.db.acessos) this.db.acessos = [];
                (this.db.unidades||[]).forEach(u => u.senha = String(u.senha || '1234'));
                (this.db.mentores||[]).forEach(m => m.senha = String(m.senha || '1234'));
            }

            seedInicial() { 
                // DADOS DO BACKUP INJETADOS
                this.db = { mentores: [{id:1,nome:"FELIPE SOUZA", senha:"1234"}], modalidades: [{id:1,nome:"JUMP",cor:"#ff5722"}], unidades: [{id:101,nome:"PRATIQUE SAVASSI",mentorId:1,estado:"MG",pais:"Brasil", senha:"1234"}], horarios: [], historico: [], feriados: [], acessos: [] };
                this.salvarDados(); 
            }
            
            salvarDados() { localStorage.setItem('pratique_global_db_v5', JSON.stringify(this.db)); this.sincronizarNuvem('upload'); }

            async sincronizarNuvem(acao) {
                try {
                    const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text');
                    if(dot) dot.className = 'status-dot status-sync'; if(txt) txt.innerText = 'Sync...';
                    if (acao === 'download') {
                        const r = await fetch(this.apiUrl);
                        if(r.ok) { const d = await r.json(); if(d && d.unidades) { this.db = d; this.sanitizeDB(); this.salvarDados(); this.atualizarListas(); } }
                    } else {
                        await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify(this.db) });
                    }
                    if(dot) dot.className = 'status-dot status-online'; if(txt) txt.innerText = 'Online';
                } catch(e) { const dot = document.getElementById('status-dot'); if(dot) dot.className = 'status-dot status-offline'; const txt = document.getElementById('status-text'); if(txt) txt.innerText = 'Offline'; }
            }

            forcarSincronizacao() { this.sincronizarNuvem('download'); }
            
            registrarLog(acao, detalhe, ant, nov) {
                if(!this.db.historico) this.db.historico = [];
                this.db.historico.unshift({ id: Date.now(), data: new Date().toLocaleString(), usuario: this.currentUser?.name||'Sys', acao, detalhe, anterior: ant, novo: nov });
                if(this.db.historico.length > 1000) this.db.historico.length = 1000;
                this.salvarDados();
            }

            // --- UI SETUP ---
            setupUI() {
                const elData = document.getElementById('data-atual'); if(elData) elData.innerText = new Date().toLocaleDateString('pt-BR');
                const selMes = document.getElementById('rel-mes');
                if(selMes) selMes.innerHTML = this.constantes.meses.map((m, i) => `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`).join('');
                const divDias = document.getElementById('check-dias');
                if(divDias) divDias.innerHTML = this.constantes.dias.map(d => `<label class="cursor-pointer select-none"><input type="checkbox" value="${d}" class="peer sr-only check-dia-input"><div class="px-2 py-1 text-[10px] uppercase border rounded bg-white text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition">${d.substring(0,3)}</div></label>`).join('');
                const divDiasModal = document.getElementById('modal-dias-container');
                if(divDiasModal) divDiasModal.innerHTML = this.constantes.dias.map(d => `<label class="cursor-pointer select-none"><input type="checkbox" value="${d}" class="peer sr-only modal-check-dia"><div class="px-2 py-1 text-[10px] uppercase border rounded bg-white text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition shadow-sm hover:bg-gray-50">${d.substring(0,3)}</div></label>`).join('');
                this.atualizarEstados();
            }
            
            atualizarEstados() {
                const p = document.getElementById('cad-unidade-pais'); const s = document.getElementById('cad-unidade-estado');
                if(p && s) {
                    const list = this.constantes.paisesEstados[p.value] || [];
                    s.innerHTML = list.map(e => `<option value="${e}">${e}</option>`).join('');
                }
            }

            // --- NAVEGAÇÃO DE CONFIGURAÇÃO (ABAS) ---

            switchConfigTab(tab) {
                // Abas Principais (Cadastro vs Ferramentas)
                const tabCadastro = document.getElementById('tab-cadastro');
                const tabFerramentas = document.getElementById('tab-ferramentas');
                const viewCadastro = document.getElementById('subview-cadastro');
                const viewFerramentas = document.getElementById('subview-ferramentas');

                if (tab === 'cadastro') {
                    tabCadastro?.classList.add('active', 'text-blue-600', 'border-blue-600');
                    tabCadastro?.classList.remove('text-gray-500');
                    tabFerramentas?.classList.remove('active', 'text-blue-600', 'border-blue-600');
                    tabFerramentas?.classList.add('text-gray-500');
                    viewCadastro?.classList.remove('hidden');
                    viewFerramentas?.classList.add('hidden');
                    this.switchCadastroSubTab('mentor'); // Default subtab
                } else {
                    tabFerramentas?.classList.add('active', 'text-blue-600', 'border-blue-600');
                    tabFerramentas?.classList.remove('text-gray-500');
                    tabCadastro?.classList.remove('active', 'text-blue-600', 'border-blue-600');
                    tabCadastro?.classList.add('text-gray-500');
                    viewFerramentas?.classList.remove('hidden');
                    viewCadastro?.classList.add('hidden');
                    this.switchFerramentasSubTab('senhas'); // Default subtab
                }
            }

            switchCadastroSubTab(subTab) {
                // Sub-abas de Cadastro (Mentor, Modalidade, etc)
                const tabs = ['mentor', 'modalidade', 'feriado', 'unidade', 'grade'];
                
                tabs.forEach(t => {
                    const btn = document.getElementById(`subtab-cad-${t}`);
                    const content = document.getElementById(`view-cad-${t}`);
                    
                    if (t === subTab) {
                        btn.classList.add('active');
                        btn.classList.remove('inactive');
                        content.classList.remove('hidden');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('inactive');
                        content.classList.add('hidden');
                    }
                });
            }

            switchFerramentasSubTab(subTab) {
                // Sub-abas de Ferramentas (Senhas, Import, etc)
                const tabs = ['senhas', 'import-uni', 'import-grade', 'export', 'backup'];
                
                tabs.forEach(t => {
                    const btn = document.getElementById(`subtab-ferr-${t}`);
                    const content = document.getElementById(`view-ferr-${t}`);
                    
                    if (t === subTab) {
                        btn.classList.add('active');
                        btn.classList.remove('inactive');
                        content.classList.remove('hidden');
                    } else {
                        btn.classList.remove('active');
                        btn.classList.add('inactive');
                        content.classList.add('hidden');
                    }
                });
            }

            setAcessoTab(tab) {
                this.currentAcessoTab = tab;
                this.renderAcessoMensal();
            }

            setAcessoFilter(val) {
                this.acessoFilterTerm = val;
                this.renderAcessoMensal();
            }
            
            sortAcessoStatus(field) {
                if (this.acessoStatusSort.field === field) {
                    this.acessoStatusSort.direction = this.acessoStatusSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.acessoStatusSort = { field, direction: 'asc' };
                }
                this.renderAcessoMensal();
            }

            // --- LOGIN ---
            login() {
                const uRaw = document.getElementById('login-user').value;
                const pass = document.getElementById('login-pass').value.trim();
                const uClean = this.normalizeStr(uRaw);
                
                if (uClean === 'ADMIN' && pass === 'admin123') return this.completeLogin({ id: 'admin', name: 'ADMINISTRADOR', role: 'admin' });

                const mentor = this.db.mentores.find(m => this.normalizeStr(m.nome) === uClean);
                if (mentor && String(mentor.senha) === pass) return this.completeLogin({ id: mentor.id, name: mentor.nome, role: 'mentor' });

                const unit = this.db.unidades.find(x => this.normalizeStr(x.nome) === uClean);
                if (unit && String(unit.senha) === pass) return this.completeLogin({ id: unit.id, name: unit.nome, role: 'unidade' });

                document.getElementById('login-error').classList.remove('hidden');
            }

            completeLogin(user) {
                this.currentUser = user;
                sessionStorage.setItem('pratique_user', JSON.stringify(user));
                this.safeToggle('login-screen', 'hidden', 'add');
                this.safeToggle('app-container', 'hidden', 'remove');
                this.postLoginSetup();
                this.notify('success', `Bem-vindo ${user.name}`);
            }
            
            logout() { sessionStorage.removeItem('pratique_user'); window.location.reload(); }

            postLoginSetup() {
                const elName = document.getElementById('user-name');
                const elRole = document.getElementById('user-role');
                const elAvatar = document.getElementById('user-avatar');

                if(elName) elName.innerText = this.currentUser.name;
                if(elRole) elRole.innerText = this.currentUser.role.toUpperCase();
                if(elAvatar) elAvatar.innerText = this.currentUser.name.charAt(0);

                // Permissoes
                this.safeToggle('nav-config', 'disabled', 'remove');
                this.safeToggle('admin-filters-container', 'hidden', 'remove');
                this.safeToggle('nav-historico', 'hidden', 'add');
                document.querySelectorAll('.admin-only-block').forEach(el => el.classList.remove('hidden'));

                if(this.currentUser.role === 'admin') {
                    this.safeToggle('nav-historico', 'hidden', 'remove');
                    this.safeToggle('nav-acesso', 'hidden', 'remove');
                    this.renderHistorico();
                } 
                
                if (this.currentUser.role === 'mentor') {
                    this.safeToggle('admin-filters-container', 'hidden', 'add');
                    this.safeToggle('nav-acesso', 'hidden', 'remove');
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden'));
                }

                if (this.currentUser.role === 'unidade') {
                    this.safeToggle('nav-config', 'disabled', 'add');
                    this.safeToggle('admin-filters-container', 'hidden', 'add');
                    this.safeToggle('filter-mentor-wrapper', 'hidden', 'add');
                    this.safeToggle('filter-unidade-wrapper', 'hidden', 'add');
                    this.safeToggle('nav-acesso', 'hidden', 'add');
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden'));
                }

                this.atualizarListas();
                this.nav('cronograma'); // Default to cronograma on login as requested
            }

            nav(view) {
                if(view === 'historico' && this.currentUser.role !== 'admin') return alert('Acesso Negado');
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                const target = document.getElementById(`view-${view}`);
                if (target) target.classList.remove('hidden');
                
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                const link = document.getElementById(`nav-${view}`);
                if (link) link.classList.add('active');
                
                if(this.mobileMenuOpen) this.toggleMenu();
                
                if(view === 'relatorio') this.gerarRelatorio();
                if(view === 'cronograma') this.renderCronograma();
                if(view === 'acesso') {
                    // Inicializa mes/ano se nao tiver
                    if(!this.acessoMesSelecionado) {
                        this.acessoMesSelecionado = new Date().getMonth();
                        this.acessoAnoSelecionado = new Date().getFullYear();
                    }
                    this.renderAcessoMensal();
                }
                if(view === 'config') this.switchConfigTab('cadastro');

                lucide.createIcons();
            }

            toggleMenu() {
                this.mobileMenuOpen = !this.mobileMenuOpen;
                const sb = document.getElementById('sidebar');
                const ov = document.getElementById('mobile-menu-overlay');
                if(this.mobileMenuOpen) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
                else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
            }

            // --- LOGICA DE NEGOCIO ---

            atualizarListas() {
                const pop = (id, list) => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = '<option value="">SELECIONE...</option>' + list.map(i => `<option value="${i.id}">${i.nome}</option>`).join('');
                };

                let units = this.db.unidades;
                if(this.currentUser.role === 'mentor') units = units.filter(u => u.mentorId == this.currentUser.id);
                if(this.currentUser.role === 'unidade') units = units.filter(u => u.id == this.currentUser.id);
                units.sort((a,b) => a.nome.localeCompare(b.nome));

                pop('cronograma-unidade-select', units);
                pop('rel-unidade', units);
                pop('rel-mentor', this.db.mentores);
                pop('rel-modalidade', this.db.modalidades);
                pop('cad-unidade-mentor', this.db.mentores);
                pop('grade-unidade', units);
                pop('grade-modalidade', this.db.modalidades);
                pop('modal-modalidade', this.db.modalidades);

                const renderList = (id, list, type) => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = list.map(i => `
                        <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1">
                            <span class="text-xs font-bold text-gray-700">${i.nome}</span>
                            <div class="flex gap-2">
                                <button onclick="window.app.prepareEdit('${type}', '${i.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                <button onclick="window.app.deleteItem('${type}', '${i.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </li>`).join('');
                };

                renderList('lista-mentores', this.db.mentores, 'mentores');
                
                const listaModalidades = document.getElementById('lista-modalidades');
                if(listaModalidades) {
                     listaModalidades.innerHTML = this.db.modalidades.map(m => `
                        <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1" style="border-left: 4px solid ${m.cor}">
                            <span class="text-xs font-bold text-gray-700">${m.nome}</span>
                            <div class="flex gap-2">
                                <button onclick="window.app.prepareEdit('modalidades', '${m.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="pencil" class="w-3 h-3"></i></button>
                                <button onclick="window.app.deleteItem('modalidades', '${m.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </li>`).join('');
                }
                
                const listaUnidades = document.getElementById('lista-unidades');
                if (listaUnidades) {
                     listaUnidades.innerHTML = this.db.unidades.sort((a,b)=>a.nome.localeCompare(b.nome)).map(u => `
                        <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1">
                            <div>
                                <div class="text-xs font-bold text-gray-700">${u.nome}</div>
                                <div class="text-[10px] text-gray-500">${u.estado}, ${u.pais}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="window.app.deleteItem('unidades', '${u.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </li>`).join('');
                }

                this.renderAcessos('mentores');
                this.renderAcessos('unidades');
                this.renderGradesRecentes();
                this.renderListaFeriados(); 
            }

            renderGradesRecentes() { 
                const lista = document.getElementById('lista-grades-recentes');
                if (!lista) return;
                let grades = this.db.horarios || [];
                
                if(this.currentUser && this.currentUser.role === 'mentor') {
                    grades = grades.filter(g => { 
                        const u = this.db.unidades.find(un => un.id == g.unidadeId); 
                        return u && u.mentorId == this.currentUser.id; 
                    });
                } else if(this.currentUser && this.currentUser.role === 'unidade') {
                    grades = grades.filter(g => g.unidadeId == this.currentUser.id);
                }
                
                lista.innerHTML = grades.slice(-10).reverse().map(h => {
                    const u = this.db.unidades.find(x=>x.id==h.unidadeId || parseInt(x.id) === parseInt(h.unidadeId))?.nome || '?';
                    return `<div class="flex justify-between items-center border-b p-2 text-xs mb-1 bg-white uppercase rounded hover:bg-gray-50">
                        <span class="truncate pr-2"><b>${u}</b><br>${h.professor} - ${h.hora}</span> 
                        <div class="flex gap-1 flex-shrink-0">
                            <button onclick="window.app.editarHorario('${h.id}')" class="text-blue-500 hover:bg-blue-50 p-1 rounded"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.app.remover('horarios','${h.id}')" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </div>`
                }).join(''); 
                lucide.createIcons();
            }

            renderAcessos(tipo, termo) {
                 let lista = tipo === 'mentores' ? this.db.mentores : this.db.unidades;
                 if(termo) lista = lista.filter(i => i.nome.includes(termo.toUpperCase()));
                 const el = document.getElementById(`lista-senhas-${tipo}`);
                 if(el) el.innerHTML = lista.map(i => `<div class="flex justify-between border-b p-1 text-xs mb-1"><span>${i.nome}</span> <div class="flex gap-2 items-center"><input class="w-16 border rounded text-center" value="${i.senha}" id="pass-${i.id}"><button onclick="window.app.savePassword('${tipo}', '${i.id}')">💾</button></div></div>`).join('');
            }
            
            savePassword(type, id) {
                const newVal = document.getElementById(`pass-${type}-${id}`).value;
                if(!newVal) return alert('Senha vazia!');
                const item = this.db[type].find(x => x.id == id);
                if(item) {
                    const oldPass = item.senha;
                    item.senha = newVal;
                    this.registrarLog('Alteração Senha', `${type === 'mentores' ? 'Mentor' : 'Unidade'}: ${item.nome}`, oldPass, newVal);
                    this.salvarDados();
                    this.notify('success', 'SENHA ATUALIZADA!');
                }
            }
            
            // --- CRONOGRAMA & MODAL ---
            
            setupDraggableModal() {
                 const modal = document.getElementById('modal-card');
                 const header = document.getElementById('modal-header');
                 if(!modal || !header) return;
                 let isDragging = false, startX, startY, initialLeft, initialTop;
                 
                 header.addEventListener('mousedown', (e) => { 
                    if(e.target.closest('button')) return; // Ignore close button
                    isDragging = true; 
                    startX = e.clientX; 
                    startY = e.clientY; 
                    const style = window.getComputedStyle(modal); 
                    const matrix = new DOMMatrixReadOnly(style.transform); 
                    initialLeft = matrix.m41; 
                    initialTop = matrix.m42; 
                    header.classList.add('cursor-grabbing');
                 });
                 
                 window.addEventListener('mousemove', (e) => { 
                    if (!isDragging) return; 
                    e.preventDefault(); 
                    const dx = e.clientX - startX; 
                    const dy = e.clientY - startY; 
                    modal.style.transform = `translate(${initialLeft + dx}px, ${initialTop + dy}px)`; 
                 });
                 
                 window.addEventListener('mouseup', () => { 
                    if(isDragging) { 
                        isDragging = false; 
                        header.classList.remove('cursor-grabbing'); 
                    } 
                 });
            }
            
            renderCronograma() {
                const uid = document.getElementById('cronograma-unidade-select').value; 
                const c = document.getElementById('cronograma-container');
                const validacaoContainer = document.getElementById('cronograma-validacao-container');
                
                if(!uid) {
                    c.innerHTML='<div class="py-10 text-center text-gray-400 uppercase font-bold text-xs border-2 border-dashed border-gray-200 rounded-lg">SELECIONE UMA UNIDADE PARA VISUALIZAR A GRADE</div>';
                    if(validacaoContainer) validacaoContainer.innerHTML = '';
                    return;
                }

                const h = this.db.horarios.filter(x=>x.unidadeId==uid || parseInt(x.unidadeId) === parseInt(uid)); 
                const times = [...new Set(h.map(x=>x.hora))].sort();
                
                // Cabeçalho da Tabela
                let ht = `<table class="w-full border-collapse min-w-[800px] text-xs">
                    <thead>
                        <tr>
                            <th class="p-3 border-b-2 border-gray-100 bg-gray-50 text-gray-500 w-20">HORA</th>
                            ${this.constantes.dias.map(d=>`<th class="p-3 border-b-2 border-gray-100 bg-gray-50 text-gray-700 uppercase">${d}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>`;
                
                // Linhas de Horário (ou linhas vazias se não houver horário)
                const displayTimes = times.length ? times : ["07:00", "08:00", "09:00", "18:00", "19:00", "20:00"];
                
                displayTimes.forEach(t => {
                    ht += `<tr><td class="p-3 border-b border-gray-50 text-center font-bold text-gray-400 bg-gray-50/50">${t}</td>`;
                    this.constantes.dias.forEach(d => {
                        const a = h.find(x=>x.hora===t && x.dias.includes(d));
                        if(a) {
                            const mod = this.db.modalidades.find(m=>m.id==a.modalidadeId);
                            const bgColor = mod?.cor || '#64748b';
                            // Aula Card
                            ht += `
                            <td class="p-1 border-b border-gray-50 h-24 w-[13%] align-top">
                                <div onclick="window.app.abrirModalEdicao('${a.id}')" class="aula-card w-full h-full p-2 rounded-lg text-white shadow-sm relative cursor-pointer hover:shadow-md transition-all group overflow-hidden" style="background: linear-gradient(135deg, ${bgColor}, ${this.adjustColor(bgColor, -20)})">
                                    <div class="flex flex-col justify-between h-full">
                                        <div>
                                            <div class="font-bold uppercase text-[10px] leading-tight opacity-70 mb-1">${mod?.nome}</div>
                                            <div class="font-bold text-xs truncate">${a.professor}</div>
                                        </div>
                                        <div class="text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex justify-end">
                                            <i data-lucide="edit-2" class="w-3 h-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </td>`;
                        } else {
                            ht += `<td class="border-b border-gray-50 hover:bg-slate-50 transition-colors"></td>`;
                        }
                    });
                    ht += `</tr>`;
                });
                c.innerHTML = ht + `</tbody></table>`; 
                lucide.createIcons();
                
                // --- LÓGICA DE VALIDAÇÃO MENSAL RESTAURADA ---
                if(validacaoContainer) {
                    const unidadeSelecionada = this.db.unidades.find(u => u.id == uid);
                    const podeValidar = (this.currentUser.role === 'admin') || (this.currentUser.role === 'unidade' && this.currentUser.id == uid) || (this.currentUser.role === 'mentor' && unidadeSelecionada && unidadeSelecionada.mentorId == this.currentUser.id);
                    
                    if(podeValidar) {
                        const hoje = new Date();
                        const mes = hoje.getMonth();
                        const ano = hoje.getFullYear();
                        const nomeMes = this.constantes.meses[mes];
                        const validacao = (this.db.acessos || []).find(a => a.unidadeId == uid && a.mes == mes && a.ano == ano);
                        
                        if(validacao) {
                            // Já validado
                            validacaoContainer.innerHTML = `
                            <div class="validation-box validated flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-green-800 flex items-center gap-2 uppercase text-xs">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i> Mês de ${nomeMes} Validado
                                    </h4>
                                    <p class="text-[10px] text-green-700 mt-1 uppercase">
                                        Validado por: <strong>${validacao.validadoPor}</strong> em ${new Date(validacao.data).toLocaleDateString()}
                                    </p>
                                    <p class="text-[10px] text-green-700">Status: <strong>${validacao.tipo === 'com_alteracao' ? 'COM ALTERAÇÕES' : 'SEM ALTERAÇÕES'}</strong></p>
                                </div>
                            </div>`;
                        } else {
                            // Pendente de validação (Restauração da Checkbox Obrigatória)
                            validacaoContainer.innerHTML = `
                            <div class="validation-box bg-red-50 border-red-200 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-1 h-full bg-red-500"></div>
                                <h4 class="font-bold text-red-800 flex items-center gap-2 uppercase mb-2 text-xs">
                                    <i data-lucide="alert-triangle" class="w-4 h-4"></i> Validação Mensal Obrigatória (${nomeMes})
                                </h4>
                                <p class="text-[10px] text-red-600 mb-3 uppercase">
                                    O mentor/gestor deve confirmar se o quadro de horários está atualizado.
                                </p>
                                
                                <div class="flex items-start gap-2 mb-4 bg-white p-3 rounded border border-red-100">
                                    <input type="checkbox" id="check-validacao-confirm" class="mt-0.5" onchange="window.app.toggleValidacaoBtn(this.checked)">
                                    <label for="check-validacao-confirm" class="text-[10px] text-gray-600 uppercase cursor-pointer select-none">
                                        Confirmo que revisei todos os horários, professores e estrutura do cronograma coletivo desta unidade.
                                    </label>
                                </div>

                                <div class="flex gap-2">
                                    <button onclick="window.app.confirmarValidacao('com_alteracao')" id="btn-val-com" disabled class="flex-1 bg-white border border-gray-300 text-gray-400 font-bold py-2 px-4 rounded text-xs uppercase shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:bg-yellow-50 hover:text-yellow-700 hover:border-yellow-400">
                                        Houve Alteração
                                    </button>
                                    <button onclick="window.app.confirmarValidacao('sem_alteracao')" id="btn-val-sem" disabled class="flex-1 bg-gray-300 text-white font-bold py-2 px-4 rounded text-xs uppercase shadow-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed hover:bg-blue-600">
                                        Não Houve Alteração
                                    </button>
                                </div>
                            </div>`;
                        }
                    } else {
                        validacaoContainer.innerHTML = '';
                    }
                }
                lucide.createIcons();
            }

            toggleValidacaoBtn(checked) {
                const btn1 = document.getElementById('btn-val-com');
                const btn2 = document.getElementById('btn-val-sem');
                if(btn1 && btn2) {
                    btn1.disabled = !checked;
                    btn2.disabled = !checked;
                    if(checked) {
                        btn2.classList.remove('bg-gray-300');
                        btn2.classList.add('bg-blue-600');
                    } else {
                        btn2.classList.add('bg-gray-300');
                        btn2.classList.remove('bg-blue-600');
                    }
                }
            }

            confirmarValidacao(tipo) {
                const uid = document.getElementById('cronograma-unidade-select').value;
                const mes = new Date().getMonth();
                const ano = new Date().getFullYear();
                
                if(!confirm('Deseja realmente confirmar a validação deste mês? Esta ação ficará registrada.')) return;

                this.db.acessos = (this.db.acessos || []).filter(a => !(a.unidadeId == uid && a.mes == mes && a.ano == ano));
                this.db.acessos.push({ unidadeId: uid, mes, ano, tipo, validadoPor: this.currentUser.name, data: new Date().toISOString() });
                this.salvarDados(); 
                this.renderCronograma();
                this.notify('success', 'Mês validado com sucesso!');
            }
            
            // Auxiliar para escurecer cor (para gradiente)
            adjustColor(color, amount) {
                return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2));
            }
            
            // --- MODAL ---

            abrirModalAdicao() { this.abrirModalEdicao(null); }

            abrirModalEdicao(id) {
                const uid = document.getElementById('cronograma-unidade-select').value;
                if(!uid && !id) return alert('Selecione uma unidade primeiro!');

                const modal = document.getElementById('modal-editor');
                const titulo = document.getElementById('modal-titulo');
                const btnExcluir = document.getElementById('btn-excluir-modal');

                // Reset
                ['modal-prof', 'modal-hora', 'modal-valor', 'modal-alunos'].forEach(i => document.getElementById(i).value = '');
                document.querySelectorAll('.modal-check-dia').forEach(c => c.checked = false);

                // Populate Modalidade Select inside Modal
                const selMod = document.getElementById('modal-modalidade');
                selMod.innerHTML = '<option value="">SELECIONE...</option>' + this.db.modalidades.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');

                if (id) {
                    const aula = this.db.horarios.find(h => h.id == id);
                    if(!aula) return;
                    document.getElementById('modal-id').value = id;
                    document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == aula.unidadeId)?.nome;
                    document.getElementById('modal-modalidade').value = aula.modalidadeId;
                    document.getElementById('modal-prof').value = aula.professor;
                    document.getElementById('modal-hora').value = aula.hora;
                    document.getElementById('modal-valor').value = aula.valor;
                    document.getElementById('modal-alunos').value = aula.mediaAlunos;
                    aula.dias.forEach(d => {
                        const ck = Array.from(document.querySelectorAll('.modal-check-dia')).find(c => c.value === d);
                        if(ck) ck.checked = true;
                    });
                    titulo.innerText = 'EDITAR AULA';
                    btnExcluir.classList.remove('hidden');
                } else {
                    document.getElementById('modal-id').value = '';
                    document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == uid)?.nome;
                    titulo.innerText = 'NOVA AULA COLETIVA';
                    btnExcluir.classList.add('hidden');
                }
                
                // Centralizar Modal ao abrir (reset position)
                const card = document.getElementById('modal-card');
                card.style.transform = 'none';
                
                modal.classList.remove('hidden');
            }

            salvarModal() {
                const id = document.getElementById('modal-id').value;
                const uid = document.getElementById('cronograma-unidade-select').value;
                const aulaUid = id ? this.db.horarios.find(h => h.id == id).unidadeId : uid;

                const novo = {
                    id: id || Date.now(),
                    unidadeId: parseInt(aulaUid),
                    modalidadeId: parseInt(document.getElementById('modal-modalidade').value),
                    professor: document.getElementById('modal-prof').value.toUpperCase(),
                    hora: document.getElementById('modal-hora').value,
                    valor: parseFloat(document.getElementById('modal-valor').value) || 0,
                    mediaAlunos: parseInt(document.getElementById('modal-alunos').value) || 0,
                    dias: Array.from(document.querySelectorAll('.modal-check-dia:checked')).map(c => c.value)
                };

                if(!novo.modalidadeId || !novo.professor || !novo.hora || !novo.dias.length) return alert('Preencha os campos obrigatórios (*)');

                if (id) {
                    const idx = this.db.horarios.findIndex(h => h.id == id);
                    this.db.horarios[idx] = novo;
                } else {
                    this.db.horarios.push(novo);
                }
                this.salvarDados();
                this.renderCronograma();
                this.fecharModal();
                this.notify('success', 'Aula salva com sucesso!');
            }
            
            excluirViaModal() {
                 if(!confirm('Deseja excluir esta aula?')) return;
                 const id = document.getElementById('modal-id').value;
                 this.db.horarios = this.db.horarios.filter(h => h.id != id);
                 this.salvarDados();
                 this.renderCronograma();
                 this.fecharModal();
                 this.notify('success', 'Aula removida!');
            }

            fecharModal() { document.getElementById('modal-editor').classList.add('hidden'); }

            // --- OUTROS MÉTODOS EXISTENTES MANTIDOS (SEM ALTERAÇÃO) ---
            prepareEdit(type, id) {
                if (type === 'mentores') {
                    const item = this.db.mentores.find(m => m.id == id);
                    if (item) {
                        document.getElementById('cad-mentor-nome').value = item.nome;
                        document.getElementById('cad-mentor-senha').value = item.senha;
                        document.getElementById('edit-mentor-id').value = item.id;
                        document.getElementById('btn-add-mentor').innerText = 'Salvar';
                    }
                } else if (type === 'modalidades') {
                    const item = this.db.modalidades.find(m => m.id == id);
                    if (item) {
                        document.getElementById('cad-mod-nome').value = item.nome;
                        document.getElementById('cad-mod-cor').value = item.cor;
                        document.getElementById('edit-modalidade-id').value = item.id;
                        document.getElementById('btn-add-modalidade').innerText = 'Salvar';
                    }
                }
            }

            deleteItem(type, id) {
                if (confirm('Tem certeza que deseja excluir?')) {
                    this.db[type] = this.db[type].filter(i => i.id != id);
                    if (type === 'unidades') {
                        this.db.horarios = this.db.horarios.filter(h => h.unidadeId != id);
                    }
                    this.salvarDados();
                    this.atualizarListas();
                    this.notify('success', 'Item excluído com sucesso!');
                }
            }

            // ... (Restante do código mantido: addMentor, addUnidade, addModalidade, addHorario, remover, cancelarEdicao, editarHorario - Note que editarHorario foi redirecionado para abrirModalEdicao) ...
            
            editarHorario(id) {
                // Redireciona diretamente para o novo modal se estivermos na visualização correta, 
                // ou força a navegação
                this.nav('cronograma');
                // Pequeno delay para garantir que a UI renderizou antes de abrir o modal
                setTimeout(() => {
                    const h = this.db.horarios.find(x => x.id == id);
                    if(h) {
                         document.getElementById('cronograma-unidade-select').value = h.unidadeId;
                         this.renderCronograma(); // Renderiza para atualizar o contexto
                         this.abrirModalEdicao(id);
                    }
                }, 100);
            }
            
            // Métodos antigos de adição via aba Configuração mantidos para compatibilidade, 
            // mas UI principal agora usa o Modal.
            addMentor() {
                const id = document.getElementById('edit-mentor-id').value;
                const nome = document.getElementById('cad-mentor-nome').value.toUpperCase();
                const senha = document.getElementById('cad-mentor-senha').value;
                
                if (nome) {
                    if (id) {
                        const index = this.db.mentores.findIndex(m => m.id == id);
                        if (index !== -1) {
                            this.db.mentores[index] = { ...this.db.mentores[index], nome, senha };
                            this.notify('success', 'Mentor atualizado!');
                        }
                    } else {
                        this.db.mentores.push({id: Date.now(), nome, senha: String(senha)});
                        this.notify('success', 'Mentor cadastrado!');
                    }
                    this.salvarDados(); 
                    this.atualizarListas();
                    document.getElementById('cad-mentor-nome').value = '';
                    document.getElementById('cad-mentor-senha').value = '1234';
                    document.getElementById('edit-mentor-id').value = '';
                    document.getElementById('btn-add-mentor').innerText = 'Adicionar';
                }
            }

            addUnidade() {
                const nome = document.getElementById('cad-unidade-nome').value.toUpperCase();
                const mentor = document.getElementById('cad-unidade-mentor').value;
                const senha = document.getElementById('cad-unidade-senha').value;
                const pais = document.getElementById('cad-unidade-pais').value;
                const estado = document.getElementById('cad-unidade-estado').value;

                if(nome && mentor && pais && estado) {
                    this.db.unidades.push({id: Date.now(), nome, mentorId: mentor, senha: String(senha), pais, estado });
                    this.salvarDados(); this.atualizarListas();
                    document.getElementById('cad-unidade-nome').value = '';
                } else {
                    alert('Preencha todos os campos da unidade');
                }
            }

            addModalidade() {
                const id = document.getElementById('edit-modalidade-id').value;
                const nome = document.getElementById('cad-mod-nome').value.toUpperCase();
                const cor = document.getElementById('cad-mod-cor').value;
                
                if (nome) {
                    if (id) {
                        const index = this.db.modalidades.findIndex(m => m.id == id);
                        if (index !== -1) {
                            this.db.modalidades[index] = { ...this.db.modalidades[index], nome, cor };
                            this.notify('success', 'Modalidade atualizada!');
                        }
                    } else {
                        this.db.modalidades.push({id: Date.now(), nome, cor});
                        this.notify('success', 'Modalidade cadastrada!');
                    }
                    this.salvarDados(); 
                    this.atualizarListas();
                    document.getElementById('cad-mod-nome').value = '';
                    document.getElementById('edit-modalidade-id').value = '';
                    document.getElementById('btn-add-modalidade').innerText = 'Salvar';
                }
            }
            
            // AddHorario (Legado da aba config - mantido)
            addHorario() {
                 const u = document.getElementById('grade-unidade').value;
                 const m = document.getElementById('grade-modalidade').value;
                 const p = document.getElementById('grade-prof').value.toUpperCase();
                 const h = document.getElementById('grade-hora').value;
                 const v = parseFloat(document.getElementById('grade-valor').value)||0;
                 const al = parseInt(document.getElementById('grade-alunos').value)||0;
                 const dias = Array.from(document.querySelectorAll('.check-dia-input:checked')).map(c => c.value);

                 if(u && m && p && h && dias.length) {
                     const novo = { id: this.editingId || Date.now(), unidadeId: parseInt(u), modalidadeId: parseInt(m), professor: p.toUpperCase(), valor: v, mediaAlunos: al, hora: h, dias };
                     if(this.editingId) {
                         const idx = this.db.horarios.findIndex(x => x.id == this.editingId);
                         if(idx > -1) this.db.horarios[idx] = novo;
                     } else {
                         this.db.horarios.push(novo);
                     }
                     this.salvarDados(); this.renderGradesRecentes(); this.cancelarEdicao();
                 } else alert('Preencha tudo');
            }
            
            remover(tipo, id) {
                if(confirm('Tem certeza?')) {
                    this.db[tipo] = this.db[tipo].filter(i => i.id != id);
                    if(tipo === 'unidades') this.db.horarios = this.db.horarios.filter(h => h.unidadeId != id);
                    this.salvarDados(); this.atualizarListas(); this.renderCronograma();
                }
            }
            
            cancelarEdicao() { this.editingId=null; document.getElementById('grade-prof').value=''; document.querySelectorAll('.check-dia-input').forEach(c=>c.checked=false); document.getElementById('btn-save-grade').innerText='ADICIONAR'; document.getElementById('btn-cancel-grade').classList.add('hidden'); }
            
            // --- RELATORIO ---
            
            gerarRelatorio() {
                const mes = parseInt(document.getElementById('rel-mes').value);
                const ano = parseInt(document.getElementById('rel-ano').value);
                const fUni = document.getElementById('rel-unidade').value;
                const fMent = document.getElementById('rel-mentor').value;
                const fMod = document.getElementById('rel-modalidade').value;
                const fPais = document.getElementById('rel-pais').value;
                const fEst = document.getElementById('rel-estado').value;

                let feriados = this.constantes.feriadosFixos.filter(f => f.m === mes);
                
                let lista = this.db.horarios.filter(h => {
                    const u = this.db.unidades.find(unit => unit.id == h.unidadeId);
                    if(!u) return false;
                    
                    if(this.currentUser.role === 'mentor' && u.mentorId != this.currentUser.id) return false;
                    if(this.currentUser.role === 'unidade' && u.id != this.currentUser.id) return false;
                    
                    if(fUni && u.id != fUni) return false;
                    if(fMent && u.mentorId != fMent) return false;
                    if(fMod && h.modalidadeId != fMod) return false;
                    if(fPais && u.pais != fPais) return false;
                    if(fEst && u.estado != fEst) return false;
                    return true;
                });

                const totalReceita = lista.reduce((acc, h) => acc + (h.valor * 4), 0);
                const totalAulas = lista.length * 4;

                document.getElementById('kpi-receita').innerText = `R$ ${totalReceita.toFixed(2)}`;
                document.getElementById('kpi-aulas').innerText = totalAulas;
                document.getElementById('kpi-unidades-count').innerText = [...new Set(lista.map(h => h.unidadeId))].length;
                document.getElementById('relatorio-empty').classList.add('hidden');
                
                const tbody = document.getElementById('body-relatorio');
                
                // Mapeamento atualizado conforme solicitado:
                // Colunas: UNIDADE | MENTOR | PROFESSOR | MÉDIA ALUNOS | VALOR HORA | VALOR MENSAL
                tbody.innerHTML = lista.map(h => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     const m = this.db.mentores.find(x => x.id == u?.mentorId);
                     const valorMensal = h.valor * 4; // Cálculo do investimento total no mês
                     
                     return `<tr class="border-b hover:bg-slate-50 transition-colors">
                        <td class="p-3 text-xs font-bold text-gray-700">${u?.nome || '-'}</td>
                        <td class="p-3 text-xs text-gray-600 font-medium">${m?.nome || '-'}</td>
                        <td class="p-3 text-xs text-gray-600">${h.professor}</td>
                        <td class="p-3 text-xs text-center font-bold text-gray-700">${h.mediaAlunos}</td>
                        <td class="p-3 text-xs text-center font-mono text-gray-600">R$ ${h.valor.toFixed(2)}</td>
                        <td class="p-3 text-xs text-center font-mono font-bold text-blue-600">R$ ${valorMensal.toFixed(2)}</td>
                     </tr>`;
                }).join('');

                const rankBody = document.querySelector('#tabela-ranking-alunos tbody');
                rankBody.innerHTML = lista.slice(0, 15).map((h, i) => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     return `<tr class="border-b"><td class="font-bold text-blue-600">${i+1}</td><td>${u?.nome} - ${h.professor}</td><td class="text-right font-bold">${h.mediaAlunos}</td></tr>`;
                }).join('');
            }
            
            atualizarFiltrosRelatorio(tipo) {
                 const elPais = document.getElementById('rel-pais');
                 const elEstado = document.getElementById('rel-estado');
                 const elMentor = document.getElementById('rel-mentor');
                 const elUnidade = document.getElementById('rel-unidade');

                 const valPais = elPais.value;
                 const valEstado = elEstado.value;
                 const valMentor = elMentor.value;
                 const valUnidade = elUnidade.value;

                 const populate = (el, list, val, def) => {
                     const value = el.value;
                     el.innerHTML = `<option value="">${def}</option>` + list.map(i => `<option value="${i.id||i}">${i.nome||i}</option>`).join('');
                     if(value && list.some(i => (i.id||i) == value)) el.value = value;
                 };

                 if(tipo === 'init' || tipo === 'pais') {
                     const paises = [...new Set(this.db.unidades.map(u => u.pais).filter(Boolean))];
                     populate(elPais, paises, null, "TODOS");
                 }
                 
                 if(tipo === 'init' || tipo === 'pais') {
                     const pais = elPais.value;
                     const estados = [...new Set(this.db.unidades.filter(u => !pais || u.pais === pais).map(u => u.estado).filter(Boolean))];
                     populate(elEstado, estados, null, "TODOS");
                 }

                 if (tipo === 'init' || tipo === 'pais' || tipo === 'estado') {
                     const pais = elPais.value;
                     const estado = elEstado.value;
                     const units = this.db.unidades.filter(u => (!pais || u.pais === pais) && (!estado || u.estado === estado));
                     const mIds = [...new Set(units.map(u => u.mentorId))];
                     const mentors = this.db.mentores.filter(m => mIds.includes(m.id));
                     populate(elMentor, mentors, null, "TODOS");
                 }
                 
                 if (tipo === 'init' || tipo === 'pais' || tipo === 'estado' || tipo === 'mentor') {
                     const pais = elPais.value;
                     const estado = elEstado.value;
                     const mentor = elMentor.value;
                     const units = this.db.unidades.filter(u => 
                        (!pais || u.pais === pais) && 
                        (!estado || u.estado === estado) &&
                        (!mentor || u.mentorId == mentor)
                     );
                     populate(elUnidade, units, null, "TODAS");
                 }
            }
            exportarExcel() { alert('Função simplificada nesta versão estável.'); }

            // --- ADMIN ---
            renderHistorico() {
                const t = document.getElementById('lista-historico');
                if(t) t.innerHTML = (this.db.historico || []).slice(0, 50).map(h => `<tr class="border-b"><td class="p-2">${h.data}</td><td class="p-2 font-bold">${h.usuario}</td><td class="p-2">${h.acao}</td><td class="p-2 text-gray-500 truncate max-w-xs">${h.detalhe}</td></tr>`).join('');
            }

            toggleFeriadoLocal() {
                const tipo = document.getElementById('feriado-tipo').value;
                const localSelect = document.getElementById('feriado-local');
                localSelect.innerHTML = '';
                if (tipo === 'global') localSelect.classList.add('hidden');
                else {
                    localSelect.classList.remove('hidden');
                    const lista = tipo === 'nacional' ? Object.keys(this.constantes.paisesEstados) : Object.values(this.constantes.paisesEstados).flat();
                    localSelect.innerHTML = [...new Set(lista)].map(p => `<option value="${p}">${p}</option>`).join('');
                }
            }
            
            addFeriado() {
                const nome = document.getElementById('feriado-nome').value.trim().toUpperCase();
                const dataInicio = document.getElementById('feriado-data').value;
                if(!nome || !dataInicio) return alert('PREENCHA NOME E DATA!');
                this.db.feriados.push({ id: Date.now(), nome, data: dataInicio, tipo: document.getElementById('feriado-tipo').value, local: document.getElementById('feriado-local').value });
                this.salvarDados(); this.renderListaFeriados();
                document.getElementById('feriado-nome').value = '';
            }
            
            renderListaFeriados() {
                const lista = document.getElementById('lista-feriados');
                if(lista) lista.innerHTML = this.db.feriados.map(f => `<li class="flex justify-between border-b p-1 text-xs"><span>${f.nome} (${f.data})</span><button class="text-red-500" onclick="window.app.remover('feriados', ${f.id})">x</button></li>`).join('');
            }
            
            // --- IMPORT/EXPORT/BACKUP ---
            parseImportLines(t) { if(!t.trim()) return []; return t.split('\n').map(l=>l.includes('\t')?l.split('\t'):l.split(';')).filter(c=>c.length>1 && c[0]); }
            
            importarUnidades() { 
                const txt = document.getElementById('import-unidades-text').value;
                const lines = this.parseImportLines(txt); 
                let count = 0;
                lines.forEach((c, index) => { 
                    if(index === 0 && (c[0]||'').toUpperCase().includes('UNIDADE')) return; 
                    if(c[0]){ 
                        const nome = c[0].toUpperCase().trim();
                        if(!this.db.unidades.find(u => u.nome === nome)) { 
                            this.db.unidades.push({
                                id: Date.now()+Math.random(), 
                                nome: nome, 
                                mentorId: 1, 
                                estado: (c[2]||'MG').trim().toUpperCase(), 
                                pais: (c[3]||'Brasil').trim(), 
                                senha: '1234'
                            });
                            count++;
                        }
                    } 
                }); 
                this.registrarLog('Importação', 'Unidades em Massa', '-', `${count} registros`);
                this.salvarDados(); this.atualizarListas(); 
                this.notify('success', `${count} Unidades importadas!`);
            }
            
            importarGrades() { 
                const txt = document.getElementById('import-grades-text').value;
                const lines = this.parseImportLines(txt); 
                let count = 0;
                lines.forEach((c, index) => { 
                    if(index === 0 && (c[0]||'').toUpperCase().includes('UNIDADE')) return; 
                    if(c.length>=5){ 
                        const uName = (c[0]||'').toUpperCase().trim();
                        const mName = (c[1]||'').toUpperCase().trim();
                        const u = this.db.unidades.find(x=>x.nome==uName); 
                        const m = this.db.modalidades.find(x=>x.nome==mName); 
                        
                        if(u && m) { 
                            this.db.horarios.push({
                                id: Date.now()+Math.random(), 
                                unidadeId: u.id, 
                                modalidadeId: m.id, 
                                professor: (c[2]||'').toUpperCase(), 
                                dias: (c[3]||'').split(',').map(d=>d.trim()), 
                                hora: c[4], 
                                valor: parseFloat(c[5])||0, 
                                mediaAlunos: parseInt(c[6])||0
                            }); 
                            count++;
                        }
                    } 
                }); 
                this.registrarLog('Importação', 'Grades em Massa', '-', `${count} registros`);
                this.salvarDados(); this.renderGradesRecentes(); 
                this.notify('success', `${count} Aulas importadas!`);
            }
            
            salvarBackup() {
                const data = JSON.stringify(this.db, null, 2);
                const blob = new Blob([data], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_gestao_pratique_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.notify('success', 'BACKUP GERADO!');
            }

            restaurarBackup() {
                const input = document.getElementById('input-backup-file');
                if (!input.files.length) return alert('SELECIONE O ARQUIVO .JSON');
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.mentores && json.unidades && json.horarios) {
                            this.db = json;
                            this.registrarLog('Restauração', 'Backup Completo', '-', 'Sistema Restaurado');
                            this.salvarDados();
                            this.init();
                            this.notify('success', 'SISTEMA RESTAURADO!');
                        } else {
                            alert('ARQUIVO INVÁLIDO OU ANTIGO');
                        }
                    } catch (err) {
                        alert('ERRO AO LER ARQUIVO');
                    }
                };
                reader.readAsText(file);
            }
            
            exportarUnidadesCSV() {
                let csv = "\uFEFFUnidade;Mentor;Estado;Pais\n";
                this.db.unidades.forEach(u => {
                    const m = this.db.mentores.find(x => x.id == u.mentorId)?.nome || '-';
                    csv += `${u.nome};${m};${u.estado};${u.pais}\n`;
                });
                this.downloadCSV(csv, "Lista_Unidades.csv");
            }

            exportarGrades() {
                let csv = "\uFEFFUnidade;Modalidade;Professor;Dias;Hora;Valor;MediaAlunos\n";
                this.db.horarios.forEach(h => {
                    const u = this.db.unidades.find(x => x.id == h.unidadeId)?.nome || "?";
                    const m = this.db.modalidades.find(x => x.id == h.modalidadeId)?.nome || "?";
                    csv += `${u};${m};${h.professor};"${h.dias.join(',')}";${h.hora};${h.valor};${h.mediaAlunos}\n`;
                });
                this.downloadCSV(csv, "Grades_Pratique.csv");
            }
            
            downloadCSV(csv, name) {
                const b = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const l = document.createElement("a"); l.href=URL.createObjectURL(b); l.download=name; document.body.appendChild(l); l.click(); document.body.removeChild(l);
            }
            
            updateAcessoDate(val) {
                const [y, m] = val.split('-');
                this.acessoMesSelecionado = parseInt(m) - 1;
                this.acessoAnoSelecionado = parseInt(y);
                this.renderAcessoMensal();
            }

            renderAcessoMensal() {
                const container = document.getElementById('view-acesso');
                if(!container) return;

                const mes = this.acessoMesSelecionado;
                const ano = this.acessoAnoSelecionado;
                const mesStr = (mes + 1).toString().padStart(2, '0');
                
                let unidades = this.db.unidades;
                let mentores = this.db.mentores;
                
                if (this.currentUser.role === 'mentor') {
                    mentores = mentores.filter(m => m.id == this.currentUser.id);
                    unidades = unidades.filter(u => u.mentorId == this.currentUser.id);
                } else if (this.currentUser.role === 'unidade') {
                    unidades = unidades.filter(u => u.id == this.currentUser.id);
                }

                // KPIs
                const totalUnidades = unidades.length;
                const validacoesMes = (this.db.acessos || []).filter(a => a.mes == mes && a.ano == ano && unidades.some(u => u.id == a.unidadeId)).length;
                const pendencias = totalUnidades - validacoesMes;
                const percentualGeral = totalUnidades > 0 ? Math.round((validacoesMes / totalUnidades) * 100) : 0;

                let html = `
                <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-slate-900 uppercase">Acesso Mensal</h1>
                            <p class="text-slate-500 text-xs uppercase">Gestão e acompanhamento de validações</p>
                        </div>
                        <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm">
                            <div class="p-2 bg-slate-100 rounded-md">
                                <i data-lucide="calendar" class="w-5 h-5 text-slate-600"></i>
                            </div>
                            <input type="month" value="${ano}-${mesStr}" onchange="window.app.updateAcessoDate(this.value)" class="bg-transparent border-none text-sm font-semibold text-slate-700 focus:ring-0 cursor-pointer uppercase"/>
                        </div>
                    </header>
                    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Total de Unidades</p><h3 class="text-3xl font-bold text-slate-800">${totalUnidades}</h3></div><div class="p-3 rounded-lg bg-blue-500"><i data-lucide="building-2" class="w-6 h-6 text-white"></i></div></div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Validações</p><h3 class="text-3xl font-bold text-slate-800">${validacoesMes}</h3></div><div class="p-3 rounded-lg bg-emerald-500"><i data-lucide="check-circle" class="w-6 h-6 text-white"></i></div></div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Pendências</p><h3 class="text-3xl font-bold text-slate-800">${pendencias}</h3></div><div class="p-3 rounded-lg bg-red-500"><i data-lucide="alert-circle" class="w-6 h-6 text-white"></i></div></div>
                    </section>
                    <div class="min-h-[200px] text-center text-slate-400 p-8 border border-dashed rounded-lg bg-slate-50 uppercase text-xs">Aba simplificada para visualização de dados. Use as abas anteriores para gestão detalhada.</div>
                </div>`;
                container.innerHTML = html;
                lucide.createIcons();
            }
        }

        window.app = new SistemaPratique();
    </script>
</body>
</html>
