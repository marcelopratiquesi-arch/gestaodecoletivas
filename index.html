
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pratique Coletivas - Gestão Completa</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        pratique: {
                            blue: '#0056b3', lightBlue: '#3b82f6', red: '#e63946',
                            gray: '#f3f4f6', dark: '#1e293b', sidebar: '#0f172a'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(10px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .glass-panel { background: white; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left-color: #60a5fa; }
        .sidebar-link.disabled { opacity: 0.3; pointer-events: none; display: none; }
        .table-custom th { background-color: #f8fafc; color: #475569; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; font-weight: 700; cursor: pointer; }
        .table-custom td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .aula-card { transition: transform 0.2s, box-shadow 0.2s; position: relative; cursor: pointer; }
        .aula-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-sync { background-color: #f59e0b; animation: pulse 1s infinite; }
        .login-bg { background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); }
        
        /* ESTILOS ESPECÍFICOS PARA O NOVO RELATÓRIO E CONFIG */
        .tab-btn {
            padding: 10px 20px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            border-bottom: 2px solid transparent;
            color: #64748b;
            transition: all 0.3s;
        }
        .tab-btn:hover { color: #3b82f6; background-color: #f8fafc; }
        .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; background-color: white; }

        /* NOVOS ESTILOS PARA SUB-ABAS COLORIDAS E MAIORES (V15) */
        .subtab-btn { 
            @apply flex flex-col items-center justify-center gap-2 px-4 py-4 text-xs font-bold uppercase rounded-xl border-2 transition-all shadow-sm flex-shrink-0 cursor-pointer; 
            min-width: 110px;
            height: 90px; /* Mais alto para caber ícone grande */
        }
        .subtab-btn i { width: 32px; height: 32px; margin-bottom: 2px; transition: transform 0.2s; } /* Ícone maior */
        .subtab-btn:hover i { transform: scale(1.1); }
        
        /* Cores Específicas por Aba Ativa */
        .subtab-btn.mentor-active { background-color: #eff6ff; color: #1d4ed8; border-color: #3b82f6; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2); }
        .subtab-btn.modalidade-active { background-color: #fdf2f8; color: #be185d; border-color: #ec4899; box-shadow: 0 4px 6px -1px rgba(236, 72, 153, 0.2); }
        .subtab-btn.unidade-active { background-color: #ecfeff; color: #0e7490; border-color: #06b6d4; box-shadow: 0 4px 6px -1px rgba(6, 182, 212, 0.2); }
        .subtab-btn.grade-active { background-color: #f5f3ff; color: #6d28d9; border-color: #8b5cf6; box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2); }
        .subtab-btn.feriado-active { background-color: #fefce8; color: #a16207; border-color: #eab308; box-shadow: 0 4px 6px -1px rgba(234, 179, 8, 0.2); }
        
        .subtab-btn.inactive { 
            @apply bg-white text-gray-400 border-gray-100 hover:bg-gray-50 hover:text-gray-600 hover:border-gray-300; 
        }

        /* ACESSO MENSAL STYLES */
        .acesso-tab-btn { white-space: nowrap; padding: 1rem 0.25rem; border-bottom-width: 2px; font-weight: 500; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; transition: color 0.2s, border-color 0.2s; }
        .acesso-tab-btn.active { border-color: #6366f1; color: #4f46e5; }
        .acesso-tab-btn.inactive { border-color: transparent; color: #64748b; }
        
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm font-sans bg-slate-50">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center login-bg p-4">
        <div class="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white tracking-tight mb-2">PRATIQUE <span class="text-blue-400">COLETIVAS</span></h1>
                <p class="text-blue-200 text-xs uppercase tracking-widest">Gestão Completa</p>
            </div>
            
            <form onsubmit="event.preventDefault(); window.app.login();" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Usuário / Mentor / Unidade</label>
                    <div class="relative"><i data-lucide="user" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="text" id="login-user" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition uppercase" placeholder="Nome de Acesso" required></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Senha</label>
                    <div class="relative"><i data-lucide="lock" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="password" id="login-pass" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition" placeholder="••••••••" required></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs tracking-wider flex items-center justify-center gap-2"><i data-lucide="log-in" class="w-4 h-4"></i> Acessar Sistema</button>
            </form>
            <div class="mt-6 text-center text-[10px] text-slate-400"><span class="font-bold text-blue-400">Admin:</span> admin / admin123 <br> <span class="font-bold text-blue-400">Padrão:</span> Nome / 1234</div>
            <div id="login-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded text-red-200 text-xs text-center font-bold uppercase">Credenciais Inválidas</div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        <div id="mobile-menu-overlay" onclick="window.app.toggleMenu()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-pratique-sidebar text-gray-400 flex flex-col flex-shrink-0 transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none no-print">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <div><h1 class="text-xl font-bold text-white tracking-tight">PRATIQUE <span class="text-blue-500">COLETIVAS</span></h1><p class="text-xs mt-1 opacity-60">Gestão Completa</p></div>
                <button onclick="window.app.toggleMenu()" class="md:hidden text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="window.app.nav('relatorio')" id="nav-relatorio" class="sidebar-link active w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> Relatório Gerencial</button>
                <button onclick="window.app.nav('cronograma')" id="nav-cronograma" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="calendar" class="w-5 h-5"></i> Cronograma Visual</button>
                <button onclick="window.app.nav('acesso')" id="nav-acesso" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="user-check" class="w-5 h-5"></i> Acesso Mensal</button>
                <button onclick="window.app.nav('config')" id="nav-config" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="settings" class="w-5 h-5"></i> Configurações</button>
                <button onclick="window.app.nav('historico')" id="nav-historico" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="history" class="w-5 h-5"></i> Histórico</button>
            </nav>
            <div class="p-4 border-t border-gray-800 bg-gray-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs" id="user-avatar">U</div>
                    <div class="overflow-hidden"><p class="text-white text-xs font-bold truncate" id="user-name">...</p><p class="text-[10px] text-gray-500" id="user-role">...</p></div>
                    <button onclick="window.app.logout()" class="ml-auto text-red-400 hover:text-red-300" title="Sair"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
                <div class="mt-2 text-[10px] flex items-center gap-1 opacity-50"><span class="status-dot status-offline" id="status-dot"></span> <span id="status-text">Offline</span></div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative w-full">
            <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-4 md:px-8 flex-shrink-0 z-10 sticky top-0 no-print">
                <div class="flex items-center gap-3"><button onclick="window.app.toggleMenu()" class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button><h2 id="page-title" class="text-lg font-bold text-gray-700 truncate">Visão Geral</h2></div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button onclick="window.app.forcarSincronizacao()" class="text-xs font-bold text-gray-500 hover:text-blue-600 flex items-center gap-1 mr-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync</button>
                    <span id="data-atual" class="hidden md:inline-block text-xs font-mono text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                    <button onclick="window.app.salvarBackup()" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1 bg-blue-50 p-2 rounded-lg"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden md:inline">Backup</span></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="main-content">
                
                <!-- RELATÓRIO GERENCIAL -->
                <div id="view-relatorio" class="view-section pb-20">
                    <div class="glass-panel p-4 md:p-6 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 text-sm uppercase"><i data-lucide="filter" class="w-4 h-4 text-blue-500"></i> Filtros Gerenciais</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3 items-end">
                            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Mês</label><select id="rel-mes" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"></select></div>
                            <div class="col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Ano</label><input type="number" id="rel-ano" class="w-full p-2 border rounded text-xs h-9 uppercase text-center font-bold text-gray-700" value="2025" onchange="window.app.gerarRelatorio()"></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">País</label><select id="rel-pais" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('pais'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Estado</label><select id="rel-estado" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('estado'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1" id="filter-mentor-wrapper"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Mentor</label><select id="rel-mentor" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('mentor'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1" id="filter-unidade-wrapper"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Unidade</label><select id="rel-unidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('unidade'); window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Modalidade</label><select id="rel-modalidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><button onclick="window.app.gerarRelatorio()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-xs uppercase flex items-center justify-center gap-2 h-9 shadow-sm"><i data-lucide="search" class="w-3 h-3"></i> Atualizar</button></div>
                        </div>
                    </div>

                    <!-- KPIS -->
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4 mb-6">
                        <div class="glass-panel p-3 border-l-4 border-blue-500 col-span-2 md:col-span-1"><p class="text-[10px] font-bold text-gray-400 uppercase">Valor Mensal</p><p class="text-lg md:text-xl font-bold text-gray-800 truncate" id="kpi-receita">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-green-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Aulas</p><p class="text-lg font-bold text-gray-800" id="kpi-aulas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-orange-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Média Alunos</p><p class="text-lg font-bold text-gray-800" id="kpi-media-alunos">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-cyan-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Valor Médio</p><p class="text-lg font-bold text-gray-800" id="kpi-media-valor">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-purple-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Canceladas</p><p class="text-lg font-bold text-purple-600" id="kpi-canceladas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-pink-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Unidades Mentoradas</p><p class="text-lg font-bold text-pink-600" id="kpi-unidades-count">0</p></div>
                    </div>

                    <!-- SISTEMA DE ABAS -->
                    <div class="glass-panel overflow-hidden min-h-[500px]">
                        <div class="flex border-b border-gray-200 bg-gray-50/50">
                            <button onclick="window.app.trocarAbaRelatorio('geral')" id="tab-rel-geral" class="tab-btn active w-1/3 flex justify-center items-center gap-2">
                                <i data-lucide="table" class="w-4 h-4"></i> Análise Geral
                            </button>
                            <button onclick="window.app.trocarAbaRelatorio('ranking')" id="tab-rel-ranking" class="tab-btn w-1/3 flex justify-center items-center gap-2">
                                <i data-lucide="trophy" class="w-4 h-4"></i> Ranking de Média
                            </button>
                            <button onclick="window.app.trocarAbaRelatorio('feriado')" id="tab-rel-feriado" class="tab-btn w-1/3 flex justify-center items-center gap-2">
                                <i data-lucide="calendar-off" class="w-4 h-4"></i> Feriados
                            </button>
                        </div>

                        <!-- CONTEÚDO: ABA GERAL -->
                        <div id="conteudo-rel-geral" class="p-0 animate-fade-in">
                            <div class="p-4 bg-gray-50 border-b border-gray-100 flex justify-between items-center">
                                <h4 class="text-xs font-bold uppercase text-gray-500">Detalhamento Completo</h4>
                                <button onclick="window.app.exportarExcel()" class="text-green-700 bg-green-50 px-3 py-1 rounded text-xs font-bold border border-green-200 flex gap-2 uppercase">Excel</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full table-custom text-left min-w-[800px] uppercase" id="tabela-relatorio">
                                    <thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600">
                                        <tr>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRelatorio('unidade')">Unidade <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRelatorio('pais')">País/Estado <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRelatorio('mentor')">Mentor <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRelatorio('professor')">Professor <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRelatorio('modalidade')">Modalidade <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 text-center sort-header" onclick="window.app.ordenarRelatorio('media')">Média Alunos <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 text-center sort-header" onclick="window.app.ordenarRelatorio('valor')">Hora Aula <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 text-center sort-header" onclick="window.app.ordenarRelatorio('mensal')">Valor Total Mês <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-relatorio"></tbody>
                                </table>
                            </div>
                            <div id="relatorio-empty" class="p-8 text-center text-gray-400 hidden">Nenhum dado encontrado.</div>
                        </div>

                        <!-- CONTEÚDO: ABA RANKING -->
                        <div id="conteudo-rel-ranking" class="hidden animate-fade-in p-6">
                            <h4 class="text-xs font-bold uppercase text-gray-500 mb-4">Ranking de Unidades por Média de Alunos</h4>
                            <div class="overflow-hidden border rounded-lg">
                                <table class="w-full text-xs text-left uppercase table-custom">
                                    <thead class="bg-gray-100 text-gray-600 sticky top-0 shadow-sm z-10">
                                        <tr>
                                            <th class="p-3 text-center sort-header w-24" onclick="window.app.ordenarRanking('classificacao')">Classificação <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRanking('unidade')">Unidade <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRanking('mentor')">Mentor <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 sort-header" onclick="window.app.ordenarRanking('detalhe')">Detalhe (Professor/Modalidade) <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                            <th class="p-3 text-right sort-header" onclick="window.app.ordenarRanking('media')">Média Alunos <i data-lucide="arrow-up-down" class="sort-icon"></i></th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-ranking"></tbody>
                                </table>
                            </div>
                        </div>

                        <!-- CONTEÚDO: ABA FERIADOS -->
                        <div id="conteudo-rel-feriado" class="hidden animate-fade-in p-6 bg-red-50/30 h-full">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h4 class="text-xs font-bold uppercase text-red-600 mb-1">Análise de Impacto de Feriados</h4>
                                    <p class="text-[10px] text-gray-500 uppercase">Aulas que coincidem com datas de feriado no mês selecionado.</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Economia Gerada</p>
                                    <p class="text-2xl font-bold text-red-600" id="total-economizado">R$ 0,00</p>
                                </div>
                            </div>
                            
                            <div class="bg-white border border-red-100 rounded-lg overflow-hidden shadow-sm">
                                <table class="w-full text-xs text-left uppercase">
                                    <thead class="bg-red-50 text-red-800 font-bold border-b border-red-100">
                                        <tr>
                                            <th class="p-3">Data</th>
                                            <th class="p-3">Feriado</th>
                                            <th class="p-3">Unidade Afetada</th>
                                            <th class="p-3">Aula Cancelada</th>
                                            <th class="p-3 text-right">Valor Poupado</th>
                                        </tr>
                                    </thead>
                                    <tbody id="body-feriados" class="text-gray-700"></tbody>
                                </table>
                            </div>
                            <div id="feriado-empty" class="p-8 text-center text-gray-400 hidden">Nenhum feriado impactando aulas neste mês.</div>
                        </div>
                    </div>
                </div>

                <!-- CRONOGRAMA COM VALIDAÇÃO (MODULARIZADO) -->
                <div id="view-cronograma" class="view-section hidden pb-20">
                    <div class="glass-panel p-4 mb-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-4 mb-4">
                            <div class="w-full md:w-auto flex-1">
                                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Selecionar Unidade</label>
                                <select id="cronograma-unidade-select" class="w-full p-2 border border-blue-200 rounded text-sm bg-white font-bold text-gray-700 h-10 uppercase focus:ring-2 focus:ring-blue-500 outline-none" onchange="window.app.renderCronograma()"></select>
                            </div>
                            <button onclick="window.app.abrirModalAdicao()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded text-sm shadow-md transition flex items-center gap-2 uppercase h-10">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Criar Aula
                            </button>
                        </div>
                    </div>
                    <!-- ÁREA DE VALIDAÇÃO (Separada) -->
                    <div id="painel-validacao-cronograma" class="mb-4"></div>
                    
                    <div class="glass-panel overflow-hidden">
                        <div id="cronograma-container" class="overflow-x-auto"></div>
                    </div>
                </div>

                <!-- ACESSO MENSAL (RESTAURADO) -->
                <div id="view-acesso" class="view-section hidden pb-20"></div>

                <!-- CONFIGURAÇÕES (RESTAURADA E MELHORADA) -->
                <div id="view-config" class="view-section hidden pb-20">
                    <div class="glass-panel p-4 mb-6">
                        <!-- Navegação Config -->
                        <div class="flex gap-4 border-b border-gray-200 mb-6">
                            <button onclick="window.app.switchConfigTab('cadastro')" id="tab-cadastro" class="config-tab active pb-2 px-4 text-sm font-bold uppercase text-blue-600 border-blue-600">
                                <i data-lucide="folder-plus" class="w-4 h-4 inline mr-1"></i> Cadastros
                            </button>
                            <button onclick="window.app.switchConfigTab('ferramentas')" id="tab-ferramentas" class="config-tab pb-2 px-4 text-sm font-bold uppercase text-gray-500 hover:text-blue-600">
                                <i data-lucide="tool" class="w-4 h-4 inline mr-1"></i> Ferramentas
                            </button>
                        </div>
                        
                        <!-- Conteudo Cadastro (Sub-abas) -->
                        <div id="subview-cadastro">
                             <!-- Menu de Sub-abas COLORIDAS E MAIORES (V15) -->
                             <div class="flex gap-3 overflow-x-auto mb-6 pb-2 py-1 scrollbar-hide">
                                <button onclick="window.app.switchCadastroSubTab('mentor')" id="subtab-cad-mentor" class="subtab-btn mentor-active">
                                    <i data-lucide="graduation-cap"></i> 
                                    <span>Mentores</span>
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('modalidade')" id="subtab-cad-modalidade" class="subtab-btn inactive">
                                    <i data-lucide="dumbbell"></i> 
                                    <span>Modalidades</span>
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('unidade')" id="subtab-cad-unidade" class="subtab-btn inactive">
                                    <i data-lucide="map-pin"></i> 
                                    <span>Unidades</span>
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('grade')" id="subtab-cad-grade" class="subtab-btn inactive">
                                    <i data-lucide="calendar"></i> 
                                    <span>Grade Horária</span>
                                </button>
                                <button onclick="window.app.switchCadastroSubTab('feriado')" id="subtab-cad-feriado" class="subtab-btn inactive">
                                    <i data-lucide="calendar-off"></i> 
                                    <span>Feriados</span>
                                </button>
                            </div>

                             <!-- Mentor -->
                            <div id="view-cad-mentor" class="max-w-2xl admin-only-block mb-8">
                                <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-blue-50 text-blue-700 p-2 rounded border border-blue-100">Gerenciar Mentores</h3>
                                <div class="flex gap-2 mb-3">
                                    <input id="cad-mentor-nome" placeholder="NOME DO MENTOR" class="w-full p-2 border rounded text-xs uppercase">
                                    <input id="cad-mentor-senha" placeholder="SENHA" class="w-24 p-2 border rounded text-xs text-center bg-yellow-50" value="1234">
                                    <button onclick="window.app.addMentor()" class="bg-blue-600 text-white px-6 rounded text-xs hover:bg-blue-700 h-9 font-bold uppercase shadow-sm" id="btn-add-mentor">Adicionar</button>
                                    <button onclick="window.app.cancelarEdicao('mentor')" class="hidden bg-gray-400 text-white px-4 rounded text-xs hover:bg-gray-500 h-9 font-bold uppercase" id="btn-cancel-mentor">X</button>
                                </div>
                                <input type="hidden" id="edit-mentor-id">
                                <ul id="lista-mentores" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase border rounded p-2 bg-gray-50"></ul>
                            </div>

                             <!-- Modalidade -->
                            <div id="view-cad-modalidade" class="max-w-2xl admin-only-block mb-8 hidden">
                                <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-pink-50 text-pink-700 p-2 rounded border border-pink-100">Gerenciar Modalidades</h3>
                                <div class="flex gap-2 mb-3 items-center">
                                    <input id="cad-mod-nome" placeholder="NOME DA MODALIDADE" class="flex-1 p-2 border rounded text-xs uppercase">
                                    <input type="color" id="cad-mod-cor" class="w-9 h-9 rounded cursor-pointer border p-0" value="#3b82f6">
                                    <button onclick="window.app.addModalidade()" class="bg-pink-600 text-white px-6 py-2 rounded text-xs hover:bg-pink-700 h-9 uppercase font-bold shadow-sm" id="btn-add-modalidade">Salvar</button>
                                    <button onclick="window.app.cancelarEdicao('modalidade')" class="hidden bg-gray-400 text-white px-4 rounded text-xs hover:bg-gray-500 h-9 font-bold uppercase" id="btn-cancel-modalidade">X</button>
                                </div>
                                <input type="hidden" id="edit-modalidade-id">
                                <ul id="lista-modalidades" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase border rounded p-2 bg-gray-50"></ul>
                            </div>

                            <!-- Unidade -->
                            <div id="view-cad-unidade" class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full hidden">
                                <div>
                                    <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-cyan-50 text-cyan-700 p-2 rounded border border-cyan-100">Nova Unidade</h3>
                                    <div class="space-y-3 bg-white p-4 border rounded-lg shadow-sm">
                                        <input type="hidden" id="edit-unidade-id">
                                        <select id="cad-unidade-mentor" class="w-full p-2 border rounded text-xs bg-white uppercase"><option value="">MENTOR...</option></select>
                                        <input id="cad-unidade-nome" placeholder="NOME DA UNIDADE" class="w-full p-2 border rounded text-xs uppercase">
                                        <input id="cad-unidade-senha" placeholder="SENHA DE ACESSO" class="w-full p-2 border rounded text-xs h-9 bg-yellow-50 text-center font-bold" value="1234">
                                        <div class="grid grid-cols-2 gap-2">
                                            <select id="cad-unidade-pais" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.atualizarEstados()"><option value="">PAÍS...</option></select>
                                            <select id="cad-unidade-estado" class="w-full p-2 border rounded text-xs bg-white uppercase"></select>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="window.app.addUnidade()" class="w-full bg-cyan-600 text-white py-2 rounded text-xs font-bold hover:bg-cyan-700 h-9 uppercase shadow-sm" id="btn-add-unidade">SALVAR UNIDADE</button>
                                            <button onclick="window.app.cancelarEdicao('unidade')" class="hidden w-1/4 bg-gray-400 text-white py-2 rounded text-xs font-bold hover:bg-gray-500 h-9 uppercase" id="btn-cancel-unidade">X</button>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase">Unidades Cadastradas</h3>
                                    <input placeholder="BUSCAR UNIDADE..." class="w-full p-2 border rounded text-xs mb-2 bg-slate-50 uppercase" onkeyup="window.app.filtrarListaUnidades(this.value)">
                                    <ul id="lista-unidades" class="space-y-2 max-h-[300px] overflow-y-auto text-xs text-gray-600 uppercase border rounded p-2 bg-gray-50"></ul>
                                </div>
                            </div>

                            <!-- Grade de Horário (Novo e Melhorado) -->
                            <div id="view-cad-grade" class="hidden">
                                <div class="bg-violet-50 border border-violet-100 p-4 rounded-lg mb-4 flex justify-between items-center">
                                    <div>
                                        <h3 class="font-bold text-violet-800 mb-1 text-xs uppercase">Gestão da Grade de Horários</h3>
                                        <p class="text-[10px] text-violet-600">Total de Aulas: <span id="grade-count" class="font-bold">0</span></p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="window.app.abrirModalAdicao()" class="bg-violet-600 text-white px-4 py-2 rounded text-xs font-bold uppercase hover:bg-violet-700 shadow-sm flex items-center gap-2">
                                            <i data-lucide="plus"></i> Nova Aula
                                        </button>
                                        <button onclick="window.app.nav('cronograma')" class="bg-white border border-violet-200 text-violet-700 px-4 py-2 rounded text-xs font-bold uppercase hover:bg-violet-50 shadow-sm flex items-center gap-2">
                                            <i data-lucide="calendar"></i> Visualizar Grade
                                        </button>
                                    </div>
                                </div>
                                <div class="border rounded-lg overflow-hidden bg-white">
                                    <ul id="lista-grade-completa" class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto"></ul>
                                </div>
                            </div>

                            <!-- Feriados (Movido e Melhorado) -->
                            <div id="view-cad-feriado" class="max-w-2xl admin-only-block mb-8 hidden">
                                <h3 class="font-bold text-gray-800 mb-3 text-xs uppercase bg-yellow-50 text-yellow-700 p-2 rounded border border-yellow-100">Gestão de Feriados</h3>
                                <div class="space-y-2 mb-3 bg-white p-4 border rounded-lg shadow-sm">
                                    <input type="hidden" id="edit-feriado-id">
                                    <input id="feriado-nome" placeholder="NOME DO FERIADO" class="w-full p-2 border rounded text-xs uppercase">
                                    <input type="date" id="feriado-data" class="w-full p-2 border rounded text-xs">
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="feriado-tipo" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.toggleFeriadoLocal()"><option value="global">GLOBAL</option><option value="nacional">NACIONAL</option><option value="estadual">ESTADUAL</option></select>
                                        <select id="feriado-local" class="w-full p-2 border rounded text-xs bg-white uppercase hidden"></select>
                                    </div>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="window.app.addFeriado()" class="w-full bg-yellow-600 text-white py-2 rounded text-xs font-bold hover:bg-yellow-700 h-9 uppercase" id="btn-add-feriado">ADICIONAR FERIADO</button>
                                        <button onclick="window.app.cancelarEdicao('feriado')" class="hidden w-1/4 bg-gray-400 text-white py-2 rounded text-xs font-bold hover:bg-gray-500 h-9 uppercase" id="btn-cancel-feriado">X</button>
                                    </div>
                                </div>
                                <ul id="lista-feriados" class="space-y-1 max-h-60 overflow-y-auto text-xs uppercase border rounded p-2 bg-gray-50"></ul>
                            </div>
                        </div>

                        <!-- Conteudo Ferramentas -->
                        <div id="subview-ferramentas" class="hidden">
                             <div class="flex gap-3 overflow-x-auto mb-6 pb-2 border-b border-gray-100 py-1">
                                <button onclick="window.app.switchFerramentasSubTab('backup')" id="subtab-ferr-backup" class="subtab-btn active"><i data-lucide="database"></i> Backup</button>
                                <button onclick="window.app.switchFerramentasSubTab('senhas')" id="subtab-ferr-senhas" class="subtab-btn inactive"><i data-lucide="key"></i> Senhas</button>
                            </div>
                            
                            <!-- Backup -->
                            <div id="view-ferr-backup" class="hidden">
                                <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                                    <h2 class="font-bold text-gray-800 mb-6 uppercase text-xs text-center border-b pb-2">Gerenciamento de Backup</h2>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div class="text-center">
                                            <p class="text-[10px] text-gray-500 mb-2 uppercase font-bold">Salvar Dados</p>
                                            <button onclick="window.app.salvarBackup()" class="bg-gray-800 hover:bg-black text-white px-6 py-3 rounded font-bold w-full flex items-center justify-center gap-2 uppercase text-xs">
                                                <i data-lucide="save" class="w-4 h-4"></i> Baixar Arquivo .JSON
                                            </button>
                                        </div>
                                        <div class="text-center border-l border-gray-200 pl-8">
                                            <p class="text-[10px] text-gray-500 mb-2 uppercase font-bold">Restaurar Dados</p>
                                            <div class="flex gap-2 items-center">
                                                <input type="file" id="input-backup-file" accept=".json" class="text-xs w-full border rounded p-2 bg-white">
                                            </div>
                                            <button onclick="window.app.restaurarBackup()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded text-xs font-bold uppercase w-full mt-2">
                                                Restaurar Agora
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Senhas e Reset -->
                            <div id="view-ferr-senhas" class="hidden">
                                <div class="flex justify-between items-center mb-4 bg-red-50 p-3 rounded border border-red-100">
                                    <h2 class="font-bold text-gray-800 flex items-center gap-2 uppercase text-xs">Área de Segurança</h2>
                                    <button onclick="window.app.resetarBancoDeDados()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase">⚠️ Resetar Sistema</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTÓRICO -->
                <div id="view-historico" class="view-section hidden pb-20">
                    <div class="glass-panel p-6">
                        <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2 uppercase"><i data-lucide="history" class="w-5 h-5 text-blue-600"></i> Histórico</h2>
                        <div class="overflow-x-auto max-h-[600px] border rounded-lg"><table class="w-full text-xs text-left uppercase table-custom"><thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600"><tr><th class="p-3">Data/Hora</th><th class="p-3">Usuário</th><th class="p-3">Ação</th><th class="p-3">Detalhe</th><th class="p-3">Anterior</th><th class="p-3">Novo</th></tr></thead><tbody id="lista-historico" class="bg-white text-gray-700"></tbody></table></div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL FLUTUANTE (DRAG-AND-DROP) -->
    <div id="modal-editor" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden modal-overlay">
        <div id="modal-card" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-none relative max-h-[90vh] flex flex-col">
            <div id="modal-header" class="bg-blue-600 p-4 flex justify-between items-center text-white cursor-grab select-none active:cursor-grabbing hover:bg-blue-700 transition-colors">
                <h3 class="font-bold text-lg flex items-center gap-2 uppercase"><i data-lucide="move" class="w-4 h-4 text-white/50"></i> <span id="modal-titulo">Editar Aula</span></h3>
                <button onclick="window.app.fecharModal()" class="hover:bg-blue-800 p-1 rounded"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <input type="hidden" id="modal-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Unidade</label><input type="text" id="modal-unidade-view" class="w-full p-2.5 border border-gray-300 rounded bg-gray-100 text-xs font-bold text-gray-600 h-10 uppercase" disabled></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Modalidade *</label><select id="modal-modalidade" class="w-full p-2.5 border border-gray-300 rounded text-xs bg-white h-10 uppercase focus:border-blue-500 outline-none"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Professor Responsável *</label><input type="text" id="modal-prof" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 uppercase focus:border-blue-500 outline-none" placeholder="NOME DO PROFESSOR"></div>
                <div class="grid grid-cols-3 gap-3">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Início *</label><input type="time" id="modal-hora" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Valor</label><input type="number" id="modal-valor" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none" placeholder="0.00"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Alunos</label><input type="number" id="modal-alunos" class="w-full p-2.5 border border-gray-300 rounded text-xs h-10 focus:border-blue-500 outline-none" placeholder="0"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1 uppercase">Dias da Semana *</label><div class="flex flex-wrap gap-2 p-2 border rounded bg-gray-50" id="modal-dias-container"></div></div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-between gap-3 border-t">
                <button onclick="window.app.excluirViaModal()" id="btn-excluir-modal" class="text-red-500 hover:text-red-700 text-xs font-bold px-4 py-2 flex items-center gap-2 uppercase border border-red-200 rounded hover:bg-red-50 transition"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button>
                <div class="flex gap-2"><button onclick="window.app.fecharModal()" class="text-gray-500 hover:text-gray-700 font-bold py-2 px-4 rounded text-xs uppercase">Cancelar</button><button onclick="window.app.salvarModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded text-sm shadow-md transition uppercase flex items-center gap-2"><i data-lucide="save" class="w-4 h-4"></i> Salvar Aula</button></div>
            </div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-4 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-[70] flex items-center gap-4 border-l-4 border-green-500 max-w-[90%]"><div id="toast-icon" class="text-2xl">✅</div><div><h4 id="toast-title" class="font-bold text-sm uppercase">Sucesso</h4><p id="toast-msg" class="text-xs opacity-80 uppercase">Operação realizada.</p></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { window.app = new SistemaPratique(); });

        class SistemaPratique {
            constructor() {
                this.db = { mentores: [], unidades: [], modalidades: [], horarios: [], historico: [], feriados: [], acessos: [] };
                this.apiUrl = 'https://script.google.com/macros/s/AKfycbz8LU_ekbnZ7tAwrvxyaASzql0Cvqe-HAVGhWpO-TkOWot3AcWjpAALTB3u2bOGx8hbfA/exec';
                this.currentUser = null;
                this.ordenacaoRelatorio = { campo: 'unidade', direcao: 'asc' }; 
                this.ordenacaoRanking = { campo: 'media', direcao: 'desc' }; 
                this.mobileMenuOpen = false;
                this.abaRelatorioAtiva = 'geral'; 
                
                // Estados do Acesso Mensal
                this.currentAcessoTab = 'ranking';
                this.acessoFilterTerm = '';
                this.acessoStatusSort = { field: 'unidade', direction: 'asc' };

                this.constantes = {
                    dias: ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"],
                    meses: ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"],
                    feriadosFixos: [{d:1,m:0,nome:"CONF. UNIVERSAL"}, {d:21,m:3,nome:"TIRADENTES"}, {d:1,m:4,nome:"DIA DO TRABALHO"}, {d:7,m:8,nome:"INDEPENDÊNCIA"}, {d:12,m:9,nome:"N. SRA. APARECIDA"}, {d:2,m:10,nome:"FINADOS"}, {d:15,m:10,nome:"PROCLAMAÇÃO"}, {d:25,m:11,nome:"Natal"}],
                    paisesEstados: { 'Brasil': ["AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO"], 'Estados Unidos': ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"], 'Argentina': ["Buenos Aires", "Catamarca", "Chaco", "Chubut", "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan", "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del Fuego", "Tucumán"] }
                };
                this.init();
                this.setupDraggableModal();
            }

            init() {
                this.carregarDadosLocais();
                this.setupUI();
                const sessionUser = sessionStorage.getItem('pratique_user');
                if(sessionUser) { this.currentUser = JSON.parse(sessionUser); this.postLoginSetup(); }
                setTimeout(() => lucide.createIcons(), 500);
            }

            // --- UTILITARIOS ---
            normalizeStr(str) { return str ? str.toString().trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ' ') : ""; }
            safeToggle(id, cls, action) { const el = document.getElementById(id); if(el) { if(action==='add') el.classList.add(cls); else if(action==='remove') el.classList.remove(cls); else el.classList.toggle(cls); } }
            notify(t, m) { const x = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; x.classList.remove('translate-x-full'); setTimeout(() => x.classList.add('translate-x-full'), 3000); }

            // --- CORE ---
            carregarDadosLocais() {
                const salvo = localStorage.getItem('pratique_global_db_v5');
                if (salvo) { try { this.db = JSON.parse(salvo); this.sanitizeDB(); } catch(e) { this.seedInicial(); } } else { this.seedInicial(); }
            }
            sanitizeDB() { 
                if(!this.db.acessos) this.db.acessos = []; 
                if(!this.db.feriados) this.db.feriados = [];
                if(!this.db.mentores) this.db.mentores = [];
                if(!this.db.unidades) this.db.unidades = [];
                if(!this.db.modalidades) this.db.modalidades = [];
                if(!this.db.horarios) this.db.horarios = [];
                if(!this.db.historico) this.db.historico = []; 
                
                (this.db.unidades||[]).forEach(u => u.senha = String(u.senha || '1234')); 
                (this.db.mentores||[]).forEach(m => m.senha = String(m.senha || '1234')); 
            }
            seedInicial() { this.db = { mentores: [{id:1,nome:"FELIPE SOUZA", senha:"1234"}], modalidades: [{id:1,nome:"JUMP",cor:"#ff5722"}], unidades: [{id:101,nome:"PRATIQUE SAVASSI",mentorId:1,estado:"MG",pais:"Brasil", senha:"1234"}], horarios: [], historico: [], feriados: [], acessos: [] }; this.salvarDados(); }
            salvarDados() { localStorage.setItem('pratique_global_db_v5', JSON.stringify(this.db)); this.sincronizarNuvem('upload'); }
            
            async sincronizarNuvem(acao) {
                try {
                    const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text');
                    if(dot) dot.className = 'status-dot status-sync'; if(txt) txt.innerText = 'Sync...';
                    if (acao === 'download') { const r = await fetch(this.apiUrl); if(r.ok) { const d = await r.json(); if(d && d.unidades) { this.db = d; this.sanitizeDB(); this.salvarDados(); this.atualizarListas(); } } } 
                    else { await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify(this.db) }); }
                    if(dot) dot.className = 'status-dot status-online'; if(txt) txt.innerText = 'Online';
                } catch(e) { const dot = document.getElementById('status-dot'); if(dot) dot.className = 'status-dot status-offline'; const txt = document.getElementById('status-text'); if(txt) txt.innerText = 'Offline'; }
            }
            forcarSincronizacao() { this.sincronizarNuvem('download'); }
            registrarLog(acao, detalhe, ant, nov) { if(!this.db.historico) this.db.historico = []; this.db.historico.unshift({ id: Date.now(), data: new Date().toLocaleString(), usuario: this.currentUser?.name||'Sys', acao, detalhe, anterior: ant, novo: nov }); if(this.db.historico.length > 1000) this.db.historico.length = 1000; this.salvarDados(); }

            // --- UI SETUP ---
            setupUI() {
                const elData = document.getElementById('data-atual'); if(elData) elData.innerText = new Date().toLocaleDateString('pt-BR');
                const selMes = document.getElementById('rel-mes');
                if(selMes) selMes.innerHTML = this.constantes.meses.map((m, i) => `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`).join('');
                const divDiasModal = document.getElementById('modal-dias-container');
                if(divDiasModal) divDiasModal.innerHTML = this.constantes.dias.map(d => `<label class="cursor-pointer select-none"><input type="checkbox" value="${d}" class="peer sr-only modal-check-dia"><div class="px-2 py-1 text-[10px] uppercase border rounded bg-white text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition shadow-sm hover:bg-gray-50">${d.substring(0,3)}</div></label>`).join('');
                this.atualizarEstados(); this.atualizarFiltrosRelatorio('init');
            }
            atualizarEstados() { const p = document.getElementById('cad-unidade-pais'); const s = document.getElementById('cad-unidade-estado'); if(p && s) { const list = this.constantes.paisesEstados[p.value] || []; s.innerHTML = list.map(e => `<option value="${e}">${e}</option>`).join(''); } }

            // --- LOGIN/NAV ---
            login() {
                const uRaw = document.getElementById('login-user').value; const pass = document.getElementById('login-pass').value.trim(); const uClean = this.normalizeStr(uRaw);
                if (uClean === 'ADMIN' && pass === 'admin123') return this.completeLogin({ id: 'admin', name: 'ADMINISTRADOR', role: 'admin' });
                const mentor = this.db.mentores.find(m => this.normalizeStr(m.nome) === uClean);
                if (mentor && String(mentor.senha) === pass) return this.completeLogin({ id: mentor.id, name: mentor.nome, role: 'mentor' });
                const unit = this.db.unidades.find(x => this.normalizeStr(x.nome) === uClean);
                if (unit && String(unit.senha) === pass) return this.completeLogin({ id: unit.id, name: unit.nome, role: 'unidade' });
                document.getElementById('login-error').classList.remove('hidden');
            }
            completeLogin(user) { this.currentUser = user; sessionStorage.setItem('pratique_user', JSON.stringify(user)); this.safeToggle('login-screen', 'hidden', 'add'); this.safeToggle('app-container', 'hidden', 'remove'); this.postLoginSetup(); this.notify('success', `Bem-vindo ${user.name}`); }
            logout() { sessionStorage.removeItem('pratique_user'); window.location.reload(); }
            postLoginSetup() {
                document.getElementById('user-name').innerText = this.currentUser.name; document.getElementById('user-role').innerText = this.currentUser.role.toUpperCase(); document.getElementById('user-avatar').innerText = this.currentUser.name.charAt(0);
                this.safeToggle('nav-config', 'disabled', 'remove'); this.safeToggle('admin-filters-container', 'hidden', 'remove'); this.safeToggle('nav-historico', 'hidden', 'add'); this.safeToggle('nav-acesso', 'hidden', 'remove');
                document.querySelectorAll('.admin-only-block').forEach(el => el.classList.remove('hidden'));
                
                if(this.currentUser.role === 'admin') {
                    this.safeToggle('nav-historico', 'hidden', 'remove');
                }
                if (this.currentUser.role === 'mentor') { 
                    this.safeToggle('admin-filters-container', 'hidden', 'add'); 
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden')); 
                }
                if (this.currentUser.role === 'unidade') { 
                    this.safeToggle('nav-config', 'disabled', 'add'); 
                    this.safeToggle('admin-filters-container', 'hidden', 'add'); 
                    this.safeToggle('filter-mentor-wrapper', 'hidden', 'add'); 
                    this.safeToggle('filter-unidade-wrapper', 'hidden', 'add'); 
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden')); 
                }
                this.atualizarListas(); this.nav('cronograma');
            }
            nav(view) {
                if(view === 'historico') {
                    if(this.currentUser.role !== 'admin') return alert('Acesso Negado');
                    this.renderHistorico(); 
                }
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${view}`).classList.add('active');
                if(this.mobileMenuOpen) this.toggleMenu();
                if(view === 'relatorio') this.gerarRelatorio();
                if(view === 'cronograma') this.renderCronograma();
                if(view === 'acesso') { if(!this.acessoMesSelecionado) { this.acessoMesSelecionado = new Date().getMonth(); this.acessoAnoSelecionado = new Date().getFullYear(); } this.renderAcessoMensal(); }
                if(view === 'config') this.switchConfigTab('cadastro');
                lucide.createIcons();
            }
            toggleMenu() { this.mobileMenuOpen = !this.mobileMenuOpen; const sb = document.getElementById('sidebar'); const ov = document.getElementById('mobile-menu-overlay'); if(this.mobileMenuOpen) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); } }
            
            atualizarListas() {
                // Métodos de CRUD simplificados para listagem
                const renderList = (id, list, type) => { 
                    const el = document.getElementById(id); 
                    if(el) el.innerHTML = list.map(i => `
                        <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1">
                            <span class="text-xs font-bold text-gray-700">${i.nome}</span>
                            <div class="flex gap-2">
                                <button onclick="window.app.editarItem('${type}', '${i.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                <button onclick="window.app.deleteItem('${type}', '${i.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </li>`).join(''); 
                };
                
                // MENTORES
                const pop = (id, list) => { const el = document.getElementById(id); if(el) el.innerHTML = '<option value="">SELECIONE...</option>' + list.map(i => `<option value="${i.id}">${i.nome}</option>`).join(''); };
                pop('cronograma-unidade-select', this.db.unidades); pop('rel-unidade', this.db.unidades); pop('rel-mentor', this.db.mentores); pop('rel-modalidade', this.db.modalidades); pop('cad-unidade-mentor', this.db.mentores); pop('modal-modalidade', this.db.modalidades);
                
                renderList('lista-mentores', this.db.mentores, 'mentores'); 
                
                // MODALIDADES
                const listaModalidades = document.getElementById('lista-modalidades');
                if(listaModalidades) listaModalidades.innerHTML = this.db.modalidades.map(m => `
                    <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1" style="border-left: 4px solid ${m.cor}">
                        <span class="text-xs font-bold text-gray-700">${m.nome}</span>
                        <div class="flex gap-2">
                            <button onclick="window.app.editarItem('modalidades', '${m.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.app.deleteItem('modalidades', '${m.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </li>`).join('');
                
                // UNIDADES
                const listaUnidades = document.getElementById('lista-unidades');
                if (listaUnidades) listaUnidades.innerHTML = this.db.unidades.sort((a,b)=>a.nome.localeCompare(b.nome)).map(u => `
                    <li class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100 mb-1">
                        <div>
                            <div class="text-xs font-bold text-gray-700">${u.nome}</div>
                            <div class="text-[10px] text-gray-500">${u.estado}, ${u.pais}</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.app.editarItem('unidades', '${u.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.app.deleteItem('unidades', '${u.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </li>`).join('');
                
                // FERIADOS (Movido para Cadastro)
                this.renderListaFeriados(); 
                
                // GRADE (Novo)
                this.renderListaGrade();
                
                lucide.createIcons();
            }

            // --- NOVAS FUNÇÕES DE EDIÇÃO (CRUD) ---
            editarItem(tipo, id) {
                // Função genérica para preencher os campos e mudar estado para edição
                if (tipo === 'mentores') {
                    const item = this.db.mentores.find(m => m.id == id);
                    if(!item) return;
                    document.getElementById('cad-mentor-nome').value = item.nome;
                    document.getElementById('cad-mentor-senha').value = item.senha;
                    document.getElementById('edit-mentor-id').value = id;
                    document.getElementById('btn-add-mentor').innerText = 'ATUALIZAR';
                    document.getElementById('btn-add-mentor').classList.replace('bg-gray-800', 'bg-blue-800'); // Visual
                    document.getElementById('btn-cancel-mentor').classList.remove('hidden');
                }
                else if (tipo === 'modalidades') {
                    const item = this.db.modalidades.find(m => m.id == id);
                    if(!item) return;
                    document.getElementById('cad-mod-nome').value = item.nome;
                    document.getElementById('cad-mod-cor').value = item.cor;
                    document.getElementById('edit-modalidade-id').value = id;
                    document.getElementById('btn-add-modalidade').innerText = 'ATUALIZAR';
                    document.getElementById('btn-cancel-modalidade').classList.remove('hidden');
                }
                else if (tipo === 'unidades') {
                    const item = this.db.unidades.find(u => u.id == id);
                    if(!item) return;
                    document.getElementById('cad-unidade-nome').value = item.nome;
                    document.getElementById('cad-unidade-mentor').value = item.mentorId;
                    document.getElementById('cad-unidade-pais').value = item.pais;
                    this.atualizarEstados(); // Recarrega estados
                    document.getElementById('cad-unidade-estado').value = item.estado;
                    document.getElementById('cad-unidade-senha').value = item.senha;
                    document.getElementById('edit-unidade-id').value = id;
                    document.getElementById('btn-add-unidade').innerText = 'ATUALIZAR UNIDADE';
                    document.getElementById('btn-cancel-unidade').classList.remove('hidden');
                }
                else if (tipo === 'feriados') {
                    const item = this.db.feriados.find(f => f.id == id);
                    if(!item) return;
                    document.getElementById('feriado-nome').value = item.nome;
                    document.getElementById('feriado-data').value = item.data;
                    document.getElementById('feriado-tipo').value = item.tipo;
                    this.toggleFeriadoLocal(); // Atualiza select local
                    if(item.local) document.getElementById('feriado-local').value = item.local;
                    document.getElementById('edit-feriado-id').value = id;
                    document.getElementById('btn-add-feriado').innerText = 'ATUALIZAR FERIADO';
                    document.getElementById('btn-cancel-feriado').classList.remove('hidden');
                }
                else if (tipo === 'horarios') {
                    this.abrirModalEdicao(id); // Usa o modal existente
                }
            }

            cancelarEdicao(tipo) {
                // Limpa campos e volta botão para adicionar
                if (tipo === 'mentor') {
                    document.getElementById('cad-mentor-nome').value = '';
                    document.getElementById('cad-mentor-senha').value = '1234';
                    document.getElementById('edit-mentor-id').value = '';
                    document.getElementById('btn-add-mentor').innerText = 'Adicionar';
                    document.getElementById('btn-cancel-mentor').classList.add('hidden');
                }
                else if (tipo === 'modalidade') {
                    document.getElementById('cad-mod-nome').value = '';
                    document.getElementById('edit-modalidade-id').value = '';
                    document.getElementById('btn-add-modalidade').innerText = 'Salvar';
                    document.getElementById('btn-cancel-modalidade').classList.add('hidden');
                }
                else if (tipo === 'unidade') {
                    document.getElementById('cad-unidade-nome').value = '';
                    document.getElementById('cad-unidade-mentor').value = '';
                    document.getElementById('edit-unidade-id').value = '';
                    document.getElementById('btn-add-unidade').innerText = 'SALVAR UNIDADE';
                    document.getElementById('btn-cancel-unidade').classList.add('hidden');
                }
                else if (tipo === 'feriado') {
                    document.getElementById('feriado-nome').value = '';
                    document.getElementById('feriado-data').value = '';
                    document.getElementById('edit-feriado-id').value = '';
                    document.getElementById('btn-add-feriado').innerText = 'ADICIONAR FERIADO';
                    document.getElementById('btn-cancel-feriado').classList.add('hidden');
                }
            }

            renderListaGrade() {
                const ul = document.getElementById('lista-grade-completa');
                const count = document.getElementById('grade-count');
                if(!ul) return;
                
                const aulas = this.db.horarios;
                count.innerText = `${aulas.length} aulas`;
                
                ul.innerHTML = aulas.sort((a,b) => b.id - a.id).slice(0, 50).map(a => { // Mostra ultimas 50
                    const unid = this.db.unidades.find(u => u.id == a.unidadeId)?.nome || '???';
                    const mod = this.db.modalidades.find(m => m.id == a.modalidadeId)?.nome || '???';
                    return `
                    <li class="p-3 hover:bg-gray-50 flex justify-between items-center group">
                        <div>
                            <div class="text-xs font-bold text-gray-700">${unid} - ${mod}</div>
                            <div class="text-[10px] text-gray-500">${a.professor} | ${a.hora} | ${a.dias.join(', ')}</div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="window.app.editarItem('horarios', '${a.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button onclick="window.app.deleteItem('horarios', '${a.id}')" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </li>`;
                }).join('') + (aulas.length > 50 ? '<li class="p-2 text-center text-[10px] text-gray-400">Mostrando últimas 50...</li>' : '');
            }

            // --- RENDER HISTORICO ---
            renderHistorico() {
                const tbody = document.getElementById('lista-historico');
                if(!tbody) return;
                const logs = (this.db.historico || []).sort((a,b) => b.id - a.id).slice(0, 100); 
                
                if(logs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-400 text-xs">Nenhum registro encontrado.</td></tr>';
                    return;
                }

                tbody.innerHTML = logs.map(log => `
                    <tr class="border-b hover:bg-slate-50 transition-colors">
                        <td class="p-3 text-gray-500 font-mono text-[10px] whitespace-nowrap">${log.data}</td>
                        <td class="p-3 font-bold text-gray-700 text-[10px]">${log.usuario}</td>
                        <td class="p-3"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-[10px] font-bold border border-gray-200 uppercase">${log.acao}</span></td>
                        <td class="p-3 text-gray-600 text-[10px] uppercase">${log.detalhe}</td>
                        <td class="p-3 text-red-400 text-[10px] font-mono">${log.anterior || '-'}</td>
                        <td class="p-3 text-green-600 text-[10px] font-bold font-mono">${log.novo || '-'}</td>
                    </tr>
                `).join('');
            }

            // ============================================================
            //   MÓDULO DE RELATÓRIO GERENCIAL
            // ============================================================

            gerarRelatorio() {
                // Passo 1: Filtrar os dados
                const dados = this.filtrarDadosRelatorio();
                this.atualizarKPIs(dados);
                this.renderizarAbaGeral(dados);
                this.renderizarAbaRanking(dados);
                this.renderizarAbaFeriados(dados);
                this.atualizarVisualAbas();
            }

            filtrarDadosRelatorio() {
                const fUni = document.getElementById('rel-unidade').value;
                const fMent = document.getElementById('rel-mentor').value;
                const fMod = document.getElementById('rel-modalidade').value;
                const fPais = document.getElementById('rel-pais').value;
                const fEst = document.getElementById('rel-estado').value;

                return this.db.horarios.filter(h => {
                    const u = this.db.unidades.find(unit => unit.id == h.unidadeId);
                    if(!u) return false;
                    
                    if(this.currentUser.role === 'mentor' && u.mentorId != this.currentUser.id) return false;
                    if(this.currentUser.role === 'unidade' && u.id != this.currentUser.id) return false;
                    
                    if(fUni && u.id != fUni) return false;
                    if(fMent && u.mentorId != fMent) return false;
                    if(fMod && h.modalidadeId != fMod) return false;
                    if(fPais && u.pais != fPais) return false;
                    if(fEst && u.estado != fEst) return false;
                    return true;
                });
            }

            atualizarKPIs(dados) {
                const totalReceita = dados.reduce((acc, h) => acc + (h.valor * 4), 0);
                const totalAulas = dados.reduce((acc, h) => acc + (h.dias.length * 4), 0);
                const mediaAlunos = dados.length > 0 ? Math.round(dados.reduce((acc, h) => acc + (parseInt(h.mediaAlunos)||0), 0) / dados.length) : 0;
                const mediaValor = dados.length > 0 ? (dados.reduce((acc, h) => acc + (parseFloat(h.valor)||0), 0) / dados.length) : 0;
                
                document.getElementById('kpi-receita').innerText = `R$ ${totalReceita.toFixed(2)}`;
                document.getElementById('kpi-aulas').innerText = totalAulas;
                document.getElementById('kpi-media-alunos').innerText = mediaAlunos;
                document.getElementById('kpi-media-valor').innerText = `R$ ${mediaValor.toFixed(2)}`;
            }

            trocarAbaRelatorio(aba) {
                this.abaRelatorioAtiva = aba;
                this.atualizarVisualAbas();
            }

            atualizarVisualAbas() {
                ['geral', 'ranking', 'feriado'].forEach(a => {
                    document.getElementById(`conteudo-rel-${a}`).classList.add('hidden');
                    document.getElementById(`tab-rel-${a}`).classList.remove('active');
                });
                document.getElementById(`conteudo-rel-${this.abaRelatorioAtiva}`).classList.remove('hidden');
                document.getElementById(`tab-rel-${this.abaRelatorioAtiva}`).classList.add('active');
            }

            renderizarAbaGeral(dados) {
                const tbody = document.getElementById('body-relatorio');
                const empty = document.getElementById('relatorio-empty');

                if(dados.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                    return;
                }
                empty.classList.add('hidden');

                const listaOrdenada = [...dados].sort((a, b) => {
                    let valA, valB;
                    const uA = this.db.unidades.find(x => x.id == a.unidadeId);
                    const uB = this.db.unidades.find(x => x.id == b.unidadeId);
                    const mA = this.db.mentores.find(x => x.id == uA?.mentorId);
                    const mB = this.db.mentores.find(x => x.id == uB?.mentorId);
                    const modA = this.db.modalidades.find(x => x.id == a.modalidadeId);
                    const modB = this.db.modalidades.find(x => x.id == b.modalidadeId);

                    switch (this.ordenacaoRelatorio.campo) {
                        case 'unidade': valA = uA?.nome || ''; valB = uB?.nome || ''; break;
                        case 'pais': valA = (uA?.pais + uA?.estado) || ''; valB = (uB?.pais + uB?.estado) || ''; break;
                        case 'mentor': valA = mA?.nome || ''; valB = mB?.nome || ''; break;
                        case 'professor': valA = a.professor || ''; valB = b.professor || ''; break;
                        case 'modalidade': valA = modA?.nome || ''; valB = modB?.nome || ''; break;
                        case 'media': valA = a.mediaAlunos || 0; valB = b.mediaAlunos || 0; break;
                        case 'valor': valA = a.valor || 0; valB = b.valor || 0; break;
                        case 'mensal': valA = (a.valor || 0) * 4; valB = (b.valor || 0) * 4; break;
                        default: valA = uA?.nome || ''; valB = uB?.nome || '';
                    }

                    if (valA < valB) return this.ordenacaoRelatorio.direcao === 'asc' ? -1 : 1;
                    if (valA > valB) return this.ordenacaoRelatorio.direcao === 'asc' ? 1 : -1;
                    return 0;
                });

                tbody.innerHTML = listaOrdenada.map(h => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     const m = this.db.mentores.find(x => x.id == u?.mentorId);
                     const mod = this.db.modalidades.find(md => md.id == h.modalidadeId);
                     const valorMensal = h.valor * 4;
                     const local = `${u?.pais || ''}/${u?.estado || ''}`;
                     
                     return `<tr class="border-b hover:bg-slate-50 transition-colors">
                        <td class="p-3 text-xs font-bold text-gray-700">${u?.nome || '-'}</td>
                        <td class="p-3 text-xs text-gray-500 uppercase">${local}</td>
                        <td class="p-3 text-xs text-gray-600 font-medium">${m?.nome || '-'}</td>
                        <td class="p-3 text-xs text-gray-600">${h.professor}</td>
                        <td class="p-3 text-xs text-gray-600 font-bold text-blue-600">${mod?.nome || '-'}</td>
                        <td class="p-3 text-xs text-center font-bold text-gray-700">${h.mediaAlunos}</td>
                        <td class="p-3 text-xs text-center font-mono text-gray-500">R$ ${h.valor.toFixed(2)}</td>
                        <td class="p-3 text-xs text-center font-mono font-bold text-green-600">R$ ${valorMensal.toFixed(2)}</td>
                     </tr>`;
                }).join('');
            }

            ordenarRelatorio(campo) {
                if (this.ordenacaoRelatorio.campo === campo) {
                    this.ordenacaoRelatorio.direcao = this.ordenacaoRelatorio.direcao === 'asc' ? 'desc' : 'asc';
                } else {
                    this.ordenacaoRelatorio.campo = campo;
                    this.ordenacaoRelatorio.direcao = 'asc';
                }
                this.renderizarAbaGeral(this.filtrarDadosRelatorio());
            }

            // --- ABA RANKING (MODIFICADA PARA ORDENAÇÃO) ---
            ordenarRanking(campo) {
                if (this.ordenacaoRanking.campo === campo) {
                    this.ordenacaoRanking.direcao = this.ordenacaoRanking.direcao === 'asc' ? 'desc' : 'asc';
                } else {
                    this.ordenacaoRanking.campo = campo;
                    this.ordenacaoRanking.direcao = 'asc'; // Padrão asc
                }
                // Re-renderiza passando os dados filtrados atuais
                this.renderizarAbaRanking(this.filtrarDadosRelatorio());
            }

            renderizarAbaRanking(dados) {
                const tbody = document.getElementById('body-ranking');
                
                // 1. Calcula o Ranking REAL (Baseado na Média) ANTES de qualquer ordenação visual
                // Isso garante que o #1 seja sempre quem tem a maior média, independente da ordem da tabela
                let listaProcessada = [...dados].sort((a,b) => (b.mediaAlunos||0) - (a.mediaAlunos||0)).map((item, index) => ({
                    ...item,
                    rankingReal: index + 1 // Posição absoluta baseada na média
                }));

                // 2. Aplica a Ordenação Visual escolhida pelo usuário
                listaProcessada.sort((a, b) => {
                    let valA, valB;
                    const uA = this.db.unidades.find(x => x.id == a.unidadeId);
                    const uB = this.db.unidades.find(x => x.id == b.unidadeId);
                    const mA = this.db.mentores.find(x => x.id == uA?.mentorId);
                    const mB = this.db.mentores.find(x => x.id == uB?.mentorId);
                    const modA = this.db.modalidades.find(x => x.id == a.modalidadeId);
                    const modB = this.db.modalidades.find(x => x.id == b.modalidadeId);

                    switch (this.ordenacaoRanking.campo) {
                        case 'classificacao': valA = a.rankingReal; valB = b.rankingReal; break;
                        case 'unidade': valA = uA?.nome || ''; valB = uB?.nome || ''; break;
                        case 'mentor': valA = mA?.nome || ''; valB = mB?.nome || ''; break;
                        case 'detalhe': valA = (a.professor || '') + (modA?.nome || ''); valB = (b.professor || '') + (modB?.nome || ''); break;
                        case 'media': valA = a.mediaAlunos || 0; valB = b.mediaAlunos || 0; break;
                        default: valA = a.rankingReal; valB = b.rankingReal;
                    }

                    if (valA < valB) return this.ordenacaoRanking.direcao === 'asc' ? -1 : 1;
                    if (valA > valB) return this.ordenacaoRanking.direcao === 'asc' ? 1 : -1;
                    return 0;
                });

                // 3. Renderiza a tabela (Lista completa, sem limite de 15)
                tbody.innerHTML = listaProcessada.map((h) => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     const m = this.db.mentores.find(x => x.id == u?.mentorId);
                     const mod = this.db.modalidades.find(md => md.id == h.modalidadeId);
                     
                     // Cores para o Top 3 do Ranking REAL
                     let corPos = "text-gray-500 font-bold";
                     if(h.rankingReal===1) corPos = "text-yellow-500 font-bold text-lg";
                     if(h.rankingReal===2) corPos = "text-gray-400 font-bold text-lg";
                     if(h.rankingReal===3) corPos = "text-orange-600 font-bold text-lg";

                     return `<tr class="border-b hover:bg-gray-50">
                        <td class="${corPos} p-3 align-middle text-center">#${h.rankingReal}</td>
                        <td class="p-3 font-bold text-gray-700">${u?.nome || '-'}</td>
                        <td class="p-3 text-gray-500">${m?.nome || '-'}</td>
                        <td class="p-3 text-gray-600">${h.professor} <span class="text-[10px] bg-blue-100 text-blue-700 px-1 rounded ml-1">${mod?.nome || ''}</span></td>
                        <td class="text-right font-bold p-3 align-middle text-blue-600 text-sm">${h.mediaAlunos}</td>
                     </tr>`;
                }).join('');
            }

            renderizarAbaFeriados(dados) {
                const mesSelecionado = parseInt(document.getElementById('rel-mes').value);
                const anoSelecionado = parseInt(document.getElementById('rel-ano').value);

                const feriadosDoMes = [
                    ...this.constantes.feriadosFixos.filter(f => f.m === mesSelecionado).map(f => ({...f, dataIso: `${anoSelecionado}-${String(f.m+1).padStart(2,'0')}-${String(f.d).padStart(2,'0')}`})),
                    ...(this.db.feriados || []).filter(f => {
                        const dMes = parseInt(f.data.split('-')[1]) - 1; 
                        return dMes === mesSelecionado;
                    }).map(f => ({nome: f.nome, dataIso: f.data, tipo: f.tipo, local: f.local}))
                ];

                const listaCancelamentos = [];
                let totalEconomizado = 0;

                feriadosDoMes.forEach(feriado => {
                    const [y, m, d] = feriado.dataIso.split('-');
                    const dateObj = new Date(y, m-1, d);
                    const diaSemanaNum = dateObj.getDay(); 
                    const diasMap = ["Domingo", "Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado"];
                    const nomeDiaSemana = diasMap[diaSemanaNum];

                    dados.forEach(aula => {
                        if(aula.dias.includes(nomeDiaSemana)) {
                            const unidade = this.db.unidades.find(u => u.id == aula.unidadeId);
                            let impacta = true;
                            if(feriado.tipo === 'nacional' && unidade.pais !== feriado.local) impacta = false;
                            if(feriado.tipo === 'estadual' && unidade.estado !== feriado.local) impacta = false;

                            if(impacta) {
                                totalEconomizado += (aula.valor || 0);
                                listaCancelamentos.push({
                                    data: `${d}/${m}`,
                                    feriado: feriado.nome,
                                    unidade: unidade.nome,
                                    aula: `${aula.professor} (${nomeDiaSemana})`,
                                    valor: aula.valor
                                });
                            }
                        }
                    });
                });

                document.getElementById('total-economizado').innerText = `R$ ${totalEconomizado.toFixed(2)}`;
                document.getElementById('kpi-canceladas').innerText = listaCancelamentos.length;
                
                const tbody = document.getElementById('body-feriados');
                const empty = document.getElementById('feriado-empty');
                if(listaCancelamentos.length === 0) {
                    tbody.innerHTML = '';
                    empty.classList.remove('hidden');
                } else {
                    empty.classList.add('hidden');
                    tbody.innerHTML = listaCancelamentos.map(c => `
                        <tr class="border-b hover:bg-white transition-colors">
                            <td class="p-3 font-bold text-red-600">${c.data}</td>
                            <td class="p-3 text-gray-700">${c.feriado}</td>
                            <td class="p-3 text-gray-600">${c.unidade}</td>
                            <td class="p-3 text-gray-500 text-xs">${c.aula}</td>
                            <td class="p-3 text-right font-bold text-green-600">+ R$ ${c.valor.toFixed(2)}</td>
                        </tr>`).join('');
                }
            }

            atualizarFiltrosRelatorio(tipo) {
                 const elPais = document.getElementById('rel-pais'); const elEstado = document.getElementById('rel-estado'); const elMentor = document.getElementById('rel-mentor'); const elUnidade = document.getElementById('rel-unidade');
                 const populate = (el, list, def) => { const value = el.value; el.innerHTML = `<option value="">${def}</option>` + list.map(i => `<option value="${i.id||i}">${i.nome||i}</option>`).join(''); if(value && list.some(i => (i.id||i) == value)) el.value = value; };

                 if(tipo === 'init' || tipo === 'pais') { const paises = [...new Set(this.db.unidades.map(u => u.pais).filter(Boolean))]; populate(elPais, paises, "TODOS"); }
                 if(tipo === 'init' || tipo === 'pais') { const pais = elPais.value; const estados = [...new Set(this.db.unidades.filter(u => !pais || u.pais === pais).map(u => u.estado).filter(Boolean))]; populate(elEstado, estados, "TODOS"); }
                 if (tipo === 'init' || tipo === 'pais' || tipo === 'estado') { const pais = elPais.value; const estado = elEstado.value; const units = this.db.unidades.filter(u => (!pais || u.pais === pais) && (!estado || u.estado === estado)); const mIds = [...new Set(units.map(u => u.mentorId))]; const mentors = this.db.mentores.filter(m => mIds.includes(m.id)); populate(elMentor, mentors, "TODOS"); }
                 if (tipo === 'init' || tipo === 'pais' || tipo === 'estado' || tipo === 'mentor') { const pais = elPais.value; const estado = elEstado.value; const mentor = elMentor.value; const units = this.db.unidades.filter(u => (!pais || u.pais === pais) && (!estado || u.estado === estado) && (!mentor || u.mentorId == mentor)); populate(elUnidade, units, "TODAS"); }
            }
            exportarExcel() { alert('Função simplificada nesta versão modular.'); }

            // --- ADMIN E FERIADOS GLOBAIS ---
            toggleFeriadoLocal() { const tipo = document.getElementById('feriado-tipo').value; const localSelect = document.getElementById('feriado-local'); localSelect.innerHTML = ''; if (tipo === 'global') localSelect.classList.add('hidden'); else { localSelect.classList.remove('hidden'); const lista = tipo === 'nacional' ? Object.keys(this.constantes.paisesEstados) : Object.values(this.constantes.paisesEstados).flat(); localSelect.innerHTML = [...new Set(lista)].map(p => `<option value="${p}">${p}</option>`).join(''); } }
            
            // --- UPDATED ADD/UPDATE FUNCTIONS ---
            addFeriado() { 
                const id = document.getElementById('edit-feriado-id').value;
                const nome = document.getElementById('feriado-nome').value.trim().toUpperCase(); 
                const dataInicio = document.getElementById('feriado-data').value; 
                if(!nome || !dataInicio) return alert('PREENCHA NOME E DATA!'); 
                
                if (id) {
                    // Update mode
                    const idx = this.db.feriados.findIndex(f => f.id == id);
                    if (idx > -1) {
                        this.db.feriados[idx] = { 
                            ...this.db.feriados[idx], 
                            nome, 
                            data: dataInicio, 
                            tipo: document.getElementById('feriado-tipo').value, 
                            local: document.getElementById('feriado-local').value 
                        };
                        this.notify('success', 'Feriado atualizado!');
                        this.cancelarEdicao('feriado');
                    }
                } else {
                    // Add mode
                    this.db.feriados.push({ 
                        id: Date.now(), 
                        nome, 
                        data: dataInicio, 
                        tipo: document.getElementById('feriado-tipo').value, 
                        local: document.getElementById('feriado-local').value 
                    });
                    this.notify('success', 'Feriado cadastrado!');
                    document.getElementById('feriado-nome').value = '';
                }
                this.salvarDados(); 
                this.renderListaFeriados(); 
            }
            renderListaFeriados() { 
                const lista = document.getElementById('lista-feriados'); 
                if(lista) lista.innerHTML = this.db.feriados.map(f => `
                    <li class="flex justify-between items-center border-b p-2 text-xs">
                        <span>${f.nome} (${f.data})</span>
                        <div class="flex gap-2">
                            <button onclick="window.app.editarItem('feriados', '${f.id}')" class="text-blue-500 hover:text-blue-700"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                            <button class="text-red-500" onclick="window.app.deleteItem('feriados', '${f.id}')"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                        </div>
                    </li>`).join(''); 
                lucide.createIcons();
            }

            // --- OUTRAS FUNÇÕES DO SISTEMA (CRONOGRAMA, CADASTRO, ETC) ---
            switchConfigTab(tab) {
                const tabCadastro = document.getElementById('tab-cadastro'); const tabFerramentas = document.getElementById('tab-ferramentas');
                const viewCadastro = document.getElementById('subview-cadastro'); const viewFerramentas = document.getElementById('subview-ferramentas');
                if (tab === 'cadastro') { tabCadastro?.classList.add('active', 'text-blue-600', 'border-blue-600'); tabCadastro?.classList.remove('text-gray-500'); tabFerramentas?.classList.remove('active', 'text-blue-600', 'border-blue-600'); tabFerramentas?.classList.add('text-gray-500'); viewCadastro?.classList.remove('hidden'); viewFerramentas?.classList.add('hidden'); this.switchCadastroSubTab('mentor'); } 
                else { tabFerramentas?.classList.add('active', 'text-blue-600', 'border-blue-600'); tabFerramentas?.classList.remove('text-gray-500'); tabCadastro?.classList.remove('active', 'text-blue-600', 'border-blue-600'); tabCadastro?.classList.add('text-gray-500'); viewFerramentas?.classList.remove('hidden'); viewCadastro?.classList.add('hidden'); this.switchFerramentasSubTab('backup'); }
            }
            switchCadastroSubTab(subTab) { 
                ['mentor', 'modalidade', 'unidade', 'grade', 'feriado'].forEach(t => { 
                    const btn = document.getElementById(`subtab-cad-${t}`); 
                    const content = document.getElementById(`view-cad-${t}`); 
                    if (t === subTab) { 
                        btn.classList.add(`${t}-active`, 'shadow-md', 'transform', 'scale-105'); 
                        btn.classList.remove('inactive'); 
                        content.classList.remove('hidden'); 
                    } else { 
                        btn.classList.remove(`${t}-active`, 'shadow-md', 'transform', 'scale-105'); 
                        btn.classList.add('inactive'); 
                        content.classList.add('hidden'); 
                    } 
                }); 
                if(subTab === 'grade') this.renderListaGrade();
                if(subTab === 'feriado') this.renderListaFeriados();
            }
            switchFerramentasSubTab(subTab) { ['backup', 'senhas'].forEach(t => { const btn = document.getElementById(`subtab-ferr-${t}`); const content = document.getElementById(`view-ferr-${t}`); if (t === subTab) { btn.classList.add('active'); btn.classList.remove('inactive'); content.classList.remove('hidden'); } else { btn.classList.remove('active'); btn.classList.add('inactive'); content.classList.add('hidden'); } }); }
            
            // --- CRONOGRAMA & MODAL ---
            setupDraggableModal() {
                 const modal = document.getElementById('modal-card'); const header = document.getElementById('modal-header'); if(!modal || !header) return;
                 let isDragging = false, startX, startY, initialLeft, initialTop;
                 header.addEventListener('mousedown', (e) => { if(e.target.closest('button')) return; isDragging = true; startX = e.clientX; startY = e.clientY; const style = window.getComputedStyle(modal); const matrix = new DOMMatrixReadOnly(style.transform); initialLeft = matrix.m41; initialTop = matrix.m42; header.classList.add('cursor-grabbing'); });
                 window.addEventListener('mousemove', (e) => { if (!isDragging) return; e.preventDefault(); const dx = e.clientX - startX; const dy = e.clientY - startY; modal.style.transform = `translate(${initialLeft + dx}px, ${initialTop + dy}px)`; });
                 window.addEventListener('mouseup', () => { if(isDragging) { isDragging = false; header.classList.remove('cursor-grabbing'); } });
            }
            
            // ============================================================
            //   NOVO MÓDULO CRONOGRAMA (MODULARIZADO E COM VALIDAÇÃO)
            // ============================================================

            // 1. GERENTE (Chama os especialistas)
            renderCronograma() {
                const uid = document.getElementById('cronograma-unidade-select').value; 
                const containerGrade = document.getElementById('cronograma-container');
                const containerValidacao = document.getElementById('painel-validacao-cronograma');

                if(!uid) { 
                    containerGrade.innerHTML='<div class="py-10 text-center text-gray-400 uppercase font-bold text-xs border-2 border-dashed border-gray-200 rounded-lg">SELECIONE UMA UNIDADE PARA VISUALIZAR A GRADE</div>'; 
                    containerValidacao.innerHTML = '';
                    return; 
                }

                // Chama o Especialista em Validação
                this.renderPainelValidacao(containerValidacao, uid);

                // Chama o Especialista em Desenhar Grade
                this.renderGradeHorarios(containerGrade, uid);
                
                lucide.createIcons();
            }

            // 2. ESPECIALISTA EM VALIDAÇÃO (O Box Amarelo/Verde)
            renderPainelValidacao(container, unidadeId) {
                const hoje = new Date();
                const mes = hoje.getMonth();
                const ano = hoje.getFullYear();
                
                // Busca se já existe validação para esta unidade/mês/ano
                const validacao = (this.db.acessos || []).find(a => 
                    (a.unidadeId == unidadeId || a.unidadeId == parseInt(unidadeId)) && 
                    a.mes == mes && 
                    a.ano == ano
                );
                
                if (validacao) {
                    // Cenario 1: Já validado (Verde)
                    container.innerHTML = `
                        <div class="p-3 bg-green-100 border border-green-300 rounded text-green-800 text-xs font-bold uppercase flex items-center gap-2 animate-fade-in">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            <div>
                                <p>CRONOGRAMA VALIDADO EM ${new Date(validacao.data).toLocaleDateString()}</p>
                                <p class="text-[10px] opacity-75 font-normal">Todas as alterações foram salvas e confirmadas.</p>
                            </div>
                        </div>`;
                } else {
                    // Cenario 2: Pendente (Amarelo)
                    container.innerHTML = `
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded text-yellow-800 flex items-start gap-3 animate-fade-in">
                            <input type="checkbox" id="check-validacao" class="mt-1 w-4 h-4 text-blue-600 rounded cursor-pointer" onchange="window.app.realizarValidacao('${unidadeId}')">
                            <label for="check-validacao" class="text-xs font-bold uppercase cursor-pointer select-none">
                                DECLARO QUE CONFERI AS AULAS COLETIVAS, ATUALIZEI AS MÉDIAS E VALIDO O QUADRO DE HORÁRIOS DESTE MÊS.
                                <br><span class="text-[10px] font-normal text-yellow-700">Ao marcar esta opção, você confirma que o cronograma está 100% correto.</span>
                            </label>
                        </div>`;
                }
            }

            // 3. ESPECIALISTA EM GRADE (Desenha a Tabela)
            renderGradeHorarios(container, unidadeId) {
                const h = this.db.horarios.filter(x => x.unidadeId == unidadeId || parseInt(x.unidadeId) === parseInt(unidadeId));
                const times = [...new Set(h.map(x => x.hora))].sort();
                
                let ht = `<table class="w-full border-collapse min-w-[800px] text-xs"><thead><tr><th class="p-3 border-b-2 border-gray-100 bg-gray-50 text-gray-500 w-20">HORA</th>${this.constantes.dias.map(d=>`<th class="p-3 border-b-2 border-gray-100 bg-gray-50 text-gray-700 uppercase">${d}</th>`).join('')}</tr></thead><tbody>`;
                
                const displayTimes = times.length ? times : ["07:00", "08:00", "09:00", "18:00", "19:00", "20:00"];
                
                displayTimes.forEach(t => {
                    ht += `<tr><td class="p-3 border-b border-gray-50 text-center font-bold text-gray-400 bg-gray-50/50">${t}</td>`;
                    this.constantes.dias.forEach(d => {
                        const a = h.find(x => x.hora === t && x.dias.includes(d));
                        if(a) {
                            const mod = this.db.modalidades.find(m => m.id == a.modalidadeId); 
                            const bgColor = mod?.cor || '#64748b';
                            ht += `<td class="p-1 border-b border-gray-50 h-24 w-[13%] align-top"><div onclick="window.app.abrirModalEdicao('${a.id}')" class="aula-card w-full h-full p-2 rounded-lg text-white shadow-sm relative cursor-pointer hover:shadow-md transition-all group overflow-hidden" style="background: linear-gradient(135deg, ${bgColor}, ${this.adjustColor(bgColor, -20)})"><div class="flex flex-col justify-between h-full"><div><div class="font-bold uppercase text-[10px] leading-tight opacity-70 mb-1">${mod?.nome}</div><div class="font-bold text-xs truncate">${a.professor}</div></div><div class="text-[10px] opacity-0 group-hover:opacity-100 transition-opacity flex justify-end"><i data-lucide="edit-2" class="w-3 h-3"></i></div></div></div></td>`;
                        } else { 
                            ht += `<td class="border-b border-gray-50 hover:bg-slate-50 transition-colors"></td>`; 
                        }
                    }); 
                    ht += `</tr>`;
                });
                container.innerHTML = ht + `</tbody></table>`;
            }

            // AÇÃO DE SALVAR A VALIDAÇÃO
            realizarValidacao(unidadeId) {
                if(!confirm('Confirma que todas as aulas e médias estão corretas?')) {
                    const chk = document.getElementById('check-validacao');
                    if(chk) chk.checked = false;
                    return;
                }
                const hoje = new Date();
                
                // Salva no banco de dados "acessos" (que o Acesso Mensal lê)
                this.db.acessos.push({
                    id: Date.now(),
                    unidadeId: parseInt(unidadeId),
                    mes: hoje.getMonth(),
                    ano: hoje.getFullYear(),
                    data: hoje.toISOString(),
                    user: this.currentUser.name
                });
                
                this.salvarDados();
                this.notify('success', 'VALIDAÇÃO REGISTRADA COM SUCESSO!');
                
                // Recarrega o cronograma para mostrar o box verde imediatamente
                this.renderCronograma(); 
            }

            adjustColor(color, amount) { return '#' + color.replace(/^#/, '').replace(/../g, color => ('0'+Math.min(255, Math.max(0, parseInt(color, 16) + amount)).toString(16)).substr(-2)); }
            abrirModalAdicao() { this.abrirModalEdicao(null); }
            abrirModalEdicao(id) {
                const uid = document.getElementById('cronograma-unidade-select').value; if(!uid && !id) return alert('Selecione uma unidade primeiro!');
                const modal = document.getElementById('modal-editor'); const titulo = document.getElementById('modal-titulo'); const btnExcluir = document.getElementById('btn-excluir-modal');
                ['modal-prof', 'modal-hora', 'modal-valor', 'modal-alunos'].forEach(i => document.getElementById(i).value = ''); document.querySelectorAll('.modal-check-dia').forEach(c => c.checked = false);
                const selMod = document.getElementById('modal-modalidade'); selMod.innerHTML = '<option value="">SELECIONE...</option>' + this.db.modalidades.map(m => `<option value="${m.id}">${m.nome}</option>`).join('');
                if (id) {
                    const aula = this.db.horarios.find(h => h.id == id); if(!aula) return;
                    document.getElementById('modal-id').value = id; document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == aula.unidadeId)?.nome; document.getElementById('modal-modalidade').value = aula.modalidadeId; document.getElementById('modal-prof').value = aula.professor; document.getElementById('modal-hora').value = aula.hora; document.getElementById('modal-valor').value = aula.valor; document.getElementById('modal-alunos').value = aula.mediaAlunos;
                    aula.dias.forEach(d => { const ck = Array.from(document.querySelectorAll('.modal-check-dia')).find(c => c.value === d); if(ck) ck.checked = true; });
                    titulo.innerText = 'EDITAR AULA'; btnExcluir.classList.remove('hidden');
                } else { document.getElementById('modal-id').value = ''; document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == uid)?.nome; titulo.innerText = 'NOVA AULA COLETIVA'; btnExcluir.classList.add('hidden'); }
                const card = document.getElementById('modal-card'); card.style.transform = 'none'; modal.classList.remove('hidden');
            }
            salvarModal() {
                const id = document.getElementById('modal-id').value; const uid = document.getElementById('cronograma-unidade-select').value; const aulaUid = id ? this.db.horarios.find(h => h.id == id).unidadeId : uid;
                const novo = { id: id || Date.now(), unidadeId: parseInt(aulaUid), modalidadeId: parseInt(document.getElementById('modal-modalidade').value), professor: document.getElementById('modal-prof').value.toUpperCase(), hora: document.getElementById('modal-hora').value, valor: parseFloat(document.getElementById('modal-valor').value) || 0, mediaAlunos: parseInt(document.getElementById('modal-alunos').value) || 0, dias: Array.from(document.querySelectorAll('.modal-check-dia:checked')).map(c => c.value) };
                if(!novo.modalidadeId || !novo.professor || !novo.hora || !novo.dias.length) return alert('Preencha os campos obrigatórios (*)');
                if (id) { const idx = this.db.horarios.findIndex(h => h.id == id); this.db.horarios[idx] = novo; } else { this.db.horarios.push(novo); }
                this.salvarDados(); this.renderCronograma(); this.fecharModal(); this.notify('success', 'Aula salva com sucesso!');
            }
            excluirViaModal() { if(!confirm('Deseja excluir esta aula?')) return; const id = document.getElementById('modal-id').value; this.db.horarios = this.db.horarios.filter(h => h.id != id); this.salvarDados(); this.renderCronograma(); this.fecharModal(); this.notify('success', 'Aula removida!'); }
            fecharModal() { document.getElementById('modal-editor').classList.add('hidden'); }
            deleteItem(type, id) { if (confirm('Tem certeza que deseja excluir?')) { this.db[type] = this.db[type].filter(i => i.id != id); if (type === 'unidades') { this.db.horarios = this.db.horarios.filter(h => h.unidadeId != id); } this.salvarDados(); this.atualizarListas(); this.notify('success', 'Item excluído com sucesso!'); } }
            
            // --- ATUALIZADO: FUNÇÕES DE CADASTRO COM SUPORTE A EDIÇÃO ---
            addMentor() { 
                const id = document.getElementById('edit-mentor-id').value;
                const nome = document.getElementById('cad-mentor-nome').value.toUpperCase(); 
                const senha = document.getElementById('cad-mentor-senha').value; 
                if (!nome) return;

                if (id) { // Edição
                    const idx = this.db.mentores.findIndex(m => m.id == id);
                    if(idx > -1) {
                        this.db.mentores[idx] = { ...this.db.mentores[idx], nome, senha: String(senha) };
                        this.notify('success', 'Mentor atualizado!');
                        this.cancelarEdicao('mentor');
                    }
                } else { // Novo
                    this.db.mentores.push({id: Date.now(), nome, senha: String(senha)}); 
                    this.notify('success', 'Mentor cadastrado!');
                    document.getElementById('cad-mentor-nome').value = ''; 
                }
                this.salvarDados(); 
                this.atualizarListas(); 
            }

            addUnidade() { 
                const id = document.getElementById('edit-unidade-id').value;
                const nome = document.getElementById('cad-unidade-nome').value.toUpperCase(); 
                const mentor = document.getElementById('cad-unidade-mentor').value; 
                const senha = document.getElementById('cad-unidade-senha').value; 
                const pais = document.getElementById('cad-unidade-pais').value; 
                const estado = document.getElementById('cad-unidade-estado').value; 
                
                if(nome && mentor && pais && estado) { 
                    if(id) { // Edição
                        const idx = this.db.unidades.findIndex(u => u.id == id);
                        if(idx > -1) {
                            this.db.unidades[idx] = { ...this.db.unidades[idx], nome, mentorId: mentor, senha: String(senha), pais, estado };
                            this.notify('success', 'Unidade atualizada!');
                            this.cancelarEdicao('unidade');
                        }
                    } else { // Novo
                        this.db.unidades.push({id: Date.now(), nome, mentorId: mentor, senha: String(senha), pais, estado }); 
                        this.notify('success', 'Unidade cadastrada!');
                        document.getElementById('cad-unidade-nome').value = ''; 
                    }
                    this.salvarDados(); 
                    this.atualizarListas(); 
                } else { alert('Preencha todos os campos da unidade'); } 
            }

            addModalidade() { 
                const id = document.getElementById('edit-modalidade-id').value;
                const nome = document.getElementById('cad-mod-nome').value.toUpperCase(); 
                const cor = document.getElementById('cad-mod-cor').value; 
                
                if (nome) { 
                    if (id) { // Edição
                        const idx = this.db.modalidades.findIndex(m => m.id == id);
                        if (idx > -1) {
                            this.db.modalidades[idx] = { ...this.db.modalidades[idx], nome, cor };
                            this.notify('success', 'Modalidade atualizada!');
                            this.cancelarEdicao('modalidade');
                        }
                    } else { // Novo
                        this.db.modalidades.push({id: Date.now(), nome, cor}); 
                        this.notify('success', 'Modalidade cadastrada!');
                        document.getElementById('cad-mod-nome').value = ''; 
                    }
                    this.salvarDados(); 
                    this.atualizarListas(); 
                } 
            }

            remover(tipo, id) { if(confirm('Tem certeza?')) { this.db[tipo] = this.db[tipo].filter(i => i.id != id); if(tipo === 'unidades') this.db.horarios = this.db.horarios.filter(h => h.unidadeId != id); this.salvarDados(); this.atualizarListas(); this.renderCronograma(); } }
            salvarBackup() { const data = JSON.stringify(this.db, null, 2); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup_pratique_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); this.notify('success', 'BACKUP GERADO!'); }
            resetarBancoDeDados() { if(confirm('ATENÇÃO: ISSO APAGARÁ TUDO! TEM CERTEZA?')) { localStorage.removeItem('pratique_global_db_v5'); location.reload(); } }
            
            restaurarBackup() {
                const input = document.getElementById('input-backup-file');
                if (!input.files.length) return alert('SELECIONE O ARQUIVO .JSON');
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if(json.mentores && json.unidades && json.horarios) {
                            this.db = json;
                            this.registrarLog('Restauração', 'Backup Completo', '-', 'Sistema Restaurado');
                            this.salvarDados();
                            this.init();
                            this.notify('success', 'SISTEMA RESTAURADO!');
                        } else { alert('ARQUIVO INVÁLIDO OU ANTIGO'); }
                    } catch (err) { alert('ERRO AO LER ARQUIVO'); }
                };
                reader.readAsText(file);
            }

            // --- ACESSO MENSAL RESTAURADO ---
            setAcessoTab(tab) { this.currentAcessoTab = tab; this.renderAcessoMensal(); }
            setAcessoFilter(val) { this.acessoFilterTerm = val; this.renderAcessoMensal(); }
            sortAcessoStatus(field) { if (this.acessoStatusSort.field === field) { this.acessoStatusSort.direction = this.acessoStatusSort.direction === 'asc' ? 'desc' : 'asc'; } else { this.acessoStatusSort = { field, direction: 'asc' }; } this.renderAcessoMensal(); }
            updateAcessoDate(val) { const [y, m] = val.split('-'); this.acessoMesSelecionado = parseInt(m) - 1; this.acessoAnoSelecionado = parseInt(y); this.renderAcessoMensal(); }

            renderAcessoMensal() {
                const container = document.getElementById('view-acesso');
                if(!container) return;
                const mes = this.acessoMesSelecionado; const ano = this.acessoAnoSelecionado; const mesStr = (mes + 1).toString().padStart(2, '0');
                let unidades = this.db.unidades; let mentores = this.db.mentores;
                
                if (this.currentUser.role === 'mentor') { mentores = mentores.filter(m => m.id == this.currentUser.id); unidades = unidades.filter(u => u.mentorId == this.currentUser.id); } 
                else if (this.currentUser.role === 'unidade') { unidades = unidades.filter(u => u.id == this.currentUser.id); }

                const totalUnidades = unidades.length;
                const validacoesMes = (this.db.acessos || []).filter(a => a.mes == mes && a.ano == ano && unidades.some(u => u.id == a.unidadeId)).length;
                const pendencias = totalUnidades - validacoesMes;
                
                let html = `
                <div class="max-w-7xl mx-auto space-y-8 animate-fade-in">
                    <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div><h1 class="text-2xl md:text-3xl font-bold text-slate-900 uppercase">Acesso Mensal</h1><p class="text-slate-500 text-xs uppercase">Gestão e acompanhamento de validações</p></div>
                        <div class="flex items-center gap-2 bg-white p-1.5 rounded-lg border border-slate-200 shadow-sm"><div class="p-2 bg-slate-100 rounded-md"><i data-lucide="calendar" class="w-5 h-5 text-slate-600"></i></div><input type="month" value="${ano}-${mesStr}" onchange="window.app.updateAcessoDate(this.value)" class="bg-transparent border-none text-sm font-semibold text-slate-700 focus:ring-0 cursor-pointer uppercase"/></div>
                    </header>
                    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Total de Unidades</p><h3 class="text-3xl font-bold text-slate-800">${totalUnidades}</h3></div><div class="p-3 rounded-lg bg-blue-500"><i data-lucide="building-2" class="w-6 h-6 text-white"></i></div></div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Validações no Mês</p><h3 class="text-3xl font-bold text-slate-800">${validacoesMes}</h3></div><div class="p-3 rounded-lg bg-emerald-500"><i data-lucide="check-circle" class="w-6 h-6 text-white"></i></div></div>
                        <div class="bg-white rounded-xl p-6 shadow-sm border border-slate-100 flex items-start justify-between"><div><p class="text-sm font-medium text-slate-500 mb-1 uppercase">Pendências</p><h3 class="text-3xl font-bold text-slate-800">${pendencias}</h3></div><div class="p-3 rounded-lg bg-red-500"><i data-lucide="alert-circle" class="w-6 h-6 text-white"></i></div></div>
                    </section>
                    <main class="space-y-6">
                        <div class="border-b border-slate-200 sticky-tabs rounded-t-xl px-2 bg-white/90 backdrop-blur-sm">
                            <nav class="-mb-px flex space-x-8 overflow-x-auto" aria-label="Tabs">
                                <button onclick="window.app.setAcessoTab('ranking')" class="acesso-tab-btn uppercase ${this.currentAcessoTab === 'ranking' ? 'active' : 'inactive'}"><i data-lucide="trending-up" class="w-4 h-4"></i> Ranking de Validação</button>
                                <button onclick="window.app.setAcessoTab('status')" class="acesso-tab-btn uppercase ${this.currentAcessoTab === 'status' ? 'active' : 'inactive'}"><i data-lucide="list" class="w-4 h-4"></i> Status Individual</button>
                                <button onclick="window.app.setAcessoTab('detalhe')" class="acesso-tab-btn uppercase ${this.currentAcessoTab === 'detalhe' ? 'active' : 'inactive'}"><i data-lucide="layout-grid" class="w-4 h-4"></i> Detalhamento por Mentor</button>
                            </nav>
                        </div>
                        <div class="min-h-[400px]">`;

                if (this.currentAcessoTab === 'ranking') {
                    const rankingData = mentores.map(m => {
                        const unitsDoMentor = this.db.unidades.filter(u => u.mentorId == m.id);
                        const total = unitsDoMentor.length;
                        const validated = unitsDoMentor.filter(u => (this.db.acessos||[]).some(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano)).length;
                        const pct = total > 0 ? Math.round((validated / total) * 100) : 0;
                        return { id: m.id, name: m.nome, role: 'MENTOR', avatar: m.nome.substring(0,2), completed: validated, total, score: pct };
                    }).sort((a,b) => b.score - a.score);

                    html += `<div class="space-y-6 animate-slide-up"><div class="grid gap-4">${rankingData.map((item, index) => {
                        let barColor = item.score >= 80 ? 'bg-emerald-500' : (item.score >= 50 ? 'bg-yellow-500' : 'bg-red-500');
                        return `<div class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-4 md:gap-8 group"><div class="flex-shrink-0 w-8 h-8 flex items-center justify-center font-bold text-slate-400 bg-slate-50 rounded-full text-sm border border-slate-200">#${index + 1}</div><div class="flex items-center gap-3 w-full md:w-1/4"><div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-700 font-bold text-sm uppercase shadow-sm border-2 border-white">${item.avatar}</div><div><h4 class="font-semibold text-slate-800 uppercase text-sm">${item.name}</h4><p class="text-xs text-slate-500 uppercase">${item.total} Unidades</p></div></div><div class="flex-grow w-full md:w-1/3"><div class="flex justify-between text-xs mb-1"><span class="text-slate-500 uppercase font-medium">Progresso</span><span class="font-bold cursor-help text-emerald-600">${item.completed}/${item.total} Validado</span></div><div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden shadow-inner"><div class="h-2.5 rounded-full ${barColor} transition-all duration-500" style="width: ${item.score}%"></div></div></div><div class="flex-shrink-0 flex items-center justify-end w-full md:w-auto mt-2 md:mt-0"><span class="px-4 py-1 rounded-full text-xs font-bold uppercase border bg-slate-100 text-slate-700 border-slate-200">${item.score}% Concluído</span></div></div>`;
                    }).join('')}</div></div>`;
                } else if (this.currentAcessoTab === 'status') {
                    const statusData = unidades.map(u => {
                        const m = this.db.mentores.find(m => m.id == u.mentorId);
                        const access = (this.db.acessos || []).find(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano);
                        
                        // FORMATADOR DE DATA/HORA
                        let dataFormatada = '-';
                        if (access && access.data) {
                            const d = new Date(access.data);
                            const dia = String(d.getDate()).padStart(2, '0');
                            const mesNum = String(d.getMonth() + 1).padStart(2, '0');
                            const anoNum = d.getFullYear();
                            const hora = String(d.getHours()).padStart(2, '0');
                            const min = String(d.getMinutes()).padStart(2, '0');
                            dataFormatada = `${dia}/${mesNum}/${anoNum} - ${hora}:${min}`;
                        }

                        return { 
                            id: u.id, 
                            mentor: m ? m.nome : 'SEM MENTOR', 
                            unidade: u.nome, 
                            status: access ? 'Validado' : 'Pendente', 
                            data: dataFormatada // AQUI ESTÁ A MUDANÇA
                        };
                    }).filter(item => item.mentor.includes(this.acessoFilterTerm.toUpperCase()) || item.unidade.includes(this.acessoFilterTerm.toUpperCase())).sort((a,b) => this.acessoStatusSort.direction === 'asc' ? a[this.acessoStatusSort.field].localeCompare(b[this.acessoStatusSort.field]) : b[this.acessoStatusSort.field].localeCompare(a[this.acessoStatusSort.field]));
                    
                    html += `<div class="space-y-6 animate-slide-up"><div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm"><div class="flex items-center gap-2"><div class="p-2 bg-indigo-50 rounded-lg"><i data-lucide="list" class="w-5 h-5 text-indigo-600"></i></div><div><h2 class="font-bold text-slate-800 uppercase text-sm">Status Individual</h2></div></div><div class="relative w-full md:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i><input type="text" placeholder="FILTRAR..." value="${this.acessoFilterTerm}" onkeyup="window.app.setAcessoFilter(this.value)" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500 uppercase transition-all" /></div></div><div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div class="overflow-x-auto"><table class="w-full text-xs text-left uppercase"><thead class="bg-slate-50 text-slate-600 font-bold border-b border-slate-200"><tr><th class="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors" onclick="window.app.sortAcessoStatus('mentor')">Mentor</th><th class="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors" onclick="window.app.sortAcessoStatus('unidade')">Unidade</th><th class="px-6 py-4 cursor-pointer hover:bg-slate-100 transition-colors" onclick="window.app.sortAcessoStatus('status')">Status</th><th class="px-6 py-4">Data/Hora Validação</th></tr></thead><tbody class="divide-y divide-slate-100">${statusData.map(item => `<tr class="hover:bg-slate-50 transition-colors"><td class="px-6 py-4 font-bold text-slate-700">${item.mentor}</td><td class="px-6 py-4 text-slate-600 flex items-center gap-2"><i data-lucide="building-2" class="w-3 h-3 text-slate-400"></i> ${item.unidade}</td><td class="px-6 py-4"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold border ${item.status === 'Validado' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : 'bg-red-50 text-red-700 border-red-100'}"><span class="w-1.5 h-1.5 rounded-full ${item.status === 'Validado' ? 'bg-emerald-500' : 'bg-red-500'}"></span>${item.status}</span></td><td class="px-6 py-4 text-slate-500 font-mono">${item.data}</td></tr>`).join('')}</tbody></table></div></div></div>`;
                } else if (this.currentAcessoTab === 'detalhe') {
                    const cardsData = mentores.map(m => {
                        const units = this.db.unidades.filter(u => u.mentorId == m.id);
                        const validated = units.filter(u => (this.db.acessos||[]).some(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano));
                        const pending = units.filter(u => !(this.db.acessos||[]).some(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano));
                        return { id: m.id, nome: m.nome, avatar: m.nome.substring(0,2), total: units.length, validated, pending, score: units.length > 0 ? Math.round((validated.length / units.length) * 100) : 0 };
                    }).filter(m => m.nome.includes(this.acessoFilterTerm.toUpperCase()));
                    html += `<div class="space-y-6 animate-slide-up"><div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl border border-slate-100 shadow-sm mb-6"><div class="flex items-center gap-2"><div class="p-2 bg-indigo-50 rounded-lg"><i data-lucide="layout-grid" class="w-5 h-5 text-indigo-600"></i></div><div><h2 class="font-bold text-slate-800 uppercase text-sm">Cards de Controle</h2></div></div><div class="relative w-full md:w-64"><i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i><input type="text" placeholder="BUSCAR MENTOR..." value="${this.acessoFilterTerm}" onkeyup="window.app.setAcessoFilter(this.value)" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500 uppercase transition-all" /></div></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;
                    cardsData.forEach(card => {
                        const validatedHtml = card.validated.length > 0 ? `<ul class="space-y-1 max-h-32 overflow-y-auto pr-1 custom-scrollbar">${card.validated.map(u => `<li class="text-[10px] flex items-center gap-2 text-slate-600 bg-emerald-50/50 p-1.5 rounded border border-emerald-100/50"><i data-lucide="check-circle" class="w-3 h-3 text-emerald-500"></i> ${u.nome}</li>`).join('')}</ul>` : `<p class="text-[10px] text-slate-400 italic pl-1">Nenhuma validação.</p>`;
                        const pendingHtml = card.pending.length > 0 ? `<ul class="space-y-1 max-h-32 overflow-y-auto pr-1 custom-scrollbar">${card.pending.map(u => `<li class="text-[10px] flex items-center gap-2 text-slate-600 bg-red-50/50 p-1.5 rounded border border-red-100/50"><i data-lucide="alert-circle" class="w-3 h-3 text-red-500"></i> ${u.nome}</li>`).join('')}</ul>` : `<p class="text-[10px] text-emerald-600 font-bold pl-1 flex items-center gap-1"><i data-lucide="check-circle" class="w-3 h-3"></i> Tudo validado!</p>`;
                        html += `<div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden hover:shadow-md transition-all flex flex-col"><div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-indigo-600 text-white flex items-center justify-center font-bold text-xs shadow-md border-2 border-white">${card.avatar}</div><div><h3 class="font-bold text-slate-800 uppercase text-xs">${card.nome}</h3><p class="text-[10px] text-slate-500 uppercase">${card.total} Unidades</p></div></div>${card.score === 100 ? `<div class="bg-emerald-100 text-emerald-700 p-1 rounded-full"><i data-lucide="check-circle" class="w-4 h-4"></i></div>` : ''}</div><div class="p-4 flex-grow flex flex-col gap-4"><div class="flex-1"><h4 class="text-[10px] font-bold text-emerald-700 uppercase mb-2 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span> Realizadas (${card.validated.length})</h4>${validatedHtml}</div><div class="flex-1 border-t border-slate-100 pt-3"><h4 class="text-[10px] font-bold text-red-700 uppercase mb-2 flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Pendentes (${card.pending.length})</h4>${pendingHtml}</div></div></div>`;
                    });
                    html += `</div></div>`;
                }
                html += `</div></main></div>`; container.innerHTML = html; lucide.createIcons();
            }
        }

        window.app = new SistemaPratique();
    </script>
</body>
</html>
