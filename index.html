<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pratique Coletivas - Gestão Happy Zone</title>
    
    <!-- Bibliotecas Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        pratique: {
                            blue: '#0056b3', lightBlue: '#3b82f6', red: '#e63946',
                            gray: '#f3f4f6', dark: '#1e293b', sidebar: '#0f172a'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .glass-panel { background: white; border: 1px solid rgba(226, 232, 240, 0.8); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 12px; }
        .sidebar-link { transition: all 0.2s; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { background-color: rgba(255,255,255,0.05); color: white; }
        .sidebar-link.active { background-color: rgba(59, 130, 246, 0.1); color: #60a5fa; border-left-color: #60a5fa; }
        .sidebar-link.disabled { opacity: 0.3; pointer-events: none; display: none; }
        .table-custom th { background-color: #f8fafc; color: #475569; font-size: 0.75rem; text-transform: uppercase; padding: 12px 16px; font-weight: 700; cursor: pointer; }
        .table-custom td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .aula-card { transition: transform 0.2s, box-shadow 0.2s; position: relative; cursor: pointer; }
        .aula-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 10; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); }
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; }
        .status-online { background-color: #22c55e; }
        .status-offline { background-color: #ef4444; }
        .status-sync { background-color: #f59e0b; animation: pulse 1s infinite; }
        .validation-box { @apply border border-blue-100 bg-blue-50 rounded-lg p-4 mb-4 shadow-sm; }
        .validation-box.validated { @apply border-green-200 bg-green-50; }
        .login-bg { background-color: #0f172a; background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-sm font-sans bg-slate-50">

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center login-bg p-4">
        <div class="bg-white/10 backdrop-blur-lg border border-white/20 p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-white tracking-tight mb-2">PRATIQUE <span class="text-blue-400">COLETIVAS</span></h1>
                <p class="text-blue-200 text-xs uppercase tracking-widest">Gestão & Performance</p>
            </div>
            
            <form onsubmit="event.preventDefault(); window.app.login();" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Usuário / Mentor / Unidade</label>
                    <div class="relative"><i data-lucide="user" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="text" id="login-user" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition uppercase" placeholder="Nome de Acesso" required></div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-blue-200 uppercase mb-1">Senha</label>
                    <div class="relative"><i data-lucide="lock" class="absolute left-3 top-3 h-5 w-5 text-blue-300"></i><input type="password" id="login-pass" class="pl-10 w-full p-3 bg-slate-900/50 border border-slate-700 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition" placeholder="••••••••" required></div>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg uppercase text-xs tracking-wider flex items-center justify-center gap-2"><i data-lucide="log-in" class="w-4 h-4"></i> Acessar Sistema</button>
            </form>
            <div class="mt-6 text-center text-[10px] text-slate-400"><span class="font-bold text-blue-400">Admin:</span> admin / admin123 <br> <span class="font-bold text-blue-400">Padrão:</span> Nome / 1234</div>
            <div id="login-error" class="hidden mt-4 p-3 bg-red-500/20 border border-red-500/50 rounded text-red-200 text-xs text-center font-bold uppercase">Credenciais Inválidas</div>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app-container" class="flex-1 flex overflow-hidden hidden">
        <div id="mobile-menu-overlay" onclick="window.app.toggleMenu()" class="fixed inset-0 bg-black/50 z-40 hidden md:hidden backdrop-blur-sm transition-opacity"></div>
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-pratique-sidebar text-gray-400 flex flex-col flex-shrink-0 transition-transform duration-300 transform -translate-x-full md:relative md:translate-x-0 shadow-2xl md:shadow-none no-print">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center">
                <div><h1 class="text-xl font-bold text-white tracking-tight">PRATIQUE <span class="text-blue-500">COLETIVAS</span></h1><p class="text-xs mt-1 opacity-60">Gestão Happy Zone</p></div>
                <button onclick="window.app.toggleMenu()" class="md:hidden text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <nav class="flex-1 overflow-y-auto py-4 space-y-1">
                <button onclick="window.app.nav('relatorio')" id="nav-relatorio" class="sidebar-link active w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="bar-chart-2" class="w-5 h-5"></i> Relatório Gerencial</button>
                <button onclick="window.app.nav('config')" id="nav-config" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="settings" class="w-5 h-5"></i> Configurações</button>
                <button onclick="window.app.nav('cronograma')" id="nav-cronograma" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="calendar" class="w-5 h-5"></i> Cronograma Visual</button>
                <button onclick="window.app.nav('importacao')" id="nav-importacao" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3"><i data-lucide="database" class="w-5 h-5"></i> Ferramentas Avançadas</button>
                <!-- ACESSO MENSAL -->
                <button onclick="window.app.nav('acesso')" id="nav-acesso" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="user-check" class="w-5 h-5"></i> Acesso Mensal</button>
                <!-- HISTÓRICO -->
                <button onclick="window.app.nav('historico')" id="nav-historico" class="sidebar-link w-full text-left px-6 py-3 flex items-center gap-3 hidden"><i data-lucide="history" class="w-5 h-5"></i> Histórico</button>
            </nav>
            <div class="p-4 border-t border-gray-800 bg-gray-900/50">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold text-xs" id="user-avatar">A</div>
                    <div class="overflow-hidden"><p class="text-white text-xs font-bold truncate" id="user-name">...</p><p class="text-[10px] text-gray-500" id="user-role">...</p></div>
                    <button onclick="window.app.logout()" class="ml-auto text-red-400 hover:text-red-300" title="Sair"><i data-lucide="log-out" class="w-4 h-4"></i></button>
                </div>
                <div class="mt-2 text-[10px] flex items-center gap-1 opacity-50"><span class="status-dot status-offline" id="status-dot"></span> <span id="status-text">Offline</span></div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-50 overflow-hidden relative w-full">
            <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-4 md:px-8 flex-shrink-0 z-10 sticky top-0 no-print">
                <div class="flex items-center gap-3"><button onclick="window.app.toggleMenu()" class="md:hidden p-2 -ml-2 text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button><h2 id="page-title" class="text-lg font-bold text-gray-700 truncate">Visão Geral</h2></div>
                <div class="flex items-center gap-2 md:gap-4">
                    <button onclick="window.app.forcarSincronizacao()" class="text-xs font-bold text-gray-500 hover:text-blue-600 flex items-center gap-1 mr-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Sync</button>
                    <span id="data-atual" class="hidden md:inline-block text-xs font-mono text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                    <button onclick="window.app.salvarBackup()" class="text-blue-600 hover:text-blue-800 text-xs font-bold flex items-center gap-1 bg-blue-50 p-2 rounded-lg"><i data-lucide="save" class="w-4 h-4"></i> <span class="hidden md:inline">Backup</span></button>
                </div>
            </header>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="main-content">
                
                <!-- RELATORIO -->
                <div id="view-relatorio" class="view-section pb-20">
                    <div class="glass-panel p-4 md:p-6 mb-6">
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 text-sm uppercase"><i data-lucide="filter" class="w-4 h-4 text-blue-500"></i> Filtros</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 items-end">
                            <div class="col-span-2 md:col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">Mês/Ano</label><div class="flex gap-1"><select id="rel-mes" class="w-2/3 p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"></select><input type="number" id="rel-ano" class="w-1/3 p-2 border rounded text-xs h-9 uppercase" value="2025" onchange="window.app.gerarRelatorio()"></div></div>
                            <div class="col-span-2 contents" id="admin-filters-container">
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">País</label><select id="rel-pais" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('pais'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                                <div><label class="block text-xs font-bold text-gray-500 mb-1">Estado</label><select id="rel-estado" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('estado'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            </div>
                            <div class="col-span-2 md:col-span-1" id="filter-mentor-wrapper"><label class="block text-xs font-bold text-gray-500 mb-1">Mentor</label><select id="rel-mentor" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('mentor'); window.app.gerarRelatorio()"><option value="">TODOS</option></select></div>
                            <div class="col-span-2 md:col-span-1" id="filter-unidade-wrapper"><label class="block text-xs font-bold text-gray-500 mb-1">Unidade</label><select id="rel-unidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.atualizarFiltrosRelatorio('unidade'); window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><label class="block text-xs font-bold text-gray-500 mb-1">Modalidade</label><select id="rel-modalidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase" onchange="window.app.gerarRelatorio()"><option value="">TODAS</option></select></div>
                            <div class="col-span-2 md:col-span-1"><button onclick="window.app.gerarRelatorio()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-xs uppercase flex items-center justify-center gap-2"><i data-lucide="search" class="w-3 h-3"></i> Filtrar</button></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4 mb-6">
                        <div class="glass-panel p-3 border-l-4 border-blue-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Receita</p><p class="text-lg font-bold text-gray-800 truncate" id="kpi-receita">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-green-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Aulas</p><p class="text-lg font-bold text-gray-800" id="kpi-aulas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-orange-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Média Alunos</p><p class="text-lg font-bold text-gray-800" id="kpi-media-alunos">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-cyan-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Valor Médio</p><p class="text-lg font-bold text-gray-800" id="kpi-media-valor">R$ 0,00</p></div>
                        <div class="glass-panel p-3 border-l-4 border-purple-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Canceladas</p><p class="text-lg font-bold text-red-600" id="kpi-canceladas">0</p></div>
                        <div class="glass-panel p-3 border-l-4 border-pink-500"><p class="text-[10px] font-bold text-gray-400 uppercase">Unidades</p><p class="text-lg font-bold text-pink-600" id="kpi-unidades-count">0</p></div>
                    </div>
                    <div class="glass-panel overflow-hidden mb-6">
                        <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50"><h3 class="font-bold text-gray-700 text-sm uppercase"><i data-lucide="trending-up" class="w-4 h-4 inline"></i> Análise Geral</h3><button onclick="window.app.exportarExcel()" class="text-green-700 bg-green-50 px-3 py-1 rounded text-xs font-bold border border-green-200 flex gap-2 uppercase">Excel</button></div>
                        <div class="overflow-x-auto max-h-[500px]"><table class="w-full table-custom text-left min-w-[800px] uppercase" id="tabela-relatorio"><thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600" id="header-relatorio"></thead><tbody id="body-relatorio"></tbody></table></div>
                        <div id="relatorio-empty" class="p-8 text-center text-gray-400 hidden">Nenhum dado encontrado.</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-4 border-t-4 border-gray-800"><h3 class="font-bold text-gray-800 mb-4 text-sm uppercase"><i data-lucide="award" class="w-5 h-5 inline"></i> Ranking Top 15</h3><table class="w-full text-xs text-left uppercase table-custom" id="tabela-ranking-alunos"><thead><tr><th onclick="window.app.ordenarRanking('pos')">Pos</th><th onclick="window.app.ordenarRanking('unidade')">Unidade/Detalhe</th><th onclick="window.app.ordenarRanking('media')" class="text-right">Média</th></tr></thead><tbody></tbody></table></div>
                        <div id="section-feriados" class="glass-panel border-l-4 border-red-400 bg-red-50/50 p-4 hidden"><div class="flex justify-between items-start mb-2"><h3 class="font-bold text-red-800 mb-2 uppercase"><i data-lucide="calendar-off" class="w-4 h-4"></i> Impacto Feriados</h3><p class="text-xl font-bold text-red-800" id="total-economizado">R$ 0,00</p></div><div class="text-[10px] text-red-600 mb-2 uppercase" id="feriados-lista-nomes"></div><div class="overflow-x-auto max-h-60 border border-red-200 rounded-lg bg-white"><table class="w-full text-xs text-left uppercase" id="tabela-canceladas"><thead class="text-red-900 border-b border-red-200 sticky top-0 bg-red-50"><tr><th class="py-2 px-3">Data</th><th class="py-2 px-3">Feriado</th><th class="py-2 px-3">Unidade</th><th class="py-2 px-3 text-right">Impacto</th></tr></thead><tbody class="text-red-800 text-xs"></tbody></table></div></div>
                    </div>
                </div>

                <!-- CONFIG -->
                <div id="view-config" class="view-section hidden pb-20">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="glass-panel p-4 admin-only-block relative"><h3 class="font-bold text-gray-800 mb-3 border-b pb-2 text-xs uppercase">Mentores (Admin)</h3><div class="flex gap-2 mb-3"><input id="cad-mentor-nome" placeholder="NOME" class="w-full p-2 border rounded text-xs uppercase"><input id="cad-mentor-senha" placeholder="SENHA" class="w-24 p-2 border rounded text-xs text-center bg-yellow-50" value="1234"><button onclick="window.app.addMentor()" class="bg-gray-800 text-white px-3 rounded text-xs hover:bg-black h-9">+</button></div><ul id="lista-mentores" class="space-y-1 max-h-32 overflow-y-auto text-xs uppercase text-gray-600"></ul></div>
                            <div class="glass-panel p-4 border-l-4 border-pink-500 admin-only-block"><h3 class="font-bold text-gray-800 mb-3 border-b pb-2 text-xs uppercase">Modalidades</h3><div class="flex gap-2 mb-3 items-center"><input id="cad-mod-nome" placeholder="NOME" class="flex-1 p-2 border rounded text-xs uppercase"><input type="color" id="cad-mod-cor" class="w-9 h-9 rounded cursor-pointer border p-0" value="#3b82f6"><button onclick="window.app.addModalidade()" class="bg-pink-600 text-white px-3 py-2 rounded text-xs hover:bg-pink-700 h-9 uppercase">Add</button></div><ul id="lista-modalidades" class="space-y-1 max-h-40 overflow-y-auto text-xs uppercase"></ul></div>
                            <div class="glass-panel p-4 border-l-4 border-yellow-500 admin-only-block"><h3 class="font-bold text-gray-800 mb-3 border-b pb-2 text-xs uppercase">Feriados</h3><div class="space-y-2 mb-3"><input id="feriado-nome" placeholder="NOME DO FERIADO" class="w-full p-2 border rounded text-xs uppercase"><div class="flex gap-2"><div class="w-1/2"><label class="text-[10px] text-gray-500 font-bold">INÍCIO</label><input type="date" id="feriado-data" class="w-full p-2 border rounded text-xs"></div><div class="w-1/2"><label class="text-[10px] text-gray-500 font-bold">FIM</label><input type="date" id="feriado-data-fim" class="w-full p-2 border rounded text-xs"></div></div><select id="feriado-tipo" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.toggleFeriadoLocal()"><option value="global">GLOBAL</option><option value="nacional">NACIONAL</option><option value="estadual">ESTADUAL</option></select><select id="feriado-local" class="w-full p-2 border rounded text-xs bg-white uppercase hidden"></select><button onclick="window.app.addFeriado()" class="w-full bg-yellow-600 text-white py-2 rounded text-xs font-bold hover:bg-yellow-700 h-9 uppercase">ADICIONAR</button></div><ul id="lista-feriados" class="space-y-1 max-h-40 overflow-y-auto text-xs uppercase"></ul></div>
                        </div>
                        <div class="lg:col-span-1">
                            <div class="glass-panel p-4 h-full"><h3 class="font-bold text-gray-800 mb-3 border-b pb-2 text-xs uppercase">Unidades</h3><div class="space-y-2 mb-3"><select id="cad-unidade-mentor" class="w-full p-2 border rounded text-xs bg-white uppercase"><option value="">MENTOR...</option></select><input id="cad-unidade-nome" placeholder="NOME UNIDADE" class="w-full p-2 border rounded text-xs uppercase"><input id="cad-unidade-senha" placeholder="SENHA" class="w-full p-2 border rounded text-xs h-9 bg-yellow-50 text-center font-bold" value="1234"><div class="grid grid-cols-2 gap-2"><select id="cad-unidade-pais" class="w-full p-2 border rounded text-xs bg-white uppercase" onchange="window.app.atualizarEstados()"><option value="Brasil">BRASIL</option></select><select id="cad-unidade-estado" class="w-full p-2 border rounded text-xs bg-white uppercase"></select></div><button onclick="window.app.addUnidade()" class="w-full bg-blue-600 text-white py-2 rounded text-xs font-bold hover:bg-blue-700 h-9 uppercase">SALVAR</button></div><input placeholder="BUSCAR..." class="w-full p-2 border rounded text-xs mb-2 bg-slate-50 uppercase" onkeyup="window.app.filtrarListaUnidades(this.value)"><ul id="lista-unidades" class="space-y-2 max-h-[300px] overflow-y-auto text-xs text-gray-600 uppercase"></ul></div>
                        </div>
                        <div class="lg:col-span-1">
                             <div class="glass-panel p-4 border-2 border-blue-100 h-full"><h3 class="font-bold text-blue-800 mb-4 flex items-center gap-2 text-xs uppercase"><span class="bg-blue-100 p-1 rounded"><i data-lucide="calendar-plus" class="w-4 h-4"></i></span> 4. Grade Horária</h3><div class="space-y-3"><div><label class="text-[10px] font-bold text-gray-400">ONDE?</label><select id="grade-unidade" class="w-full p-2 border rounded text-xs bg-white font-bold text-gray-700 mb-1 h-9 uppercase"></select></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-gray-400">MODALIDADE</label><select id="grade-modalidade" class="w-full p-2 border rounded text-xs bg-white h-9 uppercase"></select></div><div><label class="text-[10px] font-bold text-gray-400">PROFESSOR</label><input id="grade-prof" placeholder="NOME" class="w-full p-2 border rounded text-xs uppercase"></div></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-gray-400">VALOR (R$)</label><input type="number" id="grade-valor" placeholder="0.00" class="w-full p-2 border rounded text-xs h-9"></div><div><label class="text-[10px] font-bold text-orange-500">MÉDIA ALUNOS</label><input type="number" id="grade-alunos" placeholder="0" class="w-full p-2 border rounded text-xs border-orange-200 h-9"></div></div><div class="grid grid-cols-2 gap-2"><div><label class="text-[10px] font-bold text-gray-400">HORA</label><input type="time" id="grade-hora" class="w-full p-2 border rounded text-xs h-9"></div><div><label class="text-[10px] font-bold text-gray-400">DIAS</label><div class="flex gap-1 flex-wrap" id="check-dias"></div></div></div><div class="flex gap-2"><button onclick="window.app.addHorario()" id="btn-save-grade" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow-md text-xs mt-2 transition h-10 uppercase">ADICIONAR</button><button onclick="window.app.cancelarEdicao()" id="btn-cancel-grade" class="hidden bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-3 rounded shadow-md text-xs mt-2 transition h-10 uppercase">CANCELAR</button></div></div><div class="mt-4 border-t pt-4"><h4 class="font-bold text-gray-400 text-[10px] uppercase mb-2">Últimas Cadastradas</h4><div id="lista-grades-recentes" class="space-y-2 uppercase"></div></div></div>
                        </div>
                    </div>
                </div>

                <!-- CRONOGRAMA -->
                <div id="view-cronograma" class="view-section hidden pb-20">
                    <div class="glass-panel p-4 min-h-[500px]">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-xl text-gray-800 uppercase flex gap-2 items-center"><i data-lucide="layout-grid" class="w-6 h-6 text-blue-600"></i> Cronograma</h3><div class="flex gap-2 items-center"><div class="w-64 relative"><select id="cronograma-unidade-select" class="w-full p-2 border rounded text-xs uppercase font-bold pl-8" onchange="window.app.renderCronograma()"><option value="">SELECIONE...</option></select><i data-lucide="map-pin" class="absolute left-2 top-2.5 w-4 h-4 text-gray-400"></i></div><button onclick="window.app.abrirModalAdicao()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-xs font-bold uppercase shadow flex items-center gap-2"><i data-lucide="plus" class="w-4 h-4"></i> Aula</button></div></div>
                        <!-- ÁREA DE VALIDAÇÃO (Ligada ao Ranking) -->
                        <div id="cronograma-validacao-container" class="mb-4"></div>
                        <div id="cronograma-container" class="overflow-x-auto rounded-lg border border-gray-100 bg-white min-h-[300px]"><div class="h-full flex flex-col items-center justify-center text-gray-300 py-20"><i data-lucide="mouse-pointer-click" class="w-16 h-16 mb-4 opacity-50"></i><p class="text-lg text-center px-4 uppercase">Selecione uma unidade.</p></div></div>
                    </div>
                </div>
                
                <!-- FERRAMENTAS -->
                <div id="view-importacao" class="view-section hidden pb-20">
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-6xl mx-auto">
                        <div class="glass-panel p-6 md:col-span-2 border-l-4 border-blue-600">
                            <div class="flex justify-between items-center mb-4"><h2 class="font-bold text-gray-800 flex items-center gap-2 uppercase"><i data-lucide="key" class="w-5 h-5 text-blue-600"></i> Gestão de Senhas</h2><button onclick="window.app.resetarBancoDeDados()" class="bg-red-600 hover:bg-red-700 text-white text-[10px] font-bold px-3 py-1.5 rounded uppercase">⚠️ Resetar (Pânico)</button></div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div><h4 class="font-bold text-xs text-gray-500 uppercase mb-2 border-b pb-1">Mentores</h4><div class="relative mb-2"><input type="text" placeholder="BUSCAR..." class="w-full p-2 pl-8 border rounded text-xs bg-slate-50 uppercase focus:border-blue-500 transition" onkeyup="window.app.renderAcessos('mentores', this.value)"><i data-lucide="search" class="absolute left-2.5 top-2.5 w-3 h-3 text-gray-400"></i></div><div class="max-h-60 overflow-y-auto pr-2 space-y-2" id="lista-senhas-mentores"></div></div>
                                <div><h4 class="font-bold text-xs text-gray-500 uppercase mb-2 border-b pb-1">Unidades</h4><div class="relative mb-2"><input type="text" placeholder="BUSCAR..." class="w-full p-2 pl-8 border rounded text-xs bg-slate-50 uppercase focus:border-blue-500 transition" onkeyup="window.app.renderAcessos('unidades', this.value)"><i data-lucide="search" class="absolute left-2.5 top-2.5 w-3 h-3 text-gray-400"></i></div><div class="max-h-60 overflow-y-auto pr-2 space-y-2" id="lista-senhas-unidades"></div></div>
                            </div>
                        </div>
                        <div class="glass-panel p-6"><h2 class="font-bold text-gray-800 mb-2 uppercase">Importar Unidades</h2><textarea id="import-unidades-text" class="w-full h-24 p-3 border rounded text-xs mb-2"></textarea><button onclick="window.app.importarUnidades()" class="bg-blue-600 text-white px-4 py-2 rounded text-xs w-full font-bold uppercase">Processar</button></div>
                        <div class="glass-panel p-6"><h2 class="font-bold text-gray-800 mb-2 uppercase">Importar Grades</h2><textarea id="import-grades-text" class="w-full h-24 p-3 border rounded text-xs mb-2"></textarea><button onclick="window.app.importarGrades()" class="bg-green-600 text-white px-4 py-2 rounded text-xs w-full font-bold uppercase">Processar</button></div>
                        <div class="glass-panel p-6 md:col-span-2 border-l-4 border-orange-500"><h2 class="font-bold text-gray-800 mb-2 flex items-center gap-2 uppercase"><i data-lucide="download" class="w-4 h-4"></i> Exportação</h2><div class="flex gap-4"><button onclick="window.app.exportarUnidadesCSV()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-3 rounded text-xs font-bold flex-1 flex items-center justify-center gap-2 uppercase"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Unidades</button><button onclick="window.app.exportarGrades()" class="bg-green-700 hover:bg-green-800 text-white px-4 py-3 rounded text-xs font-bold flex-1 flex items-center justify-center gap-2 uppercase"><i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Grades</button></div></div>
                        <div class="glass-panel p-6 md:col-span-2 border-t-4 border-gray-800 flex flex-col md:flex-row gap-6 justify-between items-center"><div class="w-full"><h2 class="font-bold text-gray-800 mb-2 uppercase">Backup</h2><div class="flex gap-2 items-center"><input type="file" id="input-backup-file" accept=".json" class="text-xs w-full"><button onclick="window.app.restaurarBackup()" class="bg-purple-600 text-white px-4 py-2 rounded text-xs font-bold uppercase">Restaurar</button></div></div><div class="w-full md:w-auto"><button onclick="window.app.salvarBackup()" class="bg-gray-800 text-white px-6 py-3 rounded font-bold w-full md:w-auto flex items-center justify-center gap-2 uppercase"><i data-lucide="save" class="w-4 h-4"></i> Baixar Backup</button></div></div>
                    </div>
                </div>

                <!-- HISTÓRICO -->
                <div id="view-historico" class="view-section hidden pb-20">
                    <div class="glass-panel p-6">
                        <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2 uppercase"><i data-lucide="history" class="w-5 h-5 text-blue-600"></i> Histórico</h2>
                        <div class="overflow-x-auto max-h-[600px] border rounded-lg"><table class="w-full text-xs text-left uppercase table-custom"><thead class="sticky top-0 bg-gray-50 shadow-sm z-10 text-gray-600"><tr><th class="p-3">Data/Hora</th><th class="p-3">Usuário</th><th class="p-3">Ação</th><th class="p-3">Detalhe</th><th class="p-3">Anterior</th><th class="p-3">Novo</th></tr></thead><tbody id="lista-historico" class="bg-white text-gray-700"></tbody></table></div>
                    </div>
                </div>

                <!-- ABA ACESSO MENSAL (RANKING) -->
                <div id="view-acesso" class="view-section hidden pb-20">
                    <div class="glass-panel p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <div><h2 class="font-bold text-2xl text-gray-800 uppercase flex gap-2"><i data-lucide="trophy" class="w-6 h-6 text-yellow-500"></i> Ranking de Mentoria</h2><p class="text-xs text-gray-500 uppercase mt-1">Desempenho na validação mensal das unidades</p></div>
                            <div class="flex gap-2 items-center bg-gray-50 p-2 rounded-lg border"><label class="text-xs font-bold text-gray-500">PERÍODO:</label><select id="acesso-mes" class="p-2 border rounded text-xs bg-white uppercase font-bold text-blue-700" onchange="window.app.renderAcessoMensal()"></select><input type="number" id="acesso-ano" class="w-20 p-2 border rounded text-xs bg-white uppercase font-bold text-blue-700" value="2025" onchange="window.app.renderAcessoMensal()"></div>
                        </div>
                        
                        <!-- KPIs -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                             <div class="p-6 bg-white border-l-4 border-blue-500 shadow-sm rounded-r-lg flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase mb-1">Total Unidades</p><p class="text-3xl font-black text-gray-800" id="acesso-total">0</p></div><div class="p-3 bg-blue-50 rounded-full text-blue-600"><i data-lucide="building" class="w-6 h-6"></i></div></div>
                             <div class="p-6 bg-white border-l-4 border-green-500 shadow-sm rounded-r-lg flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase mb-1">Validaram Mês</p><p class="text-3xl font-black text-green-600" id="acesso-ok">0</p></div><div class="p-3 bg-green-50 rounded-full text-green-600"><i data-lucide="check-circle" class="w-6 h-6"></i></div></div>
                             <div class="p-6 bg-white border-l-4 border-red-500 shadow-sm rounded-r-lg flex justify-between items-center"><div><p class="text-xs text-gray-400 font-bold uppercase mb-1">Pendentes</p><p class="text-3xl font-black text-red-600" id="acesso-pendente">0</p></div><div class="p-3 bg-red-50 rounded-full text-red-600"><i data-lucide="clock" class="w-6 h-6"></i></div></div>
                        </div>

                        <!-- Ranking Premium -->
                        <div class="mb-8 p-6 bg-gradient-to-r from-slate-900 to-slate-800 rounded-xl shadow-lg text-white">
                            <h3 class="font-bold text-lg mb-6 flex items-center gap-2 uppercase border-b border-white/10 pb-2"><i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i> Líderes em Validação</h3>
                            <div id="ranking-mentores-container" class="space-y-4"></div>
                        </div>

                        <!-- Cards Mentores -->
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 uppercase text-sm border-b pb-2"><i data-lucide="users" class="w-4 h-4"></i> Status Individual</h3>
                        <div id="grid-mentores-acesso" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8"></div>

                        <!-- Tabela Detalhada -->
                        <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2 uppercase text-sm border-b pb-2 mt-8"><i data-lucide="list-checks" class="w-4 h-4"></i> Detalhamento por Unidade</h3>
                        <div class="border rounded-lg overflow-hidden bg-white shadow-sm">
                            <div class="max-h-[500px] overflow-y-auto">
                                <table class="w-full text-xs text-left uppercase"><thead class="bg-gray-50 text-gray-500 sticky top-0 z-10 shadow-sm"><tr><th class="p-3 border-b cursor-pointer hover:bg-gray-100" onclick="window.app.ordenarStatus('unidade')">Unidade ↕</th><th class="p-3 border-b cursor-pointer hover:bg-gray-100" onclick="window.app.ordenarStatus('mentor')">Mentor ↕</th><th class="p-3 border-b text-center cursor-pointer hover:bg-gray-100" onclick="window.app.ordenarStatus('status')">Status ↕</th></tr></thead><tbody id="tabela-status-unidades" class="text-gray-700"></tbody></table>
                            </div>
                            <div class="bg-gray-50 p-3 border-t flex justify-between items-center text-xs font-bold text-gray-500 uppercase"><span id="footer-total-validadas" class="text-green-600">Validadas: 0</span><span id="footer-total-pendentes" class="text-red-600">Pendentes: 0</span></div>
                        </div>
                     </div>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="modal-editor" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden">
        <div id="modal-card" class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-none relative max-h-[90vh] flex flex-col">
            <div id="modal-header" class="bg-blue-600 p-4 flex justify-between items-center text-white cursor-move select-none active:bg-blue-700"><h3 class="font-bold text-lg flex items-center gap-2 uppercase"><i data-lucide="move" class="w-4 h-4 text-white/50"></i> <span id="modal-titulo">Editar Aula</span></h3><button onclick="window.app.fecharModal()"><i data-lucide="x" class="w-6 h-6"></i></button></div>
            <div class="p-4 space-y-4 overflow-y-auto">
                <input type="hidden" id="modal-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 mb-1">Unidade</label><input type="text" id="modal-unidade-view" class="w-full p-2 border rounded bg-gray-100 text-xs font-bold text-gray-600 h-10 uppercase" disabled></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Modalidade</label><select id="modal-modalidade" class="w-full p-2 border rounded text-xs bg-white h-10 uppercase"></select></div></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Professor</label><input type="text" id="modal-prof" class="w-full p-2 border rounded text-xs h-10 uppercase"></div>
                <div class="grid grid-cols-3 gap-3"><div><label class="block text-xs font-bold text-gray-500 mb-1">Hora</label><input type="time" id="modal-hora" class="w-full p-2 border rounded text-xs h-10"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Valor</label><input type="number" id="modal-valor" class="w-full p-2 border rounded text-xs h-10"></div><div><label class="block text-xs font-bold text-gray-500 mb-1">Alunos</label><input type="number" id="modal-alunos" class="w-full p-2 border rounded text-xs h-10"></div></div>
                <div><label class="block text-xs font-bold text-gray-500 mb-1">Dias</label><div class="flex flex-wrap gap-2" id="modal-dias-container"></div></div>
            </div>
            <div class="bg-gray-50 p-4 flex justify-between gap-3 border-t"><button onclick="window.app.excluirViaModal()" id="btn-excluir-modal" class="text-red-500 hover:text-red-700 text-xs font-bold px-2 py-2 flex items-center gap-1 uppercase"><i data-lucide="trash-2" class="w-4 h-4"></i> Excluir</button><button onclick="window.app.salvarModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded text-sm shadow-md transition flex-1 md:flex-none uppercase">Salvar</button></div>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-5 right-5 bg-gray-800 text-white px-6 py-4 rounded shadow-xl transform translate-x-full transition-transform duration-300 z-[70] flex items-center gap-4 border-l-4 border-green-500 max-w-[90%]"><div id="toast-icon" class="text-2xl">✅</div><div><h4 id="toast-title" class="font-bold text-sm uppercase">Sucesso</h4><p id="toast-msg" class="text-xs opacity-80 uppercase">Operação realizada.</p></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => { window.app = new SistemaPratique(); });

        class SistemaPratique {
            constructor() {
                this.db = { mentores: [], unidades: [], modalidades: [], horarios: [], historico: [], feriados: [], acessos: [] };
                this.apiUrl = 'https://script.google.com/macros/s/AKfycbz8LU_ekbnZ7tAwrvxyaASzql0Cvqe-HAVGhWpO-TkOWot3AcWjpAALTB3u2bOGx8hbfA/exec';
                this.currentUser = null;
                this.editingId = null;
                this.dadosExibidos = [];
                this.modoAgrupamento = 'detalhado';
                this.ordenacao = { campo: 'receita', direcao: 'desc' };
                this.rankingData = [];
                this.ordenacaoRanking = { campo: 'media', direcao: 'desc' };
                this.ordenacaoStatus = { campo: 'unidade', direcao: 'asc' };
                this.mobileMenuOpen = false;

                this.constantes = {
                    dias: ["Segunda", "Terça", "Quarta", "Quinta", "Sexta", "Sábado", "Domingo"],
                    meses: ["JANEIRO", "FEVEREIRO", "MARÇO", "ABRIL", "MAIO", "JUNHO", "JULHO", "AGOSTO", "SETEMBRO", "OUTUBRO", "NOVEMBRO", "DEZEMBRO"],
                    feriadosFixos: [{d:1,m:0,nome:"CONF. UNIVERSAL"}, {d:21,m:3,nome:"TIRADENTES"}, {d:1,m:4,nome:"DIA DO TRABALHO"}, {d:7,m:8,nome:"INDEPENDÊNCIA"}, {d:12,m:9,nome:"N. SRA. APARECIDA"}, {d:2,m:10,nome:"FINADOS"}, {d:15,m:10,nome:"PROCLAMAÇÃO"}, {d:25,m:11,nome:"Natal"}],
                    paisesEstados: { 'Brasil': ["AC", "AL", "AP", "AM", "BA", "CE", "DF", "ES", "GO", "MA", "MT", "MS", "MG", "PA", "PB", "PR", "PE", "PI", "RJ", "RN", "RS", "RO", "RR", "SC", "SP", "SE", "TO"], 'Estados Unidos': ["AL", "AK", "AZ", "AR", "CA", "CO", "CT", "DE", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"], 'Argentina': ["Buenos Aires", "Catamarca", "Chaco", "Chubut", "Córdoba", "Corrientes", "Entre Ríos", "Formosa", "Jujuy", "La Pampa", "La Rioja", "Mendoza", "Misiones", "Neuquén", "Río Negro", "Salta", "San Juan", "San Luis", "Santa Cruz", "Santa Fe", "Santiago del Estero", "Tierra del Fuego", "Tucumán"] }
                };
                this.init();
                this.setupDraggableModal();
            }

            init() {
                this.carregarDadosLocais();
                this.setupUI();
                const sessionUser = sessionStorage.getItem('pratique_user');
                if(sessionUser) { this.currentUser = JSON.parse(sessionUser); this.postLoginSetup(); }
                setTimeout(() => lucide.createIcons(), 500);
            }

            // --- UTILITARIOS ---
            normalizeStr(str) { return str ? str.toString().trim().toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ' ') : ""; }
            safeToggle(id, cls, action) { const el = document.getElementById(id); if(el) { if(action==='add') el.classList.add(cls); else if(action==='remove') el.classList.remove(cls); else el.classList.toggle(cls); } }
            notify(t, m) { const x = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; x.classList.remove('translate-x-full'); setTimeout(() => x.classList.add('translate-x-full'), 3000); }

            // --- CORE ---
            carregarDadosLocais() {
                const salvo = localStorage.getItem('pratique_global_db_v5');
                if (salvo) { try { this.db = JSON.parse(salvo); this.sanitizeDB(); } catch(e) { this.seedInicial(); } } else { this.seedInicial(); }
            }

            sanitizeDB() {
                if(!this.db.acessos) this.db.acessos = [];
                (this.db.unidades||[]).forEach(u => u.senha = String(u.senha || '1234'));
                (this.db.mentores||[]).forEach(m => m.senha = String(m.senha || '1234'));
            }

            seedInicial() { 
                this.db = { mentores: [{id:1,nome:"FELIPE SOUZA", senha:"1234"}], modalidades: [{id:1,nome:"JUMP",cor:"#ff5722"}], unidades: [{id:101,nome:"PRATIQUE SAVASSI",mentorId:1,estado:"MG",pais:"Brasil", senha:"1234"}], horarios: [], historico: [], feriados: [], acessos: [] };
                this.salvarDados(); 
            }
            
            salvarDados() { localStorage.setItem('pratique_global_db_v5', JSON.stringify(this.db)); this.sincronizarNuvem('upload'); }

            async sincronizarNuvem(acao) {
                try {
                    const dot = document.getElementById('status-dot'); const txt = document.getElementById('status-text');
                    if(dot) dot.className = 'status-dot status-sync'; if(txt) txt.innerText = 'Sync...';
                    if (acao === 'download') {
                        const r = await fetch(this.apiUrl);
                        if(r.ok) { const d = await r.json(); if(d && d.unidades) { this.db = d; this.sanitizeDB(); this.salvarDados(); this.atualizarListas(); } }
                    } else {
                        await fetch(this.apiUrl, { method: 'POST', body: JSON.stringify(this.db) });
                    }
                    if(dot) dot.className = 'status-dot status-online'; if(txt) txt.innerText = 'Online';
                } catch(e) { const dot = document.getElementById('status-dot'); if(dot) dot.className = 'status-dot status-offline'; const txt = document.getElementById('status-text'); if(txt) txt.innerText = 'Offline'; }
            }

            forcarSincronizacao() { this.sincronizarNuvem('download'); }
            
            registrarLog(acao, detalhe, ant, nov) {
                if(!this.db.historico) this.db.historico = [];
                this.db.historico.unshift({ id: Date.now(), data: new Date().toLocaleString(), usuario: this.currentUser?.name||'Sys', acao, detalhe, anterior: ant, novo: nov });
                if(this.db.historico.length > 1000) this.db.historico.length = 1000;
                this.salvarDados();
            }

            // --- UI SETUP ---
            setupUI() {
                const elData = document.getElementById('data-atual'); if(elData) elData.innerText = new Date().toLocaleDateString('pt-BR');
                const selMes = document.getElementById('rel-mes');
                if(selMes) selMes.innerHTML = this.constantes.meses.map((m, i) => `<option value="${i}" ${i === new Date().getMonth() ? 'selected' : ''}>${m}</option>`).join('');
                const divDias = document.getElementById('check-dias');
                if(divDias) divDias.innerHTML = this.constantes.dias.map(d => `<label class="cursor-pointer select-none"><input type="checkbox" value="${d}" class="peer sr-only check-dia-input"><div class="px-2 py-1 text-[10px] uppercase border rounded bg-white text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition">${d.substring(0,3)}</div></label>`).join('');
                const divDiasModal = document.getElementById('modal-dias-container');
                if(divDiasModal) divDiasModal.innerHTML = this.constantes.dias.map(d => `<label class="cursor-pointer select-none"><input type="checkbox" value="${d}" class="peer sr-only modal-check-dia"><div class="px-2 py-1 text-[10px] uppercase border rounded bg-white text-gray-400 peer-checked:bg-blue-600 peer-checked:text-white transition">${d.substring(0,3)}</div></label>`).join('');
                this.atualizarEstados();
            }
            
            atualizarEstados() {
                const p = document.getElementById('cad-unidade-pais'); const s = document.getElementById('cad-unidade-estado');
                if(p && s) {
                    const list = this.constantes.paisesEstados[p.value] || [];
                    s.innerHTML = list.map(e => `<option value="${e}">${e}</option>`).join('');
                }
            }

            // --- LOGIN ---
            login() {
                const uRaw = document.getElementById('login-user').value;
                const pass = document.getElementById('login-pass').value.trim();
                const uClean = this.normalizeStr(uRaw);
                
                if (uClean === 'ADMIN' && pass === 'admin123') return this.completeLogin({ id: 'admin', name: 'ADMINISTRADOR', role: 'admin' });

                const mentor = this.db.mentores.find(m => this.normalizeStr(m.nome) === uClean);
                if (mentor && String(mentor.senha) === pass) return this.completeLogin({ id: mentor.id, name: mentor.nome, role: 'mentor' });

                const unit = this.db.unidades.find(x => this.normalizeStr(x.nome) === uClean);
                if (unit && String(unit.senha) === pass) return this.completeLogin({ id: unit.id, name: unit.nome, role: 'unidade' });

                document.getElementById('login-error').classList.remove('hidden');
            }

            completeLogin(user) {
                this.currentUser = user;
                sessionStorage.setItem('pratique_user', JSON.stringify(user));
                this.safeToggle('login-screen', 'hidden', 'add');
                this.safeToggle('app-container', 'hidden', 'remove');
                this.postLoginSetup();
                this.notify('success', `Bem-vindo ${user.name}`);
            }
            
            logout() { sessionStorage.removeItem('pratique_user'); window.location.reload(); }

            postLoginSetup() {
                document.getElementById('user-name').innerText = this.currentUser.name;
                document.getElementById('user-role').innerText = this.currentUser.role.toUpperCase();
                document.getElementById('user-avatar').innerText = this.currentUser.name.charAt(0);

                // Permissoes
                this.safeToggle('nav-importacao', 'disabled', 'remove');
                this.safeToggle('nav-config', 'disabled', 'remove');
                this.safeToggle('admin-filters-container', 'hidden', 'remove');
                this.safeToggle('nav-historico', 'hidden', 'add');
                document.querySelectorAll('.admin-only-block').forEach(el => el.classList.remove('hidden'));

                if(this.currentUser.role === 'admin') {
                    this.safeToggle('nav-historico', 'hidden', 'remove');
                    this.safeToggle('nav-acesso', 'hidden', 'remove');
                    this.renderHistorico();
                } 
                
                if (this.currentUser.role === 'mentor') {
                    this.safeToggle('nav-importacao', 'disabled', 'add');
                    this.safeToggle('admin-filters-container', 'hidden', 'add');
                    this.safeToggle('nav-acesso', 'hidden', 'remove');
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden'));
                }

                if (this.currentUser.role === 'unidade') {
                    this.safeToggle('nav-config', 'disabled', 'add');
                    this.safeToggle('nav-importacao', 'disabled', 'add');
                    this.safeToggle('admin-filters-container', 'hidden', 'add');
                    this.safeToggle('filter-mentor-wrapper', 'hidden', 'add');
                    this.safeToggle('filter-unidade-wrapper', 'hidden', 'add');
                    this.safeToggle('nav-acesso', 'hidden', 'add');
                    document.querySelectorAll('.admin-only-block').forEach(el => el.classList.add('hidden'));
                }

                this.atualizarListas();
                this.nav('relatorio');
            }

            nav(view) {
                if(view === 'historico' && this.currentUser.role !== 'admin') return alert('Acesso Negado');
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                document.getElementById(`nav-${view}`).classList.add('active');
                
                if(view === 'relatorio') this.gerarRelatorio();
                if(view === 'acesso') {
                    // Inicializa filtro de data
                    const selMes = document.getElementById('acesso-mes');
                    if(selMes && !selMes.value) {
                         selMes.innerHTML = this.constantes.meses.map((m, i) => `<option value="${i}">${m}</option>`).join('');
                         selMes.value = new Date().getMonth();
                    }
                    this.renderAcessoMensal();
                }
                
                if(this.mobileMenuOpen) this.toggleMenu();
                lucide.createIcons();
            }

            toggleMenu() {
                this.mobileMenuOpen = !this.mobileMenuOpen;
                const sb = document.getElementById('sidebar');
                const ov = document.getElementById('mobile-menu-overlay');
                if(this.mobileMenuOpen) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); }
                else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
            }

            // --- LOGICA DE NEGOCIO ---

            atualizarListas() {
                const pop = (id, list) => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = '<option value="">SELECIONE...</option>' + list.map(i => `<option value="${i.id}">${i.nome}</option>`).join('');
                };

                let units = this.db.unidades;
                if(this.currentUser.role === 'mentor') units = units.filter(u => u.mentorId == this.currentUser.id);
                if(this.currentUser.role === 'unidade') units = units.filter(u => u.id == this.currentUser.id);
                units.sort((a,b) => a.nome.localeCompare(b.nome));

                pop('cronograma-unidade-select', units);
                pop('rel-unidade', units);
                pop('rel-mentor', this.db.mentores);
                pop('rel-modalidade', this.db.modalidades);
                pop('cad-unidade-mentor', this.db.mentores);
                pop('grade-unidade', units);
                pop('grade-modalidade', this.db.modalidades);
                pop('modal-modalidade', this.db.modalidades);

                const ulMentores = document.getElementById('lista-mentores');
                if(ulMentores) ulMentores.innerHTML = this.db.mentores.map(m => `<li>${m.nome} (Senha: ${m.senha}) <button class="text-red-500 ml-2" onclick="window.app.remover('mentores', ${m.id})">x</button></li>`).join('');

                const ulUnidades = document.getElementById('lista-unidades');
                if(ulUnidades) ulUnidades.innerHTML = units.map(u => `<li>${u.nome} <span class="text-gray-400 text-[10px]">(${u.senha})</span> <button class="text-red-500 ml-2" onclick="window.app.remover('unidades', ${u.id})">x</button></li>`).join('');

                const ulModalidades = document.getElementById('lista-modalidades');
                if(ulModalidades) ulModalidades.innerHTML = this.db.modalidades.map(m => `<li style="border-left: 3px solid ${m.cor}" class="pl-2">${m.nome} <button class="text-red-500 ml-2" onclick="window.app.remover('modalidades', ${m.id})">x</button></li>`).join('');
                
                this.renderAcessos('mentores');
                this.renderAcessos('unidades');

                this.renderGradesRecentes();
            }

            renderAcessos(tipo, termo) {
                 // Filtro visual apenas
                 let lista = tipo === 'mentores' ? this.db.mentores : this.db.unidades;
                 if(termo) lista = lista.filter(i => i.nome.includes(termo.toUpperCase()));
                 const el = document.getElementById(`lista-senhas-${tipo}`);
                 if(el) el.innerHTML = lista.map(i => `<div class="flex justify-between border-b p-1 text-xs"><span>${i.nome}</span> <div class="flex gap-2 items-center"><input class="w-16 border rounded text-center" value="${i.senha}" id="pass-${i.id}"><button onclick="window.app.savePassword('${tipo}', '${i.id}')">💾</button></div></div>`).join('');
            }

            // --- CRUD ---

            addMentor() {
                const nome = document.getElementById('cad-mentor-nome').value.toUpperCase();
                const senha = document.getElementById('cad-mentor-senha').value;
                if(nome) {
                    this.db.mentores.push({id: Date.now(), nome, senha: String(senha)});
                    this.salvarDados(); this.atualizarListas();
                    document.getElementById('cad-mentor-nome').value = '';
                }
            }

            addUnidade() {
                const nome = document.getElementById('cad-unidade-nome').value.toUpperCase();
                const mentor = document.getElementById('cad-unidade-mentor').value;
                const senha = document.getElementById('cad-unidade-senha').value;
                if(nome && mentor) {
                    this.db.unidades.push({id: Date.now(), nome, mentorId: mentor, senha: String(senha), pais: document.getElementById('cad-unidade-pais').value, estado: document.getElementById('cad-unidade-estado').value });
                    this.salvarDados(); this.atualizarListas();
                    document.getElementById('cad-unidade-nome').value = '';
                }
            }

            addModalidade() {
                const nome = document.getElementById('cad-mod-nome').value.toUpperCase();
                const cor = document.getElementById('cad-mod-cor').value;
                if(nome) {
                    this.db.modalidades.push({id: Date.now(), nome, cor});
                    this.salvarDados(); this.atualizarListas();
                    document.getElementById('cad-mod-nome').value = '';
                }
            }

            addHorario() {
                 const u = document.getElementById('grade-unidade').value;
                 const m = document.getElementById('grade-modalidade').value;
                 const p = document.getElementById('grade-prof').value.toUpperCase();
                 const h = document.getElementById('grade-hora').value;
                 const v = parseFloat(document.getElementById('grade-valor').value)||0;
                 const al = parseInt(document.getElementById('grade-alunos').value)||0;
                 const dias = Array.from(document.querySelectorAll('.check-dia-input:checked')).map(c => c.value);

                 if(u && m && p && h && dias.length) {
                     const novo = { id: this.editingId || Date.now(), unidadeId: u, modalidadeId: m, professor: p, hora: h, valor: v, mediaAlunos: al, dias };
                     if(this.editingId) {
                         const idx = this.db.horarios.findIndex(x => x.id == this.editingId);
                         if(idx > -1) this.db.horarios[idx] = novo;
                     } else {
                         this.db.horarios.push(novo);
                     }
                     this.salvarDados(); this.renderGradesRecentes(); this.cancelarEdicao();
                 } else alert('Preencha tudo');
            }

            remover(tipo, id) {
                if(confirm('Tem certeza?')) {
                    this.db[tipo] = this.db[tipo].filter(i => i.id != id);
                    if(tipo === 'unidades') this.db.horarios = this.db.horarios.filter(h => h.unidadeId != id);
                    this.salvarDados(); this.atualizarListas(); this.renderCronograma();
                }
            }
            
            cancelarEdicao() { this.editingId=null; document.getElementById('grade-prof').value=''; document.querySelectorAll('.check-dia-input').forEach(c=>c.checked=false); document.getElementById('btn-save-grade').innerText='ADICIONAR'; document.getElementById('btn-cancel-grade').classList.add('hidden'); }
            
            editarHorario(id) {
                if(!document.getElementById('view-cronograma').classList.contains('hidden')) return this.abrirModalEdicao(id);
                const h = this.db.horarios.find(x=>x.id==id); if(!h) return;
                this.nav('config'); document.getElementById('grade-unidade').value=h.unidadeId; document.getElementById('grade-modalidade').value=h.modalidadeId; document.getElementById('grade-prof').value=h.professor;
                document.getElementById('grade-valor').value=h.valor; document.getElementById('grade-alunos').value=h.mediaAlunos; document.getElementById('grade-hora').value=h.hora;
                document.querySelectorAll('.check-dia-input').forEach(c=>c.checked=h.dias.includes(c.value));
                this.editingId=id; document.getElementById('btn-save-grade').innerText='SALVAR'; document.getElementById('btn-cancel-grade').classList.remove('hidden');
            }
            
            abrirModalAdicao() { this.abrirModalEdicao(null); }

            abrirModalEdicao(id) {
                const uid = document.getElementById('cronograma-unidade-select').value;
                if(!uid && !id) return alert('Selecione unidade');

                const modal = document.getElementById('modal-editor');
                const titulo = document.getElementById('modal-titulo');
                const btnExcluir = document.getElementById('btn-excluir-modal');

                // Reset
                ['modal-prof', 'modal-hora', 'modal-valor', 'modal-alunos'].forEach(i => document.getElementById(i).value = '');
                document.querySelectorAll('.modal-check-dia').forEach(c => c.checked = false);

                if (id) {
                    const aula = this.db.horarios.find(h => h.id == id);
                    if(!aula) return;
                    document.getElementById('modal-id').value = id;
                    document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == aula.unidadeId)?.nome;
                    document.getElementById('modal-modalidade').value = aula.modalidadeId;
                    document.getElementById('modal-prof').value = aula.professor;
                    document.getElementById('modal-hora').value = aula.hora;
                    document.getElementById('modal-valor').value = aula.valor;
                    document.getElementById('modal-alunos').value = aula.mediaAlunos;
                    aula.dias.forEach(d => {
                        const ck = Array.from(document.querySelectorAll('.modal-check-dia')).find(c => c.value === d);
                        if(ck) ck.checked = true;
                    });
                    titulo.innerText = 'EDITAR AULA';
                    btnExcluir.classList.remove('hidden');
                } else {
                    document.getElementById('modal-id').value = '';
                    document.getElementById('modal-unidade-view').value = this.db.unidades.find(u => u.id == uid)?.nome;
                    titulo.innerText = 'NOVA AULA';
                    btnExcluir.classList.add('hidden');
                }
                modal.classList.remove('hidden');
            }

            salvarModal() {
                const id = document.getElementById('modal-id').value;
                const uid = document.getElementById('cronograma-unidade-select').value;
                const aulaUid = id ? this.db.horarios.find(h => h.id == id).unidadeId : uid;

                const novo = {
                    id: id || Date.now(),
                    unidadeId: aulaUid,
                    modalidadeId: document.getElementById('modal-modalidade').value,
                    professor: document.getElementById('modal-prof').value.toUpperCase(),
                    hora: document.getElementById('modal-hora').value,
                    valor: parseFloat(document.getElementById('modal-valor').value) || 0,
                    mediaAlunos: parseInt(document.getElementById('modal-alunos').value) || 0,
                    dias: Array.from(document.querySelectorAll('.modal-check-dia:checked')).map(c => c.value)
                };

                if(!novo.modalidadeId || !novo.professor || !novo.hora || !novo.dias.length) return alert('Preencha tudo');

                if (id) {
                    const idx = this.db.horarios.findIndex(h => h.id == id);
                    this.db.horarios[idx] = novo;
                } else {
                    this.db.horarios.push(novo);
                }
                this.salvarDados();
                this.renderCronograma();
                this.fecharModal();
            }
            
            excluirViaModal() {
                 const id = document.getElementById('modal-id').value;
                 this.remover('horarios', id);
                 this.fecharModal();
            }

            fecharModal() { document.getElementById('modal-editor').classList.add('hidden'); }

            // --- RELATORIO ---

            gerarRelatorio() {
                const mes = parseInt(document.getElementById('rel-mes').value);
                const ano = parseInt(document.getElementById('rel-ano').value);
                const fUni = document.getElementById('rel-unidade').value;
                const fMent = document.getElementById('rel-mentor').value;
                const fMod = document.getElementById('rel-modalidade').value;

                // Feriados logica simplificada para estabilidade
                let feriados = this.constantes.feriadosFixos.filter(f => f.m === mes);
                
                let lista = this.db.horarios.filter(h => {
                    const u = this.db.unidades.find(unit => unit.id == h.unidadeId);
                    if(!u) return false;
                    
                    if(this.currentUser.role === 'mentor' && u.mentorId != this.currentUser.id) return false;
                    if(this.currentUser.role === 'unidade' && u.id != this.currentUser.id) return false;
                    
                    if(fUni && u.id != fUni) return false;
                    if(fMent && u.mentorId != fMent) return false;
                    if(fMod && h.modalidadeId != fMod) return false;
                    return true;
                });

                // Calculos KPI
                const diasNoMes = new Date(ano, mes + 1, 0).getDate();
                let totalReceita = 0;
                let totalAulas = 0;
                let totalCanceladas = 0;

                lista.forEach(h => {
                    let aulasCount = 0;
                    for(let d=1; d<=diasNoMes; d++) {
                        const date = new Date(ano, mes, d);
                        const diaSemana = this.constantes.dias[date.getDay() === 0 ? 6 : date.getDay() - 1];
                        if(h.dias.includes(diaSemana)) {
                            // Check feriado fixo simples
                            if(feriados.find(f => f.d === d)) totalCanceladas++;
                            else aulasCount++;
                        }
                    }
                    totalAulas += aulasCount;
                    totalReceita += (aulasCount * h.valor);
                });

                document.getElementById('kpi-receita').innerText = `R$ ${totalReceita.toFixed(2)}`;
                document.getElementById('kpi-aulas').innerText = totalAulas;
                document.getElementById('kpi-canceladas').innerText = totalCanceladas;
                document.getElementById('kpi-unidades-count').innerText = [...new Set(lista.map(h => h.unidadeId))].length;
                document.getElementById('relatorio-empty').classList.add('hidden');
                
                // Tabela Simplificada
                const tbody = document.getElementById('body-relatorio');
                tbody.innerHTML = lista.map(h => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     const m = this.db.modalidades.find(x => x.id == h.modalidadeId);
                     return `<tr class="border-b"><td class="font-bold text-xs">${u?.nome}</td><td class="text-xs text-blue-600">${m?.nome}</td><td class="text-xs">${h.professor}</td><td class="text-xs font-mono text-center">R$ ${h.valor}</td><td class="text-xs text-center">${h.mediaAlunos}</td></tr>`;
                }).join('');

                // Ranking
                const rankBody = document.querySelector('#tabela-ranking-alunos tbody');
                rankBody.innerHTML = lista.slice(0, 15).map((h, i) => {
                     const u = this.db.unidades.find(x => x.id == h.unidadeId);
                     return `<tr class="border-b"><td class="font-bold text-blue-600">${i+1}</td><td>${u?.nome} - ${h.professor}</td><td class="text-right font-bold">${h.mediaAlunos}</td></tr>`;
                }).join('');
            }
            
            atualizarFiltrosRelatorio(tipo) {} // Placeholder para evitar erro se chamado
            setAgrupamento(tipo) {} // Placeholder
            exportarExcel() { alert('Função simplificada nesta versão estável.'); }

            // --- ADMIN ---
            renderHistorico() {
                const t = document.getElementById('lista-historico');
                if(t) t.innerHTML = (this.db.historico || []).slice(0, 50).map(h => `<tr class="border-b"><td class="p-2">${h.data}</td><td class="p-2 font-bold">${h.usuario}</td><td class="p-2">${h.acao}</td><td class="p-2 text-gray-500 truncate max-w-xs">${h.detalhe}</td></tr>`).join('');
            }

            renderSenhas(tipo, lista) {
                // Implementação simples
            }
            
            setupDraggableModal() {
                 // Implementação simples
            }
            
            atualizarEstados() {}

            // --- RANKING & VALIDAÇÃO ---
            
            confirmarValidacao(tipo) {
                const uid = document.getElementById('cronograma-unidade-select').value;
                if(!uid) return;
                const mes = new Date().getMonth();
                const ano = new Date().getFullYear();
                
                // Remove anterior
                this.db.acessos = (this.db.acessos || []).filter(a => !(a.unidadeId == uid && a.mes == mes && a.ano == ano));
                
                this.db.acessos.push({
                    unidadeId: uid,
                    mes: mes,
                    ano: ano,
                    tipo: tipo,
                    validadoPor: this.currentUser.name,
                    data: new Date().toISOString()
                });
                
                this.salvarDados();
                this.renderCronograma();
            }
            
            ordenarStatus(campo) {
                if (this.ordenacaoStatus.campo === campo) {
                    this.ordenacaoStatus.direcao = this.ordenacaoStatus.direcao === 'asc' ? 'desc' : 'asc';
                } else {
                    this.ordenacaoStatus.campo = campo;
                    this.ordenacaoStatus.direcao = 'asc';
                }
                this.renderAcessoMensal();
            }

            renderAcessoMensal() {
                const mes = parseInt(document.getElementById('acesso-mes').value);
                const ano = parseInt(document.getElementById('acesso-ano').value);
                const container = document.getElementById('ranking-mentores-container');
                container.innerHTML = '';

                // Filtrar Mentores e Unidades
                let mentores = this.db.mentores;
                let unidades = this.db.unidades;
                
                if (this.currentUser.role === 'mentor') {
                    mentores = mentores.filter(m => m.id == this.currentUser.id);
                    unidades = unidades.filter(u => u.mentorId == this.currentUser.id);
                }

                // Calcular Ranking
                const ranking = mentores.map(m => {
                    const minhasUnidades = unidades.filter(u => u.mentorId == m.id);
                    const total = minhasUnidades.length;
                    
                    const validadas = minhasUnidades.filter(u => 
                        (this.db.acessos || []).some(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano)
                    ).length;

                    const pct = total > 0 ? Math.round((validadas / total) * 100) : 0;
                    
                    return { nome: m.nome, pct, total, validadas };
                }).sort((a,b) => b.pct - a.pct); // Ordenar maior % primeiro

                // Renderizar
                ranking.forEach((r, idx) => {
                    const medalha = idx === 0 ? '🥇' : (idx === 1 ? '🥈' : (idx === 2 ? '🥉' : `${idx+1}º`));
                    const color = r.pct === 100 ? 'bg-green-500' : (r.pct > 50 ? 'bg-blue-500' : 'bg-yellow-500');
                    
                    const row = `
                        <div class="flex items-center gap-4 p-3 bg-white/5 rounded border border-white/10 mb-2">
                            <div class="font-bold text-xl w-8 text-center text-yellow-400">${medalha}</div>
                            <div class="flex-1">
                                <div class="flex justify-between mb-1">
                                    <span class="font-bold uppercase text-sm text-white">${r.nome}</span>
                                    <span class="text-xs text-blue-200 font-mono">${r.validadas} / ${r.total} Unidades</span>
                                </div>
                                <div class="w-full bg-white/10 rounded-full h-2.5">
                                    <div class="${color} h-2.5 rounded-full transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style="width: ${r.pct}%"></div>
                                </div>
                            </div>
                            <div class="font-bold text-lg text-white w-12 text-right">${r.pct}%</div>
                        </div>
                    `;
                    container.innerHTML += row;
                });

                // Renderizar Cards Individuais
                const grid = document.getElementById('grid-mentores-acesso');
                grid.innerHTML = '';
                
                ranking.forEach(r => {
                    const corBarra = r.pct === 100 ? 'bg-green-500' : (r.pct > 50 ? 'bg-blue-500' : 'bg-red-500');
                    grid.innerHTML += `
                        <div class="glass-panel p-4 border border-gray-100 hover:shadow-md transition">
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-bold text-gray-700 uppercase text-sm truncate">${r.nome}</h4>
                                <span class="text-xs font-bold px-2 py-1 rounded bg-gray-100 text-gray-600">${r.pct}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                                <div class="${corBarra} h-2 rounded-full" style="width: ${r.pct}%"></div>
                            </div>
                            <div class="flex justify-between text-xs font-bold text-gray-500">
                                <span>Validado: ${r.validadas}</span>
                                <span>Pendente: ${r.total - r.validadas}</span>
                            </div>
                        </div>
                    `;
                });

                // Renderizar Tabela Detalhada
                const tbody = document.getElementById('tabela-status-unidades');
                
                // Ordenação dinâmica da tabela
                let listaUnidades = unidades.map(u => {
                    const mentor = this.db.mentores.find(m => m.id == u.mentorId);
                    const isValid = (this.db.acessos || []).some(a => a.unidadeId == u.id && a.mes == mes && a.ano == ano);
                    return {
                        nome: u.nome,
                        mentor: mentor ? mentor.nome : '-',
                        isValid
                    };
                });

                const { campo, direcao } = this.ordenacaoStatus;
                listaUnidades.sort((a,b) => {
                    let valA, valB;
                    if(campo === 'unidade') { valA = a.nome; valB = b.nome; }
                    if(campo === 'mentor') { valA = a.mentor; valB = b.mentor; }
                    if(campo === 'status') { valA = a.isValid ? 1 : 0; valB = b.isValid ? 1 : 0; }
                    
                    if (typeof valA === 'string') { valA = valA.toLowerCase(); valB = valB.toLowerCase(); }
                    return (valA < valB ? -1 : 1) * (direcao === 'asc' ? 1 : -1);
                });

                tbody.innerHTML = listaUnidades.map(u => `
                    <tr class="border-b hover:bg-gray-50 transition">
                        <td class="p-3 font-bold text-gray-700">${u.nome}</td>
                        <td class="p-3 text-gray-500 text-xs uppercase">${u.mentor}</td>
                        <td class="p-3 text-center">
                            <span class="px-2 py-1 rounded text-[10px] font-bold ${u.isValid ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                ${u.isValid ? 'VALIDADO' : 'PENDENTE'}
                            </span>
                        </td>
                    </tr>
                `).join('');

                // Totais Rodapé
                const validTotal = listaUnidades.filter(u => u.isValid).length;
                
                const elTotal = document.getElementById('acesso-total');
                const elOk = document.getElementById('acesso-ok');
                const elPendente = document.getElementById('acesso-pendente');
                const elFooterVal = document.getElementById('footer-total-validadas');
                const elFooterPend = document.getElementById('footer-total-pendentes');

                if(elTotal) elTotal.innerText = listaUnidades.length;
                if(elOk) elOk.innerText = validTotal;
                if(elPendente) elPendente.innerText = listaUnidades.length - validTotal;
                if(elFooterVal) elFooterVal.innerText = `Validadas: ${validTotal}`;
                if(elFooterPend) elFooterPend.innerText = `Pendentes: ${listaUnidades.length - validTotal}`;
            }

            // --- MÉTODOS DE RENDERIZAÇÃO FINAIS ---
            
            renderGradesRecentes() { 
                const lista = document.getElementById('lista-grades-recentes');
                if (!lista) return;
                let grades = this.db.horarios;
                if(this.currentUser && this.currentUser.role === 'mentor') grades = grades.filter(g => { const u = this.db.unidades.find(un => un.id == g.unidadeId); return u && u.mentorId == this.currentUser.id; });
                else if(this.currentUser && this.currentUser.role === 'unidade') grades = grades.filter(g => g.unidadeId == this.currentUser.id);
                
                lista.innerHTML = grades.slice(-5).reverse().map(h => {
                    const u = this.db.unidades.find(x=>x.id==h.unidadeId || parseInt(x.id) === parseInt(h.unidadeId))?.nome || '?';
                    return `<div class="flex justify-between items-center border-b p-1 text-xs mb-1 bg-white uppercase"><span><b>${u}</b><br>${h.professor} - ${h.hora}</span> <div class="flex gap-1"><button onclick="window.app.editarHorario('${h.id}')" class="text-blue-500 p-1">✏️</button><button onclick="window.app.remove('horarios','${h.id}')" class="text-red-500 p-1">🗑️</button></div></div>`
                }).join(''); 
            }

            renderCronograma() {
                const uid = document.getElementById('cronograma-unidade-select').value; 
                const c = document.getElementById('cronograma-container');
                const validacaoContainer = document.getElementById('cronograma-validacao-container');
                
                if(!uid) {
                    c.innerHTML='<div class="py-10 text-center text-gray-400 uppercase">SELECIONE UMA UNIDADE</div>';
                    validacaoContainer.innerHTML = '';
                    return;
                }

                // --- NOVA ÁREA DE VALIDAÇÃO MENSAL (LÓGICA INJETADA) ---
                // Verifica unidade atual selecionada (Objeto Unidade)
                const unidadeSelecionada = this.db.unidades.find(u => u.id == uid);

                // Permissão: Admin, Unidade (se for a própria), ou Mentor (se for responsável)
                const podeValidar = 
                    (this.currentUser.role === 'admin') ||
                    (this.currentUser.role === 'unidade' && this.currentUser.id == uid) || 
                    (this.currentUser.role === 'mentor' && unidadeSelecionada && unidadeSelecionada.mentorId == this.currentUser.id);

                if(podeValidar) {
                    const hoje = new Date();
                    const mes = hoje.getMonth();
                    const ano = hoje.getFullYear();
                    const nomeMes = this.constantes.meses[mes];

                    // Verifica se já validou no banco de acessos
                    const validacao = (this.db.acessos || []).find(a => a.unidadeId == uid && a.mes == mes && a.ano == ano);

                    if(validacao) {
                        // JÁ VALIDADO (VERDE)
                        const tipoTexto = validacao.tipo === 'com_alteracao' ? 'COM ALTERAÇÕES' : 'SEM ALTERAÇÕES';
                        validacaoContainer.innerHTML = `
                            <div class="validation-box validated flex justify-between items-center">
                                <div>
                                    <h4 class="font-bold text-green-800 flex items-center gap-2 uppercase">
                                        <i data-lucide="check-circle" class="w-5 h-5"></i> Mês de ${nomeMes} Validado
                                    </h4>
                                    <p class="text-xs text-green-700 mt-1">Status: <strong>${tipoTexto}</strong> • Confirmado em ${new Date(validacao.data).toLocaleDateString()}</p>
                                </div>
                                <button class="text-green-800 opacity-50 cursor-not-allowed font-bold text-xs uppercase border border-green-200 px-3 py-2 rounded bg-white">Concluído</button>
                            </div>
                        `;
                    } else {
                        // PENDENTE (AMARELO/AZUL)
                        validacaoContainer.innerHTML = `
                            <div class="validation-box bg-blue-50 border-blue-200">
                                <h4 class="font-bold text-blue-800 flex items-center gap-2 uppercase mb-2">
                                    <i data-lucide="alert-circle" class="w-5 h-5"></i> Validação Mensal Obrigatória (${nomeMes})
                                </h4>
                                <p class="text-xs text-blue-600 mb-4">Por favor, confirme a revisão do quadro de aulas deste mês.</p>
                                
                                <div class="flex flex-col md:flex-row gap-3 mb-4">
                                    <button onclick="window.app.confirmarValidacao('com_alteracao')" class="flex-1 bg-white border-2 border-orange-200 hover:bg-orange-50 text-orange-700 font-bold py-3 rounded text-xs transition uppercase shadow-sm flex items-center justify-center gap-2">
                                        <i data-lucide="edit-3" class="w-4 h-4"></i> Houve alteração no cronograma
                                    </button>
                                    <button onclick="window.app.confirmarValidacao('sem_alteracao')" class="flex-1 bg-white border-2 border-green-200 hover:bg-green-50 text-green-700 font-bold py-3 rounded text-xs transition uppercase shadow-sm flex items-center justify-center gap-2">
                                        <i data-lucide="check" class="w-4 h-4"></i> Não houve alteração
                                    </button>
                                </div>
                                <label class="flex items-start gap-2 text-xs text-gray-600 cursor-pointer select-none bg-white p-3 rounded border border-blue-100">
                                    <input type="checkbox" id="check-validacao" class="mt-0.5">
                                    <span>Confirmo que revisei: <strong>Horários das aulas</strong>, <strong>Professores</strong> e a <strong>Estrutura do quadro</strong> de coletivas.</span>
                                </label>
                            </div>
                        `;
                    }
                } else {
                    // Sem permissão para validar essa unidade específica
                    validacaoContainer.innerHTML = '';
                }
                // -----------------------------------------------------

                const h = this.db.horarios.filter(x=>x.unidadeId==uid || parseInt(x.unidadeId) === parseInt(uid)); 
                const times = [...new Set(h.map(x=>x.hora))].sort();
                let ht = `<table class="w-full border-collapse min-w-[800px]"><thead><tr><th class="p-2 border bg-gray-50 text-xs w-20">HORA</th>${this.constantes.dias.map(d=>`<th class="p-2 border bg-gray-50 text-xs uppercase">${d}</th>`).join('')}</tr></thead><tbody>`;
                times.forEach(t => {
                    ht += `<tr><td class="p-2 border text-center font-bold text-xs bg-gray-50">${t}</td>`;
                    this.constantes.dias.forEach(d => {
                        const a = h.find(x=>x.hora===t && x.dias.includes(d));
                        if(a) {
                            const mod = this.db.modalidades.find(m=>m.id==a.modalidadeId || parseInt(m.id) === parseInt(a.modalidadeId));
                            // GARANTIDO: ASPAS NO ID PARA SUPORTAR STRINGS E NÚMEROS E CLIQUE NO PAI E IDS COM ASPAS
                            ht += `<td class="p-1 border h-20 w-[13%] align-top">
                                <div onclick="window.app.abrirModalEdicao('${a.id}')" class="aula-card p-2 rounded text-xs text-white shadow relative cursor-pointer group flex flex-col justify-between h-full uppercase select-none pointer-events-auto" style="background:${mod?.cor||'#999'}">
                                    <div>
                                        <div class="font-bold uppercase mb-1 leading-tight">${mod?.nome}</div>
                                        <div class="opacity-90 truncate">${a.professor}</div>
                                    </div>
                                    <div class="flex justify-between items-end mt-1 border-t border-white/20 pt-1">
                                        <span class="text-[9px]">👥 ${a.mediaAlunos}</span>
                                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition pointer-events-auto">
                                            <button onclick="event.stopPropagation(); window.app.remove('horarios', '${a.id}')" class="hover:text-red-200 p-1" title="Excluir"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                            <i data-lucide="edit" class="w-3 h-3"></i>
                                        </div>
                                    </div>
                                </div>
                            </td>`;
                        } else ht += `<td class="border bg-slate-50/20"></td>`;
                    });
                    ht += `</tr>`;
                });
                c.innerHTML = ht + `</tbody></table>`; lucide.createIcons();
            }
        }

        window.app = new SistemaPratique();
    </script>
</body>
</html>
